<div class='toc'>
	<ol class='level-1'>
		<li><a href='#Inhalt'>Inhalt</a></li>
		<li><a href='#Routen'>Routen</a></li>
		<ol class='level-2'>
			<li><a href='#Bedingungen'>Bedingungen</a></li>
			<li><a href='#R%C3%BCckgabewerte'>Rückgabewerte</a></li>
			<li><a href='#Eigene%20Routen-Muster'>Eigene Routen-Muster</a></li>
		</ol>
		<li><a href='#Views/Templates'>Views/Templates</a></li>
		<ol class='level-2'>
			<li><a href='#Direkte%20Templates'>Direkte Templates</a></li>
			<li><a href='#Verf%C3%BCgbare%20Templatesprachen'>Verfügbare Templatesprachen</a></li>
			<ol class='level-3'>
				<li><a href='#Haml%20Templates'>Haml Templates</a></li>
				<li><a href='#Erb%20Templates'>Erb Templates</a></li>
				<li><a href='#Builder%20Templates'>Builder Templates</a></li>
				<li><a href='#Nokogiri%20Templates'>Nokogiri Templates</a></li>
				<li><a href='#Sass%20Templates'>Sass Templates</a></li>
				<li><a href='#SCSS%20Templates'>SCSS Templates</a></li>
				<li><a href='#Less%20Templates'>Less Templates</a></li>
				<li><a href='#Liquid%20Templates'>Liquid Templates</a></li>
				<li><a href='#Markdown%20Templates'>Markdown Templates</a></li>
				<li><a href='#Textile%20Templates'>Textile Templates</a></li>
				<li><a href='#RDoc%20Templates'>RDoc Templates</a></li>
				<li><a href='#Radius%20Templates'>Radius Templates</a></li>
				<li><a href='#Markaby%20Templates'>Markaby Templates</a></li>
				<li><a href='#RABL%20Templates'>RABL Templates</a></li>
				<li><a href='#Slim%20Templates'>Slim Templates</a></li>
				<li><a href='#Creole%20Templates'>Creole Templates</a></li>
				<li><a href='#CoffeeScript%20Templates'>CoffeeScript Templates</a></li>
				<li><a href='#Stylus%20Templates'>Stylus Templates</a></li>
				<li><a href='#Yajl%20Templates'>Yajl Templates</a></li>
				<li><a href='#WLang%20Templates'>WLang Templates</a></li>
			</ol>
			<li><a href='#Auf%20Variablen%20in%20Templates%20zugreifen'>Auf Variablen in Templates zugreifen</a></li>
			<li><a href='#Templates%20mit%20%3Ccode%3Eyield%3C/code%3E%20und%20verschachtelte%20Layouts'>Templates mit <code>yield</code> und verschachtelte Layouts</a></li>
			<li><a href='#Inline-Templates'>Inline-Templates</a></li>
			<li><a href='#Benannte%20Templates'>Benannte Templates</a></li>
			<li><a href='#Dateiendungen%20zuordnen'>Dateiendungen zuordnen</a></li>
			<li><a href='#Eine%20eigene%20Template-Engine%20hinzuf%C3%BCgen'>Eine eigene Template-Engine hinzufügen</a></li>
		</ol>
		<li><a href='#Filter'>Filter</a></li>
		<li><a href='#Helfer'>Helfer</a></li>
		<ol class='level-2'>
			<li><a href='#Sessions%20verwenden'>Sessions verwenden</a></li>
			<li><a href='#Anhalten'>Anhalten</a></li>
			<li><a href='#Weiterspringen'>Weiterspringen</a></li>
			<li><a href='#Eine%20andere%20Route%20ansteuern'>Eine andere Route ansteuern</a></li>
			<li><a href='#Body,%20Status-Code%20und%20Header%20setzen'>Body, Status-Code und Header setzen</a></li>
			<li><a href='#Response-Streams'>Response-Streams</a></li>
			<li><a href='#Logger'>Logger</a></li>
			<li><a href='#Mime-Types'>Mime-Types</a></li>
			<li><a href='#URLs%20generieren'>URLs generieren</a></li>
			<li><a href='#Browser-Umleitung'>Browser-Umleitung</a></li>
			<li><a href='#Cache%20einsetzen'>Cache einsetzen</a></li>
			<li><a href='#Dateien%20versenden'>Dateien versenden</a></li>
			<li><a href='#Das%20Request-Objekt'>Das Request-Objekt</a></li>
			<li><a href='#Anh%C3%A4nge'>Anhänge</a></li>
			<li><a href='#Umgang%20mit%20Datum%20und%20Zeit'>Umgang mit Datum und Zeit</a></li>
			<li><a href='#Nachschlagen%20von%20Template-Dateien'>Nachschlagen von Template-Dateien</a></li>
			<li><a href='#Konfiguration'>Konfiguration</a></li>
			<ol class='level-3'>
				<li><a href='#Einstellung%20des%20Angriffsschutzes'>Einstellung des Angriffsschutzes</a></li>
		</ol></ol>
		<li><a href='#Umgebungen'>Umgebungen</a></li>
		<li><a href='#Fehlerbehandlung'>Fehlerbehandlung</a></li>
		<ol class='level-2'>
			<li><a href='#Nicht%20gefunden'>Nicht gefunden</a></li>
			<li><a href='#Fehler'>Fehler</a></li>
		</ol>
		<li><a href='#Rack-Middleware'>Rack-Middleware</a></li>
		<li><a href='#Testen'>Testen</a></li>
		<li><a href='#Sinatra::Base%20-%20Middleware,%20Bibliotheken%20und%20modulare%20Anwendungen'>Sinatra::Base - Middleware, Bibliotheken und modulare Anwendungen</a></li>
		<ol class='level-2'>
			<li><a href='#Modularer%20vs.%20klassischer%20Stil'>Modularer vs. klassischer Stil</a></li>
			<li><a href='#Eine%20modulare%20Applikation%20bereitstellen'>Eine modulare Applikation bereitstellen</a></li>
			<li><a href='#Eine%20klassische%20Anwendung%20mit%20einer%20config.ru%20verwenden'>Eine klassische Anwendung mit einer config.ru verwenden</a></li>
			<li><a href='#Wann%20sollte%20eine%20config.ru-Datei%20verwendet%20werden?'>Wann sollte eine config.ru-Datei verwendet werden?</a></li>
			<li><a href='#Sinatra%20als%20Middleware%20nutzen'>Sinatra als Middleware nutzen</a></li>
			<li><a href='#Dynamische%20Applikationserstellung'>Dynamische Applikationserstellung</a></li>
		</ol>
		<li><a href='#Geltungsbereich%20und%20Bindung'>Geltungsbereich und Bindung</a></li>
		<ol class='level-2'>
			<li><a href='#Anwendungs-%20oder%20Klassen-Scope'>Anwendungs- oder Klassen-Scope</a></li>
			<li><a href='#Anfrage-%20oder%20Instanz-Scope'>Anfrage- oder Instanz-Scope</a></li>
			<li><a href='#Delegation-Scope'>Delegation-Scope</a></li>
		</ol>
		<li><a href='#Kommandozeile'>Kommandozeile</a></li>
		<li><a href='#Systemanforderungen'>Systemanforderungen</a></li>
		<li><a href='#Der%20neuste%20Stand%20(The%20Bleeding%20Edge)'>Der neuste Stand (The Bleeding Edge)</a></li>
		<ol class='level-2'>
			<li><a href='#Mit%20Bundler'>Mit Bundler</a></li>
			<li><a href='#Eigenes%20Repository'>Eigenes Repository</a></li>
			<li><a href='#Gem%20erstellen'>Gem erstellen</a></li>
		</ol>
		<li><a href='#Versions-Verfahren'>Versions-Verfahren</a></li>
		<li><a href='#Mehr'>Mehr</a></li>
	</ol>
</div>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>

<p><em>Wichtig: Dieses Dokument ist eine Übersetzung aus dem Englischen und unter
Umständen nicht auf dem aktuellen Stand.</em></p>

<p>Sinatra ist eine
<a href="http://de.wikipedia.org/wiki/Dom%C3%A4nenspezifische_Sprache">DSL</a>, die das
schnelle Erstellen von Webanwendungen in Ruby mit minimalem Aufwand
ermöglicht:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># myapp.rb</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>
get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo Welt!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Einfach via <code>rubygems</code> installieren und starten:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>gem install sinatra
ruby myapp.rb
</pre></div>
</div>
</div>

<p>Die Seite kann nun unter http://localhost:4567 betrachtet werden.</p>

<p>Es wird empfohlen, den Thin-Server via <code>gem install thin</code> zu installieren, den
Sinatra dann, soweit vorhanden, automatisch verwendet.</p>

<a name='Inhalt'></a>
<h2>Inhalt</h2>

<a name='Routen'></a>
<h2>Routen</h2>

<p>In Sinatra wird eine Route durch eine HTTP-Methode und ein URL-Muster definiert.
Jeder dieser Routen wird ein Ruby-Block zugeordnet:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. zeige etwas ..
<span style="color:#080;font-weight:bold">end</span>

post <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. erstelle etwas ..
<span style="color:#080;font-weight:bold">end</span>

put <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. update etwas ..
<span style="color:#080;font-weight:bold">end</span>

delete <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. entferne etwas ..
<span style="color:#080;font-weight:bold">end</span>

options <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. zeige, was wir können ..
<span style="color:#080;font-weight:bold">end</span>

link <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. verbinde etwas ..
<span style="color:#080;font-weight:bold">end</span>

unlink <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. trenne etwas ..
<span style="color:#080;font-weight:bold">end</span>

</pre></div>
</div>
</div>

<p>Die Routen werden in der Reihenfolge durchlaufen, in der sie definiert wurden.
Das erste Routen-Muster, das mit dem Request übereinstimmt, wird ausgeführt.</p>

<p>Die Muster der Routen können benannte Parameter beinhalten, die über den
<code>params</code>-Hash zugänglich gemacht werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/hallo/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># passt auf "GET /hallo/foo" und "GET /hallo/bar"</span>
  <span style="color:#777"># params[:name] ist 'foo' oder 'bar'</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:name</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Man kann auf diese auch mit Block-Parametern zugreifen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/hallo/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span> |n|
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>n<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Routen-Muster können auch mit Splat- oder Wildcard-Parametern über das
<code>params[:splat]</code>-Array angesprochen werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/sag/*/zu/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># passt auf /sag/hallo/zu/welt</span>
  params[<span style="color:#A60">:splat</span>] <span style="color:#777"># =&gt; ["hallo", "welt"]</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/download/*.*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># passt auf /download/pfad/zu/datei.xml</span>
  params[<span style="color:#A60">:splat</span>] <span style="color:#777"># =&gt; ["pfad/zu/datei", "xml"]</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Oder mit Block-Parametern:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/download/*.*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span> |pfad, endung|
  [pfad, endung] <span style="color:#777"># =&gt; ["Pfad/zu/Datei", "xml"]</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Routen mit regulären Ausdrücken sind auch möglich:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">%r{</span><span style="color:#808">/hallo/([</span><span style="color:#D20">\w</span><span style="color:#808">]+)</span><span style="color:#404">}</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo, </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:captures</span>].first<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Und auch hier können Block-Parameter genutzt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">%r{</span><span style="color:#808">/hallo/([</span><span style="color:#D20">\w</span><span style="color:#808">]+)</span><span style="color:#404">}</span></span> <span style="color:#080;font-weight:bold">do</span> |c|
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo, </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>c<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Routen-Muster können auch mit optionalen Parametern ausgestattet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/posts.?:format?</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># passt auf "GET /posts" sowie jegliche Erweiterung</span>
  <span style="color:#777"># wie "GET /posts.json", "GET /posts.xml" etc.</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Anmerkung: Solange man den sog. Path Traversal Attack-Schutz nicht deaktiviert
(siehe weiter unten), kann es sein, dass der Request-Pfad noch vor dem
Abgleich mit den Routen modifiziert wird.</p>

<a name='Bedingungen'></a>
<h3>Bedingungen</h3>

<p>An Routen können eine Vielzahl von Bedingungen angehängt werden, die erfüllt
sein müssen, damit der Block ausgeführt wird. Möglich wäre etwa eine
Einschränkung des User-Agents:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span>, <span style="color:#A60">:agent</span> =&gt; <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">Songbird (</span><span style="color:#D20">\d</span><span style="color:#D20">\.</span><span style="color:#D20">\d</span><span style="color:#808">)[</span><span style="color:#D20">\d</span><span style="color:#D20">\/</span><span style="color:#808">]*?</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Du verwendest Songbird Version </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:agent</span>][<span style="color:#00D">0</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># passt auf andere Browser</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Andere mitgelieferte Bedingungen sind <code>host_name</code> und <code>provides</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, <span style="color:#A60">:host_name</span> =&gt; <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^admin</span><span style="color:#D20">\.</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Adminbereich, Zugriff verweigert!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, <span style="color:#A60">:provides</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">html</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, <span style="color:#A60">:provides</span> =&gt; [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rss</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">atom</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">xml</span><span style="color:#710">'</span></span>] <span style="color:#080;font-weight:bold">do</span>
  builder <span style="color:#A60">:feed</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Es können auch andere Bedingungen relativ einfach hinzugefügt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set(<span style="color:#A60">:probability</span>) { |value| condition { rand &lt;= value } }

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/auto_gewinnen</span><span style="color:#710">'</span></span>, <span style="color:#A60">:probability</span> =&gt; <span style="color:#60E">0.1</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Du hast gewonnen!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/auto_gewinnen</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Tut mir leid, verloren.</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Bei Bedingungen, die mehrere Werte annehmen können, sollte ein Splat verwendet
werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set(<span style="color:#A60">:auth</span>) <span style="color:#080;font-weight:bold">do</span> |*roles|   <span style="color:#777"># &lt;- hier kommt der Splat ins Spiel</span>
  condition <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">unless</span> logged_in? &amp;&amp; roles.any? {|role| current_user.in_role? role }
      redirect <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/login/</span><span style="color:#710">"</span></span>, <span style="color:#00D">303</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/mein/account/</span><span style="color:#710">"</span></span>, <span style="color:#A60">:auth</span> =&gt; [<span style="color:#A60">:user</span>, <span style="color:#A60">:admin</span>] <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Mein Account</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/nur/admin/</span><span style="color:#710">"</span></span>, <span style="color:#A60">:auth</span> =&gt; <span style="color:#A60">:admin</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Nur Admins dürfen hier rein!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='R%C3%BCckgabewerte'></a>
<h3>Rückgabewerte</h3>

<p>Durch den Rückgabewert eines Routen-Blocks wird mindestens der Response-Body
festgelegt, der an den HTTP-Client, bzw. die nächste Rack-Middleware,
weitergegeben wird. Im Normalfall handelt es sich hierbei, wie in den
vorangehenden Beispielen zu sehen war, um einen String. Es werden allerdings
auch andere Werte akzeptiert.</p>

<p>Es kann jedes gültige Objekt zurückgegeben werden, bei dem es sich entweder um
einen Rack-Rückgabewert, einen Rack-Body oder einen HTTP-Status-Code handelt:</p>

<ul>
<li>Ein Array mit drei Elementen: <code>[Status (Fixnum), Headers (Hash),
Response-Body (antwortet auf #each)]</code>.</li>
  <li>Ein Array mit zwei Elementen: <code>[Status (Fixnum), Response-Body (antwortet
auf #each)]</code>.</li>
  <li>Ein Objekt, das auf <code>#each</code> antwortet und den an diese Methode übergebenen
Block nur mit Strings als Übergabewerte aufruft.</li>
  <li>Ein Fixnum, das den Status-Code festlegt.</li>
</ul>
<p>Damit lässt sich relativ einfach Streaming implementieren:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Stream</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">each</span>
    <span style="color:#00D">100</span>.times { |i| <span style="color:#080;font-weight:bold">yield</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>i<span style="font-weight:bold;color:#666">}</span></span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span> }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="color:#036;font-weight:bold">Stream</span>.new }
</pre></div>
</div>
</div>

<p>Ebenso kann die <code>stream</code>-Helfer-Methode (s.u.) verwendet werden, die Streaming
direkt in die Route integriert.</p>

<a name='Eigene%20Routen-Muster'></a>
<h3>Eigene Routen-Muster</h3>

<p>Wie oben schon beschrieben, ist Sinatra von Haus aus mit Unterstützung für
String-Muster und Reguläre Ausdrücke zum Abgleichen von Routen ausgestattet.
Das muss aber noch nicht alles sein, es können ohne großen Aufwand eigene
Routen-Muster erstellt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AllButPattern</span>
  <span style="color:#036;font-weight:bold">Match</span> = <span style="color:#036;font-weight:bold">Struct</span>.new(<span style="color:#A60">:captures</span>)

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(except)
    <span style="color:#33B">@except</span>   = except
    <span style="color:#33B">@captures</span> = <span style="color:#036;font-weight:bold">Match</span>.new([])
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">match</span>(str)
    <span style="color:#33B">@captures</span> <span style="color:#080;font-weight:bold">unless</span> <span style="color:#33B">@except</span> === str
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">all_but</span>(pattern)
  <span style="color:#036;font-weight:bold">AllButPattern</span>.new(pattern)
<span style="color:#080;font-weight:bold">end</span>

get all_but(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/index</span><span style="color:#710">"</span></span>) <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Beachte, dass das obige Beispiel etwas übertrieben wirkt. Es geht auch einfacher:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  pass <span style="color:#080;font-weight:bold">if</span> request.path_info == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/index</span><span style="color:#710">"</span></span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Oder unter Verwendung eines negativen look ahead:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">%r{</span><span style="color:#808">^(?!/index$)</span><span style="color:#404">}</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>
<p>## Statische Dateien</p>

<p>Statische Dateien werden aus dem <code>./public</code>-Ordner ausgeliefert. Es ist möglich,
einen anderen Ort zu definieren, indem man die <code>:public_folder</code>-Option setzt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:public_folder</span>, <span style="color:#036;font-weight:bold">File</span>.dirname(<span style="color:#069">__FILE__</span>) + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/static</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Zu beachten ist, dass der Ordnername public nicht Teil der URL ist. Die Datei
<code>./public/css/style.css</code> ist unter <code>http://example.com/css/style.css</code> zu finden.</p>

<p>Um den <code>Cache-Control</code>-Header mit Informationen zu versorgen, verwendet man
die <code>:static_cache_control</code>-Einstellung (s.u.).</p>

<a name='Views/Templates'></a>
<h2>Views/Templates</h2>

<p>Alle Templatesprachen verwenden ihre eigene Renderingmethode, die jeweils
einen String zurückgibt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Dieses Beispiel rendert <code>views/index.erb</code>.</p>

<p>Anstelle eines Templatenamens kann man auch direkt die Templatesprache verwenden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  code = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">&lt;%= Time.now %&gt;</span><span style="color:#710">"</span></span>
  erb code
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Templates nehmen ein zweite Argument an, den Options-Hash:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:index</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#A60">:post</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Dieses Beispiel rendert <code>views/index.erb</code> eingebettet in <code>views/post.erb</code>
(Voreinstellung ist <code>views/layout.erb</code>, sofern es vorhanden ist.)</p>

<p>Optionen, die Sinatra nicht versteht, werden an das Template weitergereicht:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>, <span style="color:#A60">:format</span> =&gt; <span style="color:#A60">:html5</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Für alle Templates können auch generelle Einstellungen festgelegt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:haml</span>, <span style="color:#A60">:format</span> =&gt; <span style="color:#A60">:html5</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Optionen, die an die Rendermethode weitergegeben werden, überschreiben die
Einstellungen, die mit <code>set</code> festgelegt wurden.</p>

<p>Einstellungen:</p>

<dl>
<dt>locals</dt>
  <dd>Liste von lokalen Variablen, die and das Dokument weitergegeben werden.
    Praktisch für Partials:

    <tt>erb "&lt;%= foo %&gt;", :locals =&gt; {:foo =&gt; "bar"}</tt>
</dd>
      
  <dt>default_encoding</dt>
  <dd>Gibt die Stringkodierung an, die verwendet werden soll. Voreingestellt
    auf <tt>settings.default_encoding</tt>.</dd>
      
  <dt>views</dt>
  <dd>Ordner, aus dem die Templates heraus geladen werden. Voreingestellt auf
    <tt>settings.views</tt>.</dd>
      
  <dt>layout</dt>
  <dd>Legt fest, ob ein Layouttemplate verwendet werden soll oder nicht
    (<tt>true</tt> oder<tt>false</tt>). Ist es ein Symbol, dann legt es fest,
    welches Template als Layout verwendet wird:

    <tt>erb :index, :layout =&gt; !request.xhr?</tt>
</dd>
      
  <dt>content_type</dt>
  <dd>Content-Type den das Template ausgibt. Voreinstellung hängt von der
    Templatesprache ab.</dd>
      
  <dt>scope</dt>
  <dd>Scope, in dem das Template gerendert wird. Liegt standardmäßig innerhalb
    der App-Instanz. Wird Scope geändert, sind Instanzvariablen und
    Helfermethoden nicht verfügbar.</dd>
      
  <dt>layout_engine</dt>
  <dd>Legt fest, welcher Renderer für das Layout verantwortlich ist. Hilfreich
    für Sprachen, die sonst keine Templates unterstützen. Voreingestellt auf
    den Renderer, der für das Template verwendet wird:

    <tt>set :rdoc, :layout_engine =&gt; :erb</tt>
</dd>
  <dt>layout_options</dt>
  <dd>Besondere Einstellungen, die nur für das Rendering verwendet werden:

    <tt>set :rdoc, :layout_options =&gt; { :views =&gt; 'views/layouts' }</tt>
</dd>
</dl>
<p>Sinatra geht davon aus, dass die Templates sich im <code>./views</code> Verzeichnis
befinden. Es kann jedoch ein anderer Ordner festgelegt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:views</span>, settings.root + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/templates</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Es ist zu beachten, dass immer mit Symbolen auf Templates verwiesen werden muss,
auch dann, wenn sie sich in einem Unterordner befinden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>haml <span style="color:#A60"><span style="color:#A60">:</span><span style="color:#630">'</span><span style="color:#A60">unterverzeichnis/template</span><span style="color:#630">'</span></span>
</pre></div>
</div>
</div>

<p>Rendering-Methoden rendern jeden String direkt.</p>

<a name='Direkte%20Templates'></a>
<h3>Direkte Templates</h3>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%div.title Hallo Welt</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Hier wird der String direkt gerendert.</p>

<a name='Verf%C3%BCgbare%20Templatesprachen'></a>
<h3>Verfügbare Templatesprachen</h3>

<p>Einige Sprachen haben mehrere Implementierungen. Um festzulegen, welche
verwendet wird (und dann auch Thread-sicher ist), verwendet man am besten zu
Beginn ein <code>'require'</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rdiscount</span><span style="color:#710">'</span></span> <span style="color:#777"># oder require 'bluecloth'</span>
get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { markdown <span style="color:#A60">:index</span> }
</pre></div>
</div>
</div>

<a name='Haml%20Templates'></a>
<h4>Haml Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://haml.info/">haml</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.haml</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>haml :index, :format =&gt; :html5</tt></td>
  </tr>
</table>
<a name='Erb%20Templates'></a>
<h4>Erb Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td>
<a href="http://www.kuwata-lab.com/erubis/">erubis</a> oder erb 
    (Standardbibliothek von Ruby)</td>
  </tr>
<tr>
<td>Dateierweiterungen</td>
    <td>
<tt>.erb</tt>, <tt>.rhtml</tt> oder <tt>.erubis</tt> (nur Erubis)</td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>
<a name='Builder%20Templates'></a>
<h4>Builder Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://builder.rubyforge.org/">builder</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.builder</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>builder { |xml| xml.em "Hallo" }</tt></td>
  </tr>
</table>
<p>Nimmt ebenso einen Block für Inline-Templates entgegen (siehe Beispiel).</p>

<a name='Nokogiri%20Templates'></a>
<h4>Nokogiri Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://nokogiri.org/">nokogiri</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>nokogiri { |xml| xml.em "Hallo" }</tt></td>
  </tr>
</table>
<p>Nimmt ebenso einen Block für Inline-Templates entgegen (siehe Beispiel).</p>

<a name='Sass%20Templates'></a>
<h4>Sass Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://sass-lang.com/">sass</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.sass</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>sass :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>
<a name='SCSS%20Templates'></a>
<h4>SCSS Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://sass-lang.com/">sass</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.scss</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>scss :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>
<a name='Less%20Templates'></a>
<h4>Less Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://www.lesscss.org/">less</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.less</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>less :stylesheet</tt></td>
  </tr>
</table>
<a name='Liquid%20Templates'></a>
<h4>Liquid Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://www.liquidmarkup.org/">liquid</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.liquid</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>liquid :index, :locals =&gt; { :key =&gt; 'Wert' }</tt></td>
  </tr>
</table>
<p>Da man aus dem Liquid-Template heraus keine Ruby-Methoden aufrufen kann
(ausgenommen <code>yield</code>), wird man üblicherweise locals verwenden wollen, mit
denen man Variablen weitergibt.</p>

<a name='Markdown%20Templates'></a>
<h4>Markdown Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td>Eine der folgenden Bibliotheken: 
        <a href="https://github.com/rtomayko/rdiscount" title="RDiscount">RDiscount</a>,
        <a href="https://github.com/vmg/redcarpet" title="RedCarpet">RedCarpet</a>,
        <a href="http://deveiate.org/projects/BlueCloth" title="BlueCloth">BlueCloth</a>,
        <a href="http://kramdown.rubyforge.org/" title="kramdown">kramdown</a> oder
        <a href="http://maruku.rubyforge.org/" title="maruku">maruku</a>
    </td>
  </tr>
<tr>
<td>Dateierweiterungen</td>
    <td>
<tt>.markdown</tt>, <tt>.mkd</tt> und <tt>.md</tt>
</td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>markdown :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>Da man aus den Markdown-Templates heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Markdown üblicherweise in Kombination
mit anderen Renderern verwenden wollen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; markdown(<span style="color:#A60">:einfuehrung</span>) }
</pre></div>
</div>
</div>

<p>Beachte, dass man die <code>markdown</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Gruß</span> von Haml!
%p= markdown(<span style="color:#A60">:Grüße</span>)
</pre></div>
</div>
</div>

<p>Da man Ruby nicht von Markdown heraus aufrufen kann, können auch Layouts nicht
in Markdown geschrieben werden. Es ist aber möglich, einen Renderer für die
Templates zu verwenden und einen anderen für das Layout, indem die
<code>:layout_engine</code>-Option verwendet wird.</p>

<a name='Textile%20Templates'></a>
<h4>Textile Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://redcloth.org/">RedCloth</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.textile</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>textile :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>Da man aus dem Textile-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Textile üblicherweise in Kombination mit
anderen Renderern verwenden wollen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; textile(<span style="color:#A60">:einfuehrung</span>) }
</pre></div>
</div>
</div>

<p>Beachte, dass man die <code>textile</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Gruß</span> von Haml!
%p= textile(<span style="color:#A60">:Grüße</span>)
</pre></div>
</div>
</div>

<p>Da man Ruby nicht von Textile heraus aufrufen kann, können auch Layouts nicht
in Textile geschrieben werden. Es ist aber möglich, einen Renderer für die
Templates zu verwenden und einen anderen für das Layout, indem die
<code>:layout_engine</code>-Option verwendet wird.</p>

<a name='RDoc%20Templates'></a>
<h4>RDoc Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://rdoc.rubyforge.org/">rdoc</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.rdoc</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>textile :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>Da man aus dem RDoc-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man RDoc üblicherweise in Kombination mit
anderen Renderern verwenden wollen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; rdoc(<span style="color:#A60">:einfuehrung</span>) }
</pre></div>
</div>
</div>

<p>Beachte, dass man die <code>rdoc</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Gruß</span> von Haml!
%p= rdoc(<span style="color:#A60">:Grüße</span>)
</pre></div>
</div>
</div>

<p>Da man Ruby nicht von RDoc heraus aufrufen kann, können auch Layouts nicht in
RDoc geschrieben werden. Es ist aber möglich, einen Renderer für die Templates
zu verwenden und einen anderen für das Layout, indem die
<code>:layout_engine</code>-Option verwendet wird.</p>

<a name='Radius%20Templates'></a>
<h4>Radius Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://radius.rubyforge.org/">radius</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.radius</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>radius :index, :locals =&gt; { :key =&gt; 'Wert' }</tt></td>
  </tr>
</table>
<p>Da man aus dem Radius-Template heraus keine Ruby-Methoden aufrufen kann, wird
man üblicherweise locals verwenden wollen, mit denen man Variablen weitergibt.</p>

<a name='Markaby%20Templates'></a>
<h4>Markaby Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://markaby.github.com/">markaby</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.mab</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>markaby { h1 "Willkommen!" }</tt></td>
  </tr>
</table>
<p>Nimmt ebenso einen Block für Inline-Templates entgegen (siehe Beispiel).</p>

<a name='RABL%20Templates'></a>
<h4>RABL Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="https://github.com/nesquena/rabl">rabl</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.rabl</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>
<a name='Slim%20Templates'></a>
<h4>Slim Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="http://slim-lang.com/">slim</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.slim</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>
<a name='Creole%20Templates'></a>
<h4>Creole Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="https://github.com/minad/creole">creole</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.creole</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>creole :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>Da man aus dem Creole-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Creole üblicherweise in Kombination mit
anderen Renderern verwenden wollen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; creole(<span style="color:#A60">:einfuehrung</span>) }
</pre></div>
</div>
</div>

<p>Beachte, dass man die <code>creole</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Gruß</span> von Haml!
%p= creole(<span style="color:#A60">:Grüße</span>)
</pre></div>
</div>
</div>

<p>Da man Ruby nicht von Creole heraus aufrufen kann, können auch Layouts nicht in
Creole geschrieben werden. Es ist aber möglich, einen Renderer für die Templates
zu verwenden und einen anderen für das Layout, indem die <code>:layout_engine</code>-Option
verwendet wird.</p>

<a name='CoffeeScript%20Templates'></a>
<h4>CoffeeScript Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td>
<a href="https://github.com/josh/ruby-coffee-script">coffee-script</a> 
        und eine <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme">Möglichkeit JavaScript auszuführen</a>.
    </td>
  </tr>
<td>Dateierweiterung</td>
    <td><tt>.coffee</tt></td>
  
  <tr>
<td>Beispiel</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>
<a name='Stylus%20Templates'></a>
<h4>Stylus Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td>
      <a href="https://github.com/lucasmazza/ruby-stylus" title="Ruby Stylus">
        Stylus
      </a> und eine Möglichkeit 
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        JavaScript auszuführen
      </a>.
    </td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.styl</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>stylus :index</tt></td>
  </tr>
</table>
<p>Um Stylus-Templates ausführen zu können, müssen <code>stylus</code> und <code>stylus/tilt</code>
zuerst geladen werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">stylus</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">stylus/tilt</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  stylus <span style="color:#A60">:example</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Yajl%20Templates'></a>
<h4>Yajl Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">yajl-ruby</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.yajl</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td>
      <tt>
        yajl :index,
             :locals =&gt; { :key =&gt; 'qux' },
             :callback =&gt; 'present',
             :variable =&gt; 'resource'
      </tt>
    </td>
  </tr>
</table>
<p>Die Template-Quelle wird als Ruby-String evaluiert. Die daraus resultierende
json Variable wird mit Hilfe von <code>#to_json</code> umgewandelt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>json = { <span style="color:#A60">:foo</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bar</span><span style="color:#710">'</span></span> }
json[<span style="color:#A60">:baz</span>] = key
</pre></div>
</div>
</div>

<p>Die <code>:callback</code> und <code>:variable</code> Optionen können mit dem gerenderten Objekt
verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>var resource = {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">foo</span><span style="color:#710">"</span></span><span style="color:#A60"><span style="color:#A60">:</span><span style="color:#630">"</span><span style="color:#A60">bar</span><span style="color:#630">"</span></span>,<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">baz</span><span style="color:#710">"</span></span><span style="color:#A60"><span style="color:#A60">:</span><span style="color:#630">"</span><span style="color:#A60">qux</span><span style="color:#630">"</span></span>}; present(resource);
</pre></div>
</div>
</div>

<a name='WLang%20Templates'></a>
<h4>WLang Templates</h4>

<table>
<tr>
<td>Abhängigkeit</td>
    <td><a href="https://github.com/blambeau/wlang/">wlang</a></td>
  </tr>
<tr>
<td>Dateierweiterung</td>
    <td><tt>.wlang</tt></td>
  </tr>
<tr>
<td>Beispiel</td>
    <td><tt>wlang :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>
<p>Ruby-Methoden in wlang aufzurufen entspricht nicht den idiomatischen Vorgaben
von wlang, es bietet sich deshalb an, <code>:locals</code> zu verwenden. Layouts, die
wlang und <code>yield</code> verwenden, werden aber trotzdem unterstützt.</p>

<p>Rendert den eingebetteten Template-String.</p>

<a name='Auf%20Variablen%20in%20Templates%20zugreifen'></a>
<h3>Auf Variablen in Templates zugreifen</h3>

<p>Templates werden in demselben Kontext ausgeführt wie Routen. Instanzvariablen
in Routen sind auch direkt im Template verfügbar:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:id</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@foo</span> = <span style="color:#036;font-weight:bold">Foo</span>.find(params[<span style="color:#A60">:id</span>])
  haml <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%h1= @foo.name</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Oder durch einen expliziten Hash von lokalen Variablen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:id</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  foo = <span style="color:#036;font-weight:bold">Foo</span>.find(params[<span style="color:#A60">:id</span>])
  haml <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%h1= bar.name</span><span style="color:#710">'</span></span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:bar</span> =&gt; foo }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Dies wird typischerweise bei Verwendung von Subtemplates (partials) in anderen
Templates eingesetzt.</p>

<a name='Templates%20mit%20%3Ccode%3Eyield%3C/code%3E%20und%20verschachtelte%20Layouts'></a>
<h3>Templates mit <code>yield</code> und verschachtelte Layouts</h3>

<p>Ein Layout ist üblicherweise ein Template, dass ein <code>yield</code> aufruft. Ein solches
Template kann entweder wie oben beschrieben über die <code>:template</code> option
verwendet werden oder mit einem Block gerendert werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:post</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#069">false</span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Dieser Code entspricht weitestgehend <code>erb :index, :layout =&gt; :post</code>.</p>

<p>Blöcke an Render-Methoden weiterzugeben ist besonders bei verschachtelten
Layouts hilfreich:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:main_layout</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#069">false</span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:admin_layout</span> <span style="color:#080;font-weight:bold">do</span>
    erb <span style="color:#A60">:user</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Der gleiche Effekt kann auch mit weniger Code erreicht werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:admin_layout</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#A60">:main_layout</span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:user</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Zur Zeit nehmen folgende Renderer Blöcke an: <code>erb</code>, <code>haml</code>, <code>liquid</code>, <code>slim </code>
und <code>wlang</code>.</p>

<p>Das gleich gilt auch für die allgemeine <code>render</code> Methode.</p>

<a name='Inline-Templates'></a>
<h3>Inline-Templates</h3>

<p>Templates können auch am Ende der Datei definiert werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777">__END__

@@ layout
%html
  = yield

@@ index
%div.title Hallo Welt!!!!!</span>
</pre></div>
</div>
</div>

<p>Anmerkung: Inline-Templates, die in der Datei definiert sind, die <code>require
'sinatra'</code> aufruft, werden automatisch geladen. Um andere Inline-Templates in
anderen Dateien aufzurufen, muss explizit <code>enable :inline_templates</code> verwendet
werden.</p>

<a name='Benannte%20Templates'></a>
<h3>Benannte Templates</h3>

<p>Templates können auch mit der Top-Level <code>template</code>-Methode definiert werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>template <span style="color:#A60">:layout</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">%html</span><span style="color:#b0b">\n</span><span style="color:#D20">  =yield</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

template <span style="color:#A60">:index</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%div.title Hallo Welt!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Wenn ein Template mit dem Namen “layout” existiert, wird es bei jedem Aufruf
verwendet. Durch <code>:layout =&gt; false</code> kann das Ausführen verhindert werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>, <span style="color:#A60">:layout</span> =&gt; request.xhr?
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Dateiendungen%20zuordnen'></a>
<h3>Dateiendungen zuordnen</h3>

<p>Um eine Dateiendung einer Template-Engine zuzuordnen, kann <code>Tilt.register</code>
genutzt werden. Wenn etwa die Dateiendung <code>tt</code> für Textile-Templates genutzt
werden soll, lässt sich dies wie folgt bewerkstelligen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">Tilt</span>.register <span style="color:#A60">:tt</span>, <span style="color:#036;font-weight:bold">Tilt</span>[<span style="color:#A60">:textile</span>]
</pre></div>
</div>
</div>

<a name='Eine%20eigene%20Template-Engine%20hinzuf%C3%BCgen'></a>
<h3>Eine eigene Template-Engine hinzufügen</h3>

<p>Zu allererst muss die Engine bei Tilt registriert und danach eine
Rendering-Methode erstellt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">Tilt</span>.register <span style="color:#A60">:mtt</span>, <span style="color:#036;font-weight:bold">MeineTolleTemplateEngine</span>

helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">mtt</span>(*args) render(<span style="color:#A60">:mtt</span>, *args) <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  mtt <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Dieser Code rendert <code>./views/application.mtt</code>. Siehe
<a href="https://github.com/rtomayko/tilt">github.com/rtomayko/tilt</a>, um mehr über
Tilt zu erfahren.</p>

<a name='Filter'></a>
<h2>Filter</h2>

<p>Before-Filter werden vor jedem Request in demselben Kontext, wie danach die
Routen, ausgeführt. So können etwa Request und Antwort geändert werden.
Gesetzte Instanzvariablen in Filtern können in Routen und Templates verwendet
werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@note</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hi!</span><span style="color:#710">'</span></span>
  request.path_info = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo/bar/baz</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@note</span> <span style="color:#777">#=&gt; 'Hi!'</span>
  params[<span style="color:#A60">:splat</span>] <span style="color:#777">#=&gt; 'bar/baz'</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>After-Filter werden nach jedem Request in demselben Kontext ausgeführt und
können ebenfalls Request und Antwort ändern. In Before-Filtern gesetzte
Instanzvariablen können in After-Filtern verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>after <span style="color:#080;font-weight:bold">do</span>
  puts response.status
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Filter können optional auch mit einem Muster ausgestattet werden, welches auf
den Request-Pfad passen muss, damit der Filter ausgeführt wird:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/protected/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  authenticate!
<span style="color:#080;font-weight:bold">end</span>

after <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/create/:slug</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span> |slug|
  session[<span style="color:#A60">:last_slug</span>] = slug
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Ähnlich wie Routen können Filter auch mit weiteren Bedingungen eingeschränkt
werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#A60">:agent</span> =&gt; <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">Songbird</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>

after <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/blog/*</span><span style="color:#710">'</span></span>, <span style="color:#A60">:host_name</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">example.com</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Helfer'></a>
<h2>Helfer</h2>

<p>Durch die Top-Level <code>helpers</code>-Methode werden sogenannte Helfer-Methoden
definiert, die in Routen und Templates verwendet werden können:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">bar</span>(name)
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">bar</span><span style="color:#710">"</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  bar(params[<span style="color:#A60">:name</span>])
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Sessions%20verwenden'></a>
<h3>Sessions verwenden</h3>
<p>Sessions werden verwendet, um Zustände zwischen den Requests zu speichern. Sind
sie aktiviert, kann ein Session-Hash je Benutzer-Session verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>enable <span style="color:#A60">:sessions</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">value = </span><span style="color:#710">"</span></span> &lt;&lt; session[<span style="color:#A60">:value</span>].inspect
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:value</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:value</span>] = params[<span style="color:#A60">:value</span>]
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Beachte, dass <code>enable :sessions</code> alle Daten in einem Cookie speichert. Unter
Umständen kann dies negative Effekte haben, z.B. verursachen viele Daten
höheren, teilweise überflüssigen Traffic. Um das zu vermeiden, kann eine Rack-
Session-Middleware verwendet werden. Dabei wird auf <code>enable :sessions</code>
verzichtet und die Middleware wie üblich im Programm eingebunden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Session</span>::<span style="color:#036;font-weight:bold">Pool</span>, <span style="color:#A60">:expire_after</span> =&gt; <span style="color:#00D">2592000</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">value = </span><span style="color:#710">"</span></span> &lt;&lt; session[<span style="color:#A60">:value</span>].inspect
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:value</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:value</span>] = params[<span style="color:#A60">:value</span>]
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Um die Sicherheit zu erhöhen, werden Cookies, die Session-Daten führen, mit
einem sogenannten Session-Secret signiert. Da sich dieses Geheimwort bei jedem
Neustart der Applikation automatisch ändert, ist es sinnvoll, ein eigenes zu
wählen, damit sich alle Instanzen der Applikation dasselbe Session-Secret
teilen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:session_secret</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">super secret</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Zur weiteren Konfiguration kann man einen Hash mit Optionen in den <code>sessions</code>
Einstellungen ablegen.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:sessions</span>, <span style="color:#A60">:domain</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo.com</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<a name='Anhalten'></a>
<h3>Anhalten</h3>

<p>Zum sofortigen Stoppen eines Request in einem Filter oder einer Route:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt
</pre></div>
</div>
</div>

<p>Der Status kann beim Stoppen auch angegeben werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="color:#00D">410</span>
</pre></div>
</div>
</div>

<p>Oder auch den Response-Body:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hier steht der Body</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Oder beides:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="color:#00D">401</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">verschwinde!</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Sogar mit Headern:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="color:#00D">402</span>, {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Content-Type</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">text/plain</span><span style="color:#710">'</span></span>}, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Rache</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Natürlich ist es auch möglich, ein Template mit <code>halt</code> zu verwenden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt erb(<span style="color:#A60">:error</span>)
</pre></div>
</div>
</div>

<a name='Weiterspringen'></a>
<h3>Weiterspringen</h3>

<p>Eine Route kann mittels <code>pass</code> zu der nächsten passenden Route springen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/raten/:wer</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  pass <span style="color:#080;font-weight:bold">unless</span> params[<span style="color:#A60">:wer</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Frank</span><span style="color:#710">'</span></span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Du hast mich!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/raten/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Du hast mich nicht!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Der Block wird sofort verlassen und es wird nach der nächsten treffenden Route
gesucht. Ein 404-Fehler wird zurückgegeben, wenn kein treffendes Routen-Muster
gefunden wird.</p>

<a name='Eine%20andere%20Route%20ansteuern'></a>
<h3>Eine andere Route ansteuern</h3>

<p>Manchmal entspricht <code>pass</code> nicht den Anforderungen, wenn das Ergebnis einer
anderen Route gefordert wird. Um das zu erreichen, lässt sich <code>call</code> nutzen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  status, headers, body = call env.merge(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">PATH_INFO</span><span style="color:#710">"</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>)
  [status, headers, body.map(&amp;<span style="color:#A60">:upcase</span>)]
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">bar</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Beachte, dass in dem oben angegeben Beispiel die Performance erheblich erhöht
werden kann, wenn <code>"bar"</code> in eine Helfer-Methode umgewandelt wird, auf die
<code>/foo</code> und <code>/bar</code> zugreifen können.</p>

<p>Wenn der Request innerhalb derselben Applikations-Instanz aufgerufen und keine
Kopie der Instanz erzeugt werden soll, kann <code>call!</code> anstelle von <code>call</code>
verwendet werden.</p>

<p>Die Rack-Spezifikationen enthalten weitere Informationen zu <code>call</code>.</p>

<a name='Body,%20Status-Code%20und%20Header%20setzen'></a>
<h3>Body, Status-Code und Header setzen</h3>

<p>Es ist möglich und empfohlen, den Status-Code sowie den Response-Body mit
einem Returnwert in der Route zu setzen. In manchen Situationen kann es jedoch
sein, dass der Body an irgendeiner anderen Stelle während der Ausführung
gesetzt wird. Das lässt sich mit der Helfer-Methode <code>body</code> bewerkstelligen.
Wird <code>body</code> verwendet, lässt sich der Body jederzeit über diese Methode
aufrufen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  body <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">bar</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

after <span style="color:#080;font-weight:bold">do</span>
  puts body
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Ebenso ist es möglich, einen Block an <code>body</code> weiterzureichen, der dann vom
Rack-Handler ausgeführt wird (lässt sich z.B. zur Umsetzung von Streaming
einsetzen, siehe auch “Rückgabewerte”).</p>

<p>Vergleichbar mit <code>body</code> lassen sich auch Status-Code und Header setzen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  status <span style="color:#00D">418</span>
  headers \
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Allow</span><span style="color:#710">"</span></span>   =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">BREW, POST, GET, PROPFIND, WHEN</span><span style="color:#710">"</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Refresh</span><span style="color:#710">"</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt</span><span style="color:#710">"</span></span>
  halt <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Ich bin ein Teekesselchen</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Genau wie bei <code>body</code> liest ein Aufrufen von <code>headers</code> oder <code>status</code> ohne
Argumente den aktuellen Wert aus.</p>

<a name='Response-Streams'></a>
<h3>Response-Streams</h3>

<p>In manchen Situationen sollen Daten bereits an den Client zurückgeschickt
werden, bevor ein vollständiger Response bereit steht. Manchmal will man die
Verbindung auch erst dann beenden und Daten so lange an den Client
zurückschicken, bis er die Verbindung abbricht. Für diese Fälle gibt es die
<code>stream</code>-Helfer-Methode, die es einem erspart eigene Lösungen zu schreiben:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  stream <span style="color:#080;font-weight:bold">do</span> |out|
    out &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Das ist ja mal wieder fanta -</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
    sleep <span style="color:#60E">0.5</span>
    out &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20"> (bitte warten…) </span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
    sleep <span style="color:#00D">1</span>
    out &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">- stisch!</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Damit lassen sich Streaming-APIs realisieren, sog. 
<a href="http://dev.w3.org/html5/eventsource/">Server Sent Events</a> die als Basis für
<a href="http://en.wikipedia.org/wiki/WebSocket">WebSockets</a> dienen. Ebenso können sie
verwendet werden, um den Durchsatz zu erhöhen, wenn ein Teil der Daten von
langsamen Ressourcen abhängig ist.</p>

<p>Es ist zu beachten, dass das Verhalten beim Streaming, insbesondere die Anzahl
nebenläufiger Anfragen, stark davon abhängt, welcher Webserver für die
Applikation verwendet wird. Einige Server, z.B. WEBRick, unterstützen
Streaming nicht oder nur teilweise. Sollte der Server Streaming nicht
unterstützen, wird ein vollständiger Response-Body zurückgeschickt, sobald der
an <code>stream</code> weitergegebene Block abgearbeitet ist. Mit Shotgun funktioniert
Streaming z.B. überhaupt nicht.</p>

<p>Ist der optionale Parameter <code>keep_open</code> aktiviert, wird beim gestreamten Objekt
<code>close</code> nicht aufgerufen und es ist einem überlassen dies an einem beliebigen
späteren Zeitpunkt nachholen. Die Funktion ist jedoch nur bei Event-gesteuerten
Serven wie Thin oder Rainbows möglich, andere Server werden trotzdem den Stream
beenden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># Durchgehende Anfrage (long polling)</span>

set <span style="color:#A60">:server</span>, <span style="color:#A60">:thin</span>
connections = []

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/subscribe</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># Client-Registrierung beim Server, damit Events mitgeteilt werden können</span>
  stream(<span style="color:#A60">:keep_open</span>) { |out| connections &lt;&lt; out }

  <span style="color:#777"># tote Verbindungen entfernen </span>
  connections.reject!(&amp;<span style="color:#A60">:closed?</span>)

  <span style="color:#777"># Rückmeldung</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Angemeldet</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

post <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/message</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  connections.each <span style="color:#080;font-weight:bold">do</span> |out|
    <span style="color:#777"># Den Client über eine neue Nachricht in Kenntnis setzen</span>
    <span style="color:#777"># notify client that a new message has arrived</span>
    out &lt;&lt; params[<span style="color:#A60">:message</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>

    <span style="color:#777"># Den Client zur erneuten Verbindung auffordern</span>
    out.close
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># Rückmeldung</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Mitteiling erhalten</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Logger'></a>
<h3>Logger</h3>

<p>Im Geltungsbereich eines Request stellt die <code>logger</code> Helfer-Methode eine <code>Logger</code>
Instanz zur Verfügung:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">es passiert gerade etwas</span><span style="color:#710">"</span></span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Der Logger übernimmt dabei automatisch alle im Rack-Handler eingestellten 
Log-Vorgaben. Ist Loggen ausgeschaltet, gibt die Methode ein Leerobjekt zurück.
In den Routen und Filtern muss man sich also nicht weiter darum kümmern.</p>

<p>Beachte, dass das Loggen standardmäßig nur für <code>Sinatra::Application</code>
voreingestellt ist. Wird über <code>Sinatra::Base</code> vererbt, muss es erst aktiviert
werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  configure <span style="color:#A60">:production</span>, <span style="color:#A60">:development</span>  <span style="color:#080;font-weight:bold">do</span>
    enable <span style="color:#A60">:logging</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Damit auch keine Middleware das Logging aktivieren kann, muss die <code>logging</code>
Einstellung auf <code>nil</code> gesetzt werden. Das heißt aber auch, dass <code>logger</code> in
diesem Fall <code>nil</code> zurückgeben wird. Üblicherweise wird das eingesetzt, wenn ein
eigener Logger eingerichtet werden soll. Sinatra wird dann verwenden, was in 
<code>env['rack.logger']</code> eingetragen ist.</p>

<a name='Mime-Types'></a>
<h3>Mime-Types</h3>

<p>Wenn <code>send_file</code> oder statische Dateien verwendet werden, kann es vorkommen,
dass Sinatra den Mime-Typ nicht kennt. Registriert wird dieser mit <code>mime_type</code>
per Dateiendung:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#080;font-weight:bold">do</span>
  mime_type <span style="color:#A60">:foo</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">text/foo</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Es kann aber auch der <code>content_type</code>-Helfer verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  content_type <span style="color:#A60">:foo</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">foo foo foo</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='URLs%20generieren'></a>
<h3>URLs generieren</h3>

<p>Zum Generieren von URLs sollte die <code>url</code>-Helfer-Methode genutzen werden, so z.B.
beim Einsatz von Haml:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%a{<span style="color:#A60">:href</span> =&gt; url(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span>)} foo
</pre></div>
</div>
</div>

<p>Soweit vorhanden, wird Rücksicht auf Proxys und Rack-Router genommen.</p>

<p>Diese Methode ist ebenso über das Alias <code>to</code> zu erreichen (siehe Beispiel unten).</p>

<a name='Browser-Umleitung'></a>
<h3>Browser-Umleitung</h3>

<p>Eine Browser-Umleitung kann mithilfe der <code>redirect</code>-Helfer-Methode erreicht
werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>)
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Weitere Parameter werden wie Argumente der <code>halt</code>-Methode behandelt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>), <span style="color:#00D">303</span>
redirect <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">http://google.com</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hier bist du falsch</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Ebenso leicht lässt sich ein Schritt zurück mit dem Alias <code>redirect back</code>
erreichen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">&lt;a href='/bar'&gt;mach was&lt;/a&gt;</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  mach_was
  redirect back
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Um Argumente an ein Redirect weiterzugeben, können sie entweder dem Query
übergeben:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar?summe=42</span><span style="color:#710">'</span></span>)
</pre></div>
</div>
</div>

<p>oder eine Session verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>enable <span style="color:#A60">:sessions</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:secret</span>] = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo</span><span style="color:#710">'</span></span>
  redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>)
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:secret</span>]
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Cache%20einsetzen'></a>
<h3>Cache einsetzen</h3>

<p>Ein sinnvolles Einstellen von Header-Daten ist die Grundlage für ein
ordentliches HTTP-Caching.</p>

<p>Der Cache-Control-Header lässt sich ganz einfach einstellen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  cache_control <span style="color:#A60">:public</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">schon gecached!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Profitipp: Caching im before-Filter aktivieren</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#080;font-weight:bold">do</span>
  cache_control <span style="color:#A60">:public</span>, <span style="color:#A60">:must_revalidate</span>, <span style="color:#A60">:max_age</span> =&gt; <span style="color:#00D">60</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Bei Verwendung der <code>expires</code>-Helfermethode zum Setzen des gleichnamigen Headers,
wird <code>Cache-Control</code> automatisch eigestellt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#080;font-weight:bold">do</span>
  expires <span style="color:#00D">500</span>, <span style="color:#A60">:public</span>, <span style="color:#A60">:must_revalidate</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Um alles richtig zu machen, sollten auch <code>etag</code> oder <code>last_modified</code> verwendet
werden. Es wird empfohlen, dass diese Helfer aufgerufen werden <strong>bevor</strong> die
eigentliche Arbeit anfängt, da sie sofort eine Antwort senden, wenn der Client
eine aktuelle Version im Cache vorhält:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/article/:id</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@article</span> = <span style="color:#036;font-weight:bold">Article</span>.find params[<span style="color:#A60">:id</span>]
  last_modified <span style="color:#33B">@article</span>.updated_at
  etag <span style="color:#33B">@article</span>.sha1
  erb <span style="color:#A60">:article</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>ebenso ist es möglich einen 
<a href="http://de.wikipedia.org/wiki/HTTP_ETag">schwachen ETag</a> zu verwenden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>etag <span style="color:#33B">@article</span>.sha1, <span style="color:#A60">:weak</span>
</pre></div>
</div>
</div>

<p>Diese Helfer führen nicht das eigentliche Caching aus, sondern geben die dafür
notwendigen Informationen an den Cache weiter. Für schnelle Reverse-Proxy
Cache-Lösungen bietet sich z.B.
<a href="https://github.com/rtomayko/rack-cache">rack-cache</a> an:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">rack/cache</span><span style="color:#710">"</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">sinatra</span><span style="color:#710">"</span></span>

use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Cache</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  cache_control <span style="color:#A60">:public</span>, <span style="color:#A60">:max_age</span> =&gt; <span style="color:#00D">36000</span>
  sleep <span style="color:#00D">5</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hello</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Um den <code>Cache-Control</code>-Header mit Informationen zu versorgen, verwendet man die
<code>:static_cache_control</code>-Einstellung (s.u.).</p>

<p>Nach RFC 2616 sollte sich die Anwendung anders verhalten, wenn ein If-Match oder
ein If-None_match Header auf <code>*</code> gesetzt wird in Abhängigkeit davon, ob die
Resource bereits existiert. Sinatra geht davon aus, dass Ressourcen bei sicheren
Anfragen (z.B. bei get oder Idempotenten Anfragen wie put) bereits existieren,
wobei anderen Ressourcen (besipielsweise bei post), als neue Ressourcen
behandelt werden. Dieses Verhalten lässt sich mit der <code>:new_resource</code> Option
ändern:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/create</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  etag <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#710">'</span></span>, <span style="color:#A60">:new_resource</span> =&gt; <span style="color:#069">true</span>
  <span style="color:#036;font-weight:bold">Article</span>.create
  erb <span style="color:#A60">:new_article</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Soll das schwache ETag trotzdem verwendet werden, verwendet man die <code>:kind</code>
Option:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>etag <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#710">'</span></span>, <span style="color:#A60">:new_resource</span> =&gt; <span style="color:#069">true</span>, <span style="color:#A60">:kind</span> =&gt; <span style="color:#A60">:weak</span>
</pre></div>
</div>
</div>

<a name='Dateien%20versenden'></a>
<h3>Dateien versenden</h3>

<p>Zum Versenden von Dateien kann die <code>send_file</code>-Helfer-Methode verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  send_file <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo.png</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Für <code>send_file</code> stehen einige Hash-Optionen zur Verfügung:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>send_file <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo.png</span><span style="color:#710">'</span></span>, <span style="color:#A60">:type</span> =&gt; <span style="color:#A60">:jpg</span>
</pre></div>
</div>
</div>

<dl>
<dt>filename</dt>
  <dd>Dateiname als Response. Standardwert ist der eigentliche Dateiname.</dd>

  <dt>last_modified</dt>
  <dd>Wert für den Last-Modified-Header, Standardwert ist <tt>mtime</tt> der
    Datei.</dd>
  
  <dt>type</dt>
  <dd>Content-Type, der verwendet werden soll. Wird, wenn nicht angegeben, von
    der Dateiendung abgeleitet.</dd>
  
  <dt>disposition</dt>
  <dd>Verwendet für Content-Disposition. Mögliche Werte sind: <tt>nil</tt>
    (Standard), <tt>:attachment</tt> und <tt>:inline</tt>.</dd>
  
  <dt>length</dt>
  <dd>Content-Length-Header. Standardwert ist die Dateigröße.</dd>
</dl>
<p>Soweit vom Rack-Handler unterstützt, werden neben der Übertragung über den
Ruby-Prozess auch andere Möglichkeiten genutzt. Bei Verwendung der
<code>send_file</code>-Helfer-Methode kümmert sich Sinatra selbstständig um die
Range-Requests.</p>

<a name='Das%20Request-Objekt'></a>
<h3>Das Request-Objekt</h3>

<p>Auf das <code>request</code>-Objekt der eigehenden Anfrage kann vom Anfrage-Scope aus
zugegriffen werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># App läuft unter http://example.com/example</span>
get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  t = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w[</span><span style="color:#D20">text/css text/html application/javascript</span><span style="color:#710">]</span></span>
  request.accept              <span style="color:#777"># ['text/html', '*/*']</span>
  request.accept? <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">text/xml</span><span style="color:#710">'</span></span>  <span style="color:#777"># true</span>
  request.preferred_type(t)   <span style="color:#777"># 'text/html'</span>
  request.body                <span style="color:#777"># Request-Body des Client (siehe unten)</span>
  request.scheme              <span style="color:#777"># "http"</span>
  request.script_name         <span style="color:#777"># "/example"</span>
  request.path_info           <span style="color:#777"># "/foo"</span>
  request.port                <span style="color:#777"># 80</span>
  request.request_method      <span style="color:#777"># "GET"</span>
  request.query_string        <span style="color:#777"># ""</span>
  request.content_length      <span style="color:#777"># Länge des request.body</span>
  request.media_type          <span style="color:#777"># Medientypus von request.body</span>
  request.host                <span style="color:#777"># "example.com"</span>
  request.get?                <span style="color:#777"># true (ähnliche Methoden für andere Verben)</span>
  request.form_data?          <span style="color:#777"># false</span>
  request[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">irgendein_param</span><span style="color:#710">"</span></span>]  <span style="color:#777"># Wert von einem Parameter; [] ist die Kurzform für den params Hash</span>
  request.referrer            <span style="color:#777"># Der Referrer des Clients oder '/'</span>
  request.user_agent          <span style="color:#777"># User-Agent (verwendet in der :agent Bedingung)</span>
  request.cookies             <span style="color:#777"># Hash des Browser-Cookies</span>
  request.xhr?                <span style="color:#777"># Ist das hier ein Ajax-Request?</span>
  request.url                 <span style="color:#777"># "http://example.com/example/foo"</span>
  request.path                <span style="color:#777"># "/example/foo"</span>
  request.ip                  <span style="color:#777"># IP-Adresse des Clients</span>
  request.secure?             <span style="color:#777"># false (true wenn SSL)</span>
  request.forwarded?          <span style="color:#777"># true (Wenn es hinter einem Reverse-Proxy verwendet wird)</span>
  request.env                 <span style="color:#777"># vollständiger env-Hash von Rack übergeben</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Manche Optionen, wie etwa <code>script_name</code> oder <code>path_info</code>, sind auch
schreibbar:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before { request.path_info = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="color:#710">"</span></span> }

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Alle Anfragen kommen hier an!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Der <code>request.body</code> ist ein IO- oder StringIO-Objekt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>post <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/api</span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">do</span>
  request.body.rewind <span style="color:#777"># falls schon jemand davon gelesen hat</span>
  daten = <span style="color:#036;font-weight:bold">JSON</span>.parse request.body.read
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>daten[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Anh%C3%A4nge'></a>
<h3>Anhänge</h3>

<p>Damit der Browser erkennt, dass ein Response gespeichert und nicht im Browser
angezeigt werden soll, kann der <code>attachment</code>-Helfer verwendet werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  attachment
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Speichern!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Ebenso kann eine Dateiname als Parameter hinzugefügt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  attachment <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">info.txt</span><span style="color:#710">"</span></span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Speichern!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Umgang%20mit%20Datum%20und%20Zeit'></a>
<h3>Umgang mit Datum und Zeit</h3>

<p>Sinatra bietet eine <code>time_for</code>-Helfer-Methode, die aus einem gegebenen Wert ein
Time-Objekt generiert. Ebenso kann sie nach <code>DateTime</code>, <code>Date</code> und ähnliche
Klassen konvertieren:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  pass <span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Time</span>.now &gt; time_for(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dec 23, 2012</span><span style="color:#710">'</span></span>)
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">noch Zeit</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Diese Methode wird intern für +expires, <code>last_modiefied</code> und ihresgleichen
verwendet. Mit ein paar Handgriffen lässt sich diese Methode also in ihrem
Verhalten erweitern, indem man <code>time_for</code> in der eigenen Applikation 
überschreibt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">time_for</span>(value)
    <span style="color:#080;font-weight:bold">case</span> value
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#A60">:yesterday</span> <span style="color:#080;font-weight:bold">then</span> <span style="color:#036;font-weight:bold">Time</span>.now - <span style="color:#00D">24</span>*<span style="color:#00D">60</span>*<span style="color:#00D">60</span>
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#A60">:tomorrow</span>  <span style="color:#080;font-weight:bold">then</span> <span style="color:#036;font-weight:bold">Time</span>.now + <span style="color:#00D">24</span>*<span style="color:#00D">60</span>*<span style="color:#00D">60</span>
    <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">super</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  last_modified <span style="color:#A60">:yesterday</span>
  expires <span style="color:#A60">:tomorrow</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Nachschlagen%20von%20Template-Dateien'></a>
<h3>Nachschlagen von Template-Dateien</h3>

<p>Die <code>find_template</code>-Helfer-Methode wird genutzt, um Template-Dateien zum Rendern
aufzufinden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>find_template settings.views, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo</span><span style="color:#710">'</span></span>, <span style="color:#036;font-weight:bold">Tilt</span>[<span style="color:#A60">:haml</span>] <span style="color:#080;font-weight:bold">do</span> |file|
  puts <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">könnte diese hier sein: </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>file<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Das ist zwar nicht wirklich brauchbar, aber wenn man sie überschreibt, kann sie
nützlich werden, um eigene Nachschlage-Mechanismen einzubauen. Zum Beispiel
dann, wenn mehr als nur ein view-Verzeichnis verwendet werden soll:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:views</span>, [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">views</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">templates</span><span style="color:#710">'</span></span>]

helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">find_template</span>(views, name, engine, &amp;block)
    Array(views).each { |v| <span style="color:#080;font-weight:bold">super</span>(v, name, engine, &amp;block) }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Ein anderes Beispiel wäre, verschiedene Vereichnisse für verschiedene Engines
zu verwenden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:views</span>, <span style="color:#A60">:sass</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">views/sass</span><span style="color:#710">'</span></span>, <span style="color:#A60">:haml</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">templates</span><span style="color:#710">'</span></span>, <span style="color:#A60">:default</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">views</span><span style="color:#710">'</span></span>

helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">find_template</span>(views, name, engine, &amp;block)
    _, folder = views.detect { |k,v| engine == <span style="color:#036;font-weight:bold">Tilt</span>[k] }
    folder ||= views[<span style="color:#A60">:default</span>]
    <span style="color:#080;font-weight:bold">super</span>(folder, name, engine, &amp;block)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Ebensogut könnte eine Extension aber auch geschrieben und mit anderen geteilt
werden!</p>

<p>Beachte, dass <code>find_template</code> nicht prüft, ob eine Datei tatsächlich existiert.
Es wird lediglich der angegebene Block aufgerufen und nach allen möglichen
Pfaden gesucht. Das ergibt kein Performance-Problem, da <code>render</code> <code>block</code> 
verwendet, sobald eine Datei gefunden wurde. Ebenso werden Template-Pfade samt
Inhalt gecached, solange nicht im Entwicklungsmodus gearbeitet wird. Das sollte
im Hinterkopf behalten werden, wenn irgendwelche verrückten Methoden
zusammenbastelt werden.</p>

<a name='Konfiguration'></a>
<h3>Konfiguration</h3>

<p>Wird einmal beim Starten in jedweder Umgebung ausgeführt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># setze eine Option</span>
  set <span style="color:#A60">:option</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">wert</span><span style="color:#710">'</span></span>

  <span style="color:#777"># setze mehrere Optionen</span>
  set <span style="color:#A60">:a</span> =&gt; <span style="color:#00D">1</span>, <span style="color:#A60">:b</span> =&gt; <span style="color:#00D">2</span>

  <span style="color:#777"># das gleiche wie `set :option, true`</span>
  enable <span style="color:#A60">:option</span>

  <span style="color:#777"># das gleiche wie `set :option, false`</span>
  disable <span style="color:#A60">:option</span>

  <span style="color:#777"># dynamische Einstellungen mit Blöcken</span>
  set(<span style="color:#A60">:css_dir</span>) { <span style="color:#036;font-weight:bold">File</span>.join(views, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">css</span><span style="color:#710">'</span></span>) }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Läuft nur, wenn die Umgebung (RACK_ENV-Umgebungsvariable) auf <code>:production</code>
gesetzt ist:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#A60">:production</span> <span style="color:#080;font-weight:bold">do</span>
  ...
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Läuft nur, wenn die Umgebung auf <code>:production</code> oder auf <code>:test</code> gesetzt ist:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#A60">:production</span>, <span style="color:#A60">:test</span> <span style="color:#080;font-weight:bold">do</span>
  ...
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Diese Einstellungen sind über <code>settings</code> erreichbar:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#080;font-weight:bold">do</span>
  set <span style="color:#A60">:foo</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bar</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  settings.foo? <span style="color:#777"># =&gt; true</span>
  settings.foo  <span style="color:#777"># =&gt; 'bar'</span>
  ...
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Einstellung%20des%20Angriffsschutzes'></a>
<h4>Einstellung des Angriffsschutzes</h4>

<p>Sinatra verwendet
<a href="https://github.com/rkh/rack-protection#readme">Rack::Protection</a>, um die
Anwendung vor häufig vorkommenden Angriffen zu schützen. Diese Voreinstellung
lässt sich selbstverständlich deaktivieren, der damit verbundene
Geschwindigkeitszuwachs steht aber in keinem Verhätnis zu den möglichen
Risiken.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>disable <span style="color:#A60">:protection</span>
</pre></div>
</div>
</div>

<p>Um einen bestimmten Schutzmechanismus zu deaktivieren, fügt man <code>protection</code>
einen Hash mit Optionen hinzu:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:protection</span>, <span style="color:#A60">:except</span> =&gt; <span style="color:#A60">:path_traversal</span>
</pre></div>
</div>
</div>

<p>Neben Strings akzeptiert <code>:except</code> auch Arrays, um gleich mehrere
Schutzmechanismen zu deaktivieren:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:protection</span>, <span style="color:#A60">:except</span> =&gt; [<span style="color:#A60">:path_traversal</span>, <span style="color:#A60">:session_hijacking</span>]
</pre></div>
</div>
</div>
<p>#### Mögliche Einstellungen</p>

<dl>
<dt>absolute_redirects</dt>
  <dd>Wenn ausgeschaltet, wird Sinatra relative Redirects zulassen. Jedoch ist
  Sinatra dann nicht mehr mit RFC 2616 (HTTP 1.1) konform, das nur absolute
  Redirects zulässt. Sollte eingeschaltet werden, wenn die Applikation hinter
  einem Reverse-Proxy liegt, der nicht ordentlich eingerichtet ist. Beachte,
  dass die <tt>url</tt>-Helfer-Methode nach wie vor absolute URLs erstellen
  wird, es sei denn, es wird als zweiter Parameter <tt>false</tt> angegeben.
  Standardmäßig nicht aktiviert.</dd>

  <dt>add_charsets</dt>
  <dd>Mime-Types werden hier automatisch der Helfer-Methode
  <tt>content_type</tt> zugeordnet. Es empfielt sich, Werte hinzuzufügen statt
  sie zu überschreiben: <tt>settings.add_charsets &lt;&lt; "application/foobar"</tt>
  </dd>

  <dt>app_file</dt>
  <dd>Pfad zur Hauptdatei der Applikation. Wird verwendet, um das Wurzel-,
  Inline-, View- und öffentliche Verzeichnis des Projekts festzustellen.</dd>

  <dt>bind</dt>
  <dd>IP-Address, an die gebunden wird (Standardwert: <tt>0.0.0.0</tt>). Wird
  nur für den eingebauten Server verwendet.</dd>

  <dt>default_encoding</dt>
  <dd>Das Encoding, falls keines angegeben wurde. Standardwert ist
  <tt>"utf-8"</tt>.</dd>

  <dt>dump_errors</dt>
  <dd>Fehler im Log anzeigen.</dd>

  <dt>environment</dt>
  <dd>Momentane Umgebung. Standardmäßig auf <tt>content_type</tt> oder
  <tt>"development"</tt> eingestellt, soweit ersteres nicht vorhanden.</dd>

  <dt>logging</dt>
  <dd>Den Logger verwenden.</dd>

  <dt>lock</dt>
  <dd>Jeder Request wird gelocked. Es kann nur ein Request pro Ruby-Prozess
  gleichzeitig verarbeitet werden. Eingeschaltet, wenn die Applikation
  threadsicher ist. Standardmäßig nicht aktiviert.</dd>

  <dt>method_override</dt>
  <dd>Verwende <tt>_method</tt>, um put/delete-Formulardaten in Browsern zu
  verwenden, die dies normalerweise nicht unterstützen.</dd>

  <dt>port</dt>
  <dd>Port für die Applikation. Wird nur im internen Server verwendet.</dd>

  <dt>prefixed_redirects</dt>
  <dd>Entscheidet, ob <tt>request.script_name</tt> in Redirects eingefügt wird
  oder nicht, wenn kein absoluter Pfad angegeben ist. Auf diese Weise verhält
  sich <tt>redirect '/foo'</tt> so, als wäre es ein <tt>redirect
  to('/foo')</tt>. Standardmäßig nicht aktiviert.</dd>

  <dt>protection</dt>
  <dd>Legt fest, ob der Schutzmechanismus für häufig Vorkommende Webangriffe
  auf Webapplikationen aktiviert wird oder nicht. Weitere Informationen im
  vorhergehenden Abschnitt.</dd>

  <dt>public_folder</dt>
  <dd>Das öffentliche Verzeichnis, aus dem Daten zur Verfügung gestellt werden
  können. Wird nur dann verwendet, wenn statische Daten zur Verfügung gestellt
  werden können (s.u. <tt>static</tt> Option). Leitet sich von der
  <tt>app_file</tt> Einstellung ab, wenn nicht gesetzt.</dd>

  <dt>public_dir</dt>
  <dd>Alias für <tt>public_folder</tt>, s.o.</dd>

  <dt>reload_templates</dt>
  <dd>Im development-Modus aktiviert.</dd>

  <dt>root</dt>
  <dd>Wurzelverzeichnis des Projekts. Leitet sich von der <tt>app_file</tt>
  Einstellung ab, wenn nicht gesetzt.</dd>

  <dt>raise_errors</dt>
  <dd>Einen Ausnahmezustand aufrufen. Beendet die Applikation. Ist automatisch
  aktiviert, wenn die Umgebung auf <tt>"test"</tt> eingestellt ist. Ansonsten
  ist diese Option deaktiviert.</dd>

  <dt>run</dt>
  <dd>Wenn aktiviert, wird Sinatra versuchen, den Webserver zu starten. Nicht
  verwenden, wenn Rackup oder anderes verwendet werden soll.</dd>

  <dt>running</dt>
  <dd>Läuft der eingebaute Server? Diese Einstellung nicht ändern!</dd>

  <dt>server</dt>
  <dd>Server oder Liste von Servern, die als eingebaute Server zur Verfügung
  stehen. Standardmäßig auf <tt>[‘thin’, ‘mongrel’, ‘webrick’]</tt>
  voreingestellt. Die Anordnung gibt die Priorität vor.</dd>

  <dt>sessions</dt>
  <dd>Sessions auf Cookiebasis mittels
  <tt>Rack::Session::Cookie</tt>aktivieren. Für weitere Infos bitte in der
  Sektion ‘Sessions verwenden’ nachschauen.</dd>

  <dt>show_exceptions</dt>
  <dd>Bei Fehlern einen Stacktrace im Browseranzeigen. Ist automatisch
  aktiviert, wenn die Umgebung auf <tt>"development"</tt> eingestellt ist.
  Ansonsten ist diese Option deaktiviert. Kann auch auf <tt>:after_handler</tt>
  gestellt werden, um eine anwendungsspezifische Fehlerbehandlung auszulösen,
  bevor der Fehlerverlauf im Browser angezeigt wird.</dd>

  <dt>static</dt>
  <dd>Entscheidet, ob Sinatra statische Dateien zur Verfügung stellen soll oder
  nicht. Sollte nicht aktiviert werden, wenn ein Server verwendet wird, der
  dies auch selbstständig erledigen kann. Deaktivieren wird die Performance
  erhöhen. Standardmäßig aktiviert.</dd>

  <dt>static_cache_control</dt>
  <dd>Wenn Sinatra statische Daten zur Verfügung stellt, können mit dieser
  Einstellung die <tt>Cache-Control</tt> Header zu den Responses hinzugefügt
  werden. Die Einstellung verwendet dazu die <tt>cache_control</tt>
  Helfer-Methode. Standardmäßig deaktiviert. Ein Array wird verwendet, um
  mehrere Werte gleichzeitig zu übergeben: <tt>set :static_cache_control,
  [:public, :max_age =&gt; 300]</tt>
</dd>

  <dt>threaded</dt>
  <dd>Wird es auf <tt>true</tt> gesetzt, wird Thin aufgefordert
  <tt>EventMachine.defer</tt> zur Verarbeitung des Requests einzusetzen.</dd>
  
  <dt>views</dt>
  <dd>Verzeichnis der Views. Leitet sich von der <tt>app_file</tt> Einstellung
  ab, wenn nicht gesetzt.</dd>

  <dt>x_cascade</dt>
  <dd>Einstellung, ob der X-Cascade Header bei fehlender Route gesetzt wird oder
  nicht. Standardeinstellung ist <tt>true</tt>.</dd>
</dl>
<a name='Umgebungen'></a>
<h2>Umgebungen</h2>

<p>Es gibt drei voreingestellte Umgebungen in Sinatra: <code>"development"</code>,
<code>"production"</code> und <code>"test"</code>. Umgebungen können über die <code>RACK_ENV</code>
Umgebungsvariable gesetzt werden. Die Standardeinstellung ist <code>"development"</code>.
In diesem Modus werden alle Templates zwischen Requests neu geladen. Dazu gibt
es besondere Fehlerseiten für 404 Stati und Fehlermeldungen. In <code>"production"</code>
und <code>"test"</code> werden Templates automatisch gecached.</p>

<p>Um die Anwendung in einer anderen Umgebung auszuführen kann man die <code>-e</code>
Option verwenden:</p>

<pre><code>ruby my_app.rb -e [ENVIRONMENT]
</code></pre>

<p>In der Anwendung kann man die die Methoden  <code>development?</code>, <code>test?</code> und
<code>production?</code> verwenden, um die aktuelle Umgebung zu erfahren.</p>

<a name='Fehlerbehandlung'></a>
<h2>Fehlerbehandlung</h2>

<p>Error-Handler laufen in demselben Kontext wie Routen und Filter, was bedeutet,
dass alle Goodies wie <code>haml</code>, <code>erb</code>, <code>halt</code>, etc. verwendet werden können.</p>

<a name='Nicht%20gefunden'></a>
<h3>Nicht gefunden</h3>

<p>Wenn eine <code>Sinatra::NotFound</code>-Exception geworfen wird oder der Statuscode 404
ist, wird der <code>not_found</code>-Handler ausgeführt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>not_found <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Seite kann nirgendwo gefunden werden.</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Fehler'></a>
<h3>Fehler</h3>

<p>Der <code>error</code>-Handler wird immer ausgeführt, wenn eine Exception in einem
Routen-Block oder in einem Filter geworfen wurde. Die Exception kann über die
<code>sinatra.error</code>-Rack-Variable angesprochen werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Entschuldige, es gab einen hässlichen Fehler - </span><span style="color:#710">'</span></span> + env[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra.error</span><span style="color:#710">'</span></span>].name
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Benutzerdefinierte Fehler:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#036;font-weight:bold">MeinFehler</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Au weia, </span><span style="color:#710">'</span></span> + env[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra.error</span><span style="color:#710">'</span></span>].message
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Dann, wenn das passiert:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  raise <span style="color:#036;font-weight:bold">MeinFehler</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">etwas Schlimmes ist passiert</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>bekommt man dieses:</p>

<pre><code>Au weia, etwas Schlimmes ist passiert
</code></pre>

<p>Alternativ kann ein Error-Handler auch für einen Status-Code definiert werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#00D">403</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Zugriff verboten</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/geheim</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#00D">403</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Oder ein Status-Code-Bereich:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#00D">400</span>..<span style="color:#00D">510</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo?</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Sinatra setzt verschiedene <code>not_found</code>- und <code>error</code>-Handler in der
Development-Umgebung ein, um hilfreiche Debugging Informationen und Stack Traces
anzuzeigen.</p>

<a name='Rack-Middleware'></a>
<h2>Rack-Middleware</h2>

<p>Sinatra baut auf <a href="http://rack.rubyforge.org/">Rack</a>, einem minimalistischen
Standard-Interface für Ruby-Webframeworks. Eines der interessantesten Features
für Entwickler ist der Support von Middlewares, die zwischen den Server und
die Anwendung geschaltet werden und so HTTP-Request und/oder Antwort
überwachen und/oder manipulieren können.</p>

<p>Sinatra macht das Erstellen von Middleware-Verkettungen mit der
Top-Level-Methode <code>use</code> zu einem Kinderspiel:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">meine_middleware</span><span style="color:#710">'</span></span>

use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Lint</span>
use <span style="color:#036;font-weight:bold">MeineMiddleware</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/hallo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo Welt</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Die Semantik von <code>use</code> entspricht der gleichnamigen Methode der
<a href="http://rack.rubyforge.org/doc/classes/Rack/Builder.html">Rack::Builder</a>-DSL
(meist verwendet in Rackup-Dateien). Ein Beispiel dafür ist, dass die
<code>use</code>-Methode mehrere/verschiedene Argumente und auch Blöcke entgegennimmt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Auth</span>::<span style="color:#036;font-weight:bold">Basic</span> <span style="color:#080;font-weight:bold">do</span> |username, password|
  username == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">admin</span><span style="color:#710">'</span></span> &amp;&amp; password == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">geheim</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Rack bietet eine Vielzahl von Standard-Middlewares für Logging, Debugging,
URL-Routing, Authentifizierung und Session-Verarbeitung. Sinatra verwendet
viele von diesen Komponenten automatisch, abhängig von der Konfiguration. So
muss <code>use</code> häufig nicht explizit verwendet werden.</p>

<p>Hilfreiche Middleware gibt es z.B. hier:
<a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>,
<a href="https://github.com/rack/rack-contrib#readme">rack-contrib</a>, mit
<a href="http://coderack.org/">CodeRack</a> oder im <a href="https://github.com/rack/rack/wiki/List-of-Middleware">Rack
wiki</a>.</p>

<a name='Testen'></a>
<h2>Testen</h2>

<p>Sinatra-Tests können mit jedem auf Rack aufbauendem Test-Framework geschrieben
werden. <a href="http://rdoc.info/github/brynary/rack-test/master/frames">Rack::Test</a>
wird empfohlen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">my_sinatra_app</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test/unit</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rack/test</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyAppTest</span> &lt; <span style="color:#036;font-weight:bold">Test</span>::<span style="color:#036;font-weight:bold">Unit</span>::<span style="color:#036;font-weight:bold">TestCase</span>
  include <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Test</span>::<span style="color:#036;font-weight:bold">Methods</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">app</span>
    <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Application</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_my_default</span>
    get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>
    assert_equal <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo Welt!</span><span style="color:#710">'</span></span>, last_response.body
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_with_params</span>
    get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/meet</span><span style="color:#710">'</span></span>, <span style="color:#A60">:name</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Frank</span><span style="color:#710">'</span></span>
    assert_equal <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo Frank!</span><span style="color:#710">'</span></span>, last_response.body
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_with_rack_env</span>
    get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, {}, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">HTTP_USER_AGENT</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Songbird</span><span style="color:#710">'</span></span>
    assert_equal <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Du verwendest Songbird!</span><span style="color:#710">"</span></span>, last_response.body
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Hinweis: Wird Sinatra modular verwendet, muss <tt>Sinatra::Application</tt> mit
dem Namen der Applikations-Klasse ersetzt werden.</p>

<a name='Sinatra::Base%20-%20Middleware,%20Bibliotheken%20und%20modulare%20Anwendungen'></a>
<h2>Sinatra::Base - Middleware, Bibliotheken und modulare Anwendungen</h2>

<p>Das Definieren einer Top-Level-Anwendung funktioniert gut für
Mikro-Anwendungen, hat aber Nachteile, wenn wiederverwendbare Komponenten wie
Middleware, Rails Metal, einfache Bibliotheken mit Server-Komponenten oder
auch Sinatra-Erweiterungen geschrieben werden sollen.</p>

<p>Das Top-Level geht von einer Konfiguration für eine Mikro-Anwendung aus (wie
sie z.B. bei einer einzelnen Anwendungsdatei, <code>./public</code> und <code>./views</code> Ordner,
Logging, Exception-Detail-Seite, usw.). Genau hier kommt <code>Sinatra::Base</code> ins
Spiel:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  set <span style="color:#A60">:sessions</span>, <span style="color:#069">true</span>
  set <span style="color:#A60">:foo</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bar</span><span style="color:#710">'</span></span>

  get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo Welt!</span><span style="color:#710">'</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Die MyApp-Klasse ist eine unabhängige Rack-Komponente, die als Middleware,
Endpunkt oder via Rails Metal verwendet werden kann. Verwendet wird sie durch
<code>use</code> oder <code>run</code> von einer Rackup-<code>config.ru</code>-Datei oder als Server-Komponente
einer Bibliothek:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">MyApp</span>.run! <span style="color:#A60">:host</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">localhost</span><span style="color:#710">'</span></span>, <span style="color:#A60">:port</span> =&gt; <span style="color:#00D">9090</span>
</pre></div>
</div>
</div>

<p>Die Methoden der <code>Sinatra::Base</code>-Subklasse sind genau dieselben wie die der
Top-Level-DSL. Die meisten Top-Level-Anwendungen können mit nur zwei
Veränderungen zu <code>Sinatra::Base</code> konvertiert werden:</p>

<ul>
<li>Die Datei sollte <code>require 'sinatra/base'</code> anstelle von <code>require
'sinatra/base'</code> aufrufen, ansonsten werden alle von Sinatras DSL-Methoden
in den Top-Level-Namespace importiert.</li>
  <li>Alle Routen, Error-Handler, Filter und Optionen der Applikation müssen in
einer Subklasse von <code>Sinatra::Base</code> definiert werden.</li>
</ul>
<p><code>Sinatra::Base</code> ist ein unbeschriebenes Blatt. Die meisten Optionen sind per
Standard deaktiviert. Das betrifft auch den eingebauten Server. Siehe
<a href="http://sinatra.github.com/configuration.html">Optionen und Konfiguration</a> für
Details über mögliche Optionen.</p>

<a name='Modularer%20vs.%20klassischer%20Stil'></a>
<h3>Modularer vs. klassischer Stil</h3>

<p>Entgegen häufiger Meinungen gibt es nichts gegen den klassischen Stil
einzuwenden. Solange es die Applikation nicht beeinträchtigt, besteht kein
Grund, eine modulare Applikation zu erstellen.</p>

<p>Der größte Nachteil der klassischen Sinatra Anwendung gegenüber einer
modularen ist die Einschränkung auf eine Sinatra Anwendung pro Ruby-Prozess.
Sollen mehrere zum Einsatz kommen, muss auf den modularen Stil umgestiegen
werden. Dabei ist es kein Problem klassische und modulare Anwendungen
miteinander zu vermischen.</p>

<p>Bei einem Umstieg, sollten einige Unterschiede in den Einstellungen beachtet
werden:</p>

<table>
<tr>
<th>Szenario</th>
    <th>Classic</th>
    <th>Modular</th>
  </tr>
<tr>
<td>app_file</td>
    <td>Sinatra ladende Datei</td>
    <td>Sinatra::Base subklassierende Datei</td>
  </tr>
<tr>
<td>run</td>
    <td>$0 == app_file</td>
    <td>false</td>
  </tr>
<tr>
<td>logging</td>
    <td>true</td>
    <td>false</td>
  </tr>
<tr>
<td>method_override</td>
    <td>true</td>
    <td>false</td>
  </tr>
<tr>
<td>inline_templates</td>
    <td>true</td>
    <td>false</td>
  </tr>
<tr>
<td>static</td>
    <td>true</td>
    <td>false</td>
  </tr>
</table>
<a name='Eine%20modulare%20Applikation%20bereitstellen'></a>
<h3>Eine modulare Applikation bereitstellen</h3>

<p>Es gibt zwei übliche Wege, eine modulare Anwendung zu starten. Zum einen über
<code>run!</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># mein_app.rb</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MeinApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># ... Anwendungscode hierhin ...</span>

  <span style="color:#777"># starte den Server, wenn die Ruby-Datei direkt ausgeführt wird</span>
  run! <span style="color:#080;font-weight:bold">if</span> app_file == <span style="color:#d70">$0</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Starte mit:</p>

<pre><code>ruby mein_app.rb
</code></pre>

<p>Oder über eine <code>config.ru</code>-Datei, die es erlaubt, einen beliebigen
Rack-Handler zu verwenden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># config.ru (mit rackup starten)</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">./mein_app</span><span style="color:#710">'</span></span>
run <span style="color:#036;font-weight:bold">MeineApp</span>
</pre></div>
</div>
</div>

<p>Starte:</p>

<pre><code>rackup -p 4567
</code></pre>

<a name='Eine%20klassische%20Anwendung%20mit%20einer%20config.ru%20verwenden'></a>
<h3>Eine klassische Anwendung mit einer config.ru verwenden</h3>

<p>Schreibe eine Anwendungsdatei:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># app.rb</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hallo Welt!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>sowie eine dazugehörige <code>config.ru</code>-Datei:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">./app</span><span style="color:#710">'</span></span>
run <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Application</span>
</pre></div>
</div>
</div>

<a name='Wann%20sollte%20eine%20config.ru-Datei%20verwendet%20werden?'></a>
<h3>Wann sollte eine config.ru-Datei verwendet werden?</h3>

<p>Anzeichen dafür, dass eine <code>config.ru</code>-Datei gebraucht wird:</p>

<ul>
<li>Es soll ein anderer Rack-Handler verwendet werden (Passenger, Unicorn,
Heroku, …).</li>
  <li>Es gibt mehr als nur eine Subklasse von <code>Sinatra::Base</code>.</li>
  <li>Sinatra soll als Middleware verwendet werden, nicht als Endpunkt.</li>
</ul>
<p><strong>Es gibt keinen Grund, eine <code>config.ru</code>-Datei zu verwenden, nur weil eine
Anwendung im modularen Stil betrieben werden soll. Ebenso wird keine Anwendung
mit modularem Stil benötigt, um eine <code>config.ru</code>-Datei zu verwenden.</strong></p>

<a name='Sinatra%20als%20Middleware%20nutzen'></a>
<h3>Sinatra als Middleware nutzen</h3>

<p>Es ist nicht nur möglich, andere Rack-Middleware mit Sinatra zu nutzen, es
kann außerdem jede Sinatra-Anwendung selbst als Middleware vor jeden
beliebigen Rack-Endpunkt gehangen werden. Bei diesem Endpunkt muss es sich
nicht um eine andere Sinatra-Anwendung handeln, es kann jede andere
Rack-Anwendung sein (Rails/Ramaze/Camping/…):</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LoginScreen</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  enable <span style="color:#A60">:sessions</span>

  get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/login</span><span style="color:#710">'</span></span>) { haml <span style="color:#A60">:login</span> }

  post(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/login</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">if</span> params[<span style="color:#A60">:name</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">admin</span><span style="color:#710">'</span></span> &amp;&amp; params[<span style="color:#A60">:password</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">admin</span><span style="color:#710">'</span></span>
      session[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user_name</span><span style="color:#710">'</span></span>] = params[<span style="color:#A60">:name</span>]
    <span style="color:#080;font-weight:bold">else</span>
      redirect <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/login</span><span style="color:#710">'</span></span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># Middleware wird vor Filtern ausgeführt</span>
  use <span style="color:#036;font-weight:bold">LoginScreen</span>

  before <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">unless</span> session[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user_name</span><span style="color:#710">'</span></span>]
      halt <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Zugriff verweigert, bitte &lt;a href='/login'&gt;einloggen&lt;/a&gt;.</span><span style="color:#710">"</span></span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hallo </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>session[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user_name</span><span style="color:#710">'</span></span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">.</span><span style="color:#710">"</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Dynamische%20Applikationserstellung'></a>
<h3>Dynamische Applikationserstellung</h3>

<p>Manche Situationen erfordern die Erstellung neuer Applikationen zur Laufzeit,
ohne dass sie einer Konstanten zugeordnet werden. Dies lässt sich mit
<code>Sinatra.new</code> erreichen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>
my_app = <span style="color:#036;font-weight:bold">Sinatra</span>.new { get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hallo</span><span style="color:#710">"</span></span> } }
my_app.run!
</pre></div>
</div>
</div>

<p>Die Applikation kann mit Hilfe eines optionalen Parameters erstellt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># config.ru</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

controller = <span style="color:#036;font-weight:bold">Sinatra</span>.new <span style="color:#080;font-weight:bold">do</span>
  enable <span style="color:#A60">:logging</span>
  helpers <span style="color:#036;font-weight:bold">MyHelpers</span>
<span style="color:#080;font-weight:bold">end</span>

map(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/a</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
  run <span style="color:#036;font-weight:bold">Sinatra</span>.new(controller) { get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">a</span><span style="color:#710">'</span></span> } }
<span style="color:#080;font-weight:bold">end</span>

map(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/b</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
  run <span style="color:#036;font-weight:bold">Sinatra</span>.new(controller) { get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">b</span><span style="color:#710">'</span></span> } }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Das ist besonders dann interessant, wenn Sinatra-Erweiterungen getestet werden
oder Sinatra in einer Bibliothek Verwendung findet.</p>

<p>Ebenso lassen sich damit hervorragend Sinatra-Middlewares erstellen:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

use <span style="color:#036;font-weight:bold">Sinatra</span> <span style="color:#080;font-weight:bold">do</span>
  get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { ... }
<span style="color:#080;font-weight:bold">end</span>

run <span style="color:#036;font-weight:bold">RailsProject</span>::<span style="color:#036;font-weight:bold">Application</span>
</pre></div>
</div>
</div>

<a name='Geltungsbereich%20und%20Bindung'></a>
<h2>Geltungsbereich und Bindung</h2>

<p>Der Geltungsbereich (Scope) legt fest, welche Methoden und Variablen zur
Verfügung stehen.</p>

<a name='Anwendungs-%20oder%20Klassen-Scope'></a>
<h3>Anwendungs- oder Klassen-Scope</h3>

<p>Jede Sinatra-Anwendung entspricht einer <code>Sinatra::Base</code>-Subklasse. Falls die
Top- Level-DSL verwendet wird (<code>require 'sinatra'</code>), handelt es sich um
<code>Sinatra::Application</code>, andernfalls ist es jene Subklasse, die explizit
angelegt wurde. Auf Klassenebene stehen Methoden wie <code>get</code> oder <code>before</code> zur
Verfügung, es gibt aber keinen Zugriff auf das <code>request</code>-Object oder die
<code>session</code>, da nur eine einzige Klasse für alle eingehenden Anfragen genutzt
wird.</p>

<p>Optionen, die via <code>set</code> gesetzt werden, sind Methoden auf Klassenebene:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># Hey, ich bin im Anwendungsscope!</span>
  set <span style="color:#A60">:foo</span>, <span style="color:#00D">42</span>
  foo <span style="color:#777"># =&gt; 42</span>

  get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#777"># Hey, ich bin nicht mehr im Anwendungs-Scope!</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Im Anwendungs-Scope befindet man sich:</p>

<ul>
<li>In der Anwendungs-Klasse.</li>
  <li>In Methoden, die von Erweiterungen definiert werden.</li>
  <li>Im Block, der an <code>helpers</code> übergeben wird.</li>
  <li>In Procs und Blöcken, die an <code>set</code> übergeben werden.</li>
  <li>Der an <code>Sinatra.new</code> übergebene Block</li>
</ul>
<p>Auf das Scope-Objekt (die Klasse) kann wie folgt zugegriffen werden:</p>

<ul>
<li>Über das Objekt, das an den <code>configure</code>-Block übergeben wird (<code>configure {
|c| ... }</code>).</li>
  <li>
<code>settings</code> aus den anderen Scopes heraus.</li>
</ul>
<a name='Anfrage-%20oder%20Instanz-Scope'></a>
<h3>Anfrage- oder Instanz-Scope</h3>

<p>Für jede eingehende Anfrage wird eine neue Instanz der Anwendungs-Klasse
erstellt und alle Handler in diesem Scope ausgeführt. Aus diesem Scope heraus
kann auf <code>request</code> oder <code>session</code> zugegriffen und Methoden wie <code>erb</code> oder
<code>haml</code> aufgerufen werden. Außerdem kann mit der <code>settings</code>-Method auf den
Anwendungs-Scope zugegriffen werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># Hey, ich bin im Anwendungs-Scope!</span>
  get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/neue_route/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#777"># Anfrage-Scope für '/neue_route/:name'</span>
    <span style="color:#33B">@value</span> = <span style="color:#00D">42</span>

    settings.get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:name</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#777"># Anfrage-Scope für "/#{params[:name]}"</span>
      <span style="color:#33B">@value</span> <span style="color:#777"># =&gt; nil (nicht dieselbe Anfrage)</span>
    <span style="color:#080;font-weight:bold">end</span>

    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Route definiert!</span><span style="color:#710">"</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Im Anfrage-Scope befindet man sich:</p>

<ul>
<li>In get/head/post/put/delete-Blöcken</li>
  <li>In before/after-Filtern</li>
  <li>In Helfer-Methoden</li>
  <li>In Templates</li>
</ul>
<a name='Delegation-Scope'></a>
<h3>Delegation-Scope</h3>

<p>Vom Delegation-Scope aus werden Methoden einfach an den Klassen-Scope
weitergeleitet. Dieser verhält sich jedoch nicht 100%ig wie der Klassen-Scope,
da man nicht die Bindung der Klasse besitzt: Nur Methoden, die explizit als
delegierbar markiert wurden, stehen hier zur Verfügung und es kann nicht auf
die Variablen des Klassenscopes zugegriffen werden (mit anderen Worten: es
gibt ein anderes <code>self</code>). Weitere Delegationen können mit
<code>Sinatra::Delegator.delegate :methoden_name</code> hinzugefügt werden.</p>

<p>Im Delegation-Scop befindet man sich:</p>

<ul>
<li>Im Top-Level, wenn <code>require 'sinatra'</code> aufgerufen wurde.</li>
  <li>In einem Objekt, das mit dem <code>Sinatra::Delegator</code>-Mixin erweitert wurde.</li>
</ul>
<p>Schau am besten im Code nach: Hier ist <a href="http://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb#L1064">Sinatra::Delegator
mixin</a> definiert und wird in den [globalen Namespace
eingebunden](http://github.com/sinatra/sinatra/blob/master/lib/sinatra/main.rb</p>

<a name='Kommandozeile'></a>
<h2>Kommandozeile</h2>

<p>Sinatra-Anwendungen können direkt von der Kommandozeile aus gestartet werden:</p>

<pre><code>ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-h HOST] [-s HANDLER]
</code></pre>

<p>Die Optionen sind:</p>

<pre><code>-h # Hilfe
-p # Port setzen (Standard ist 4567)
-h # Host setzen (Standard ist 0.0.0.0)
-e # Umgebung setzen (Standard ist development)
-s # Rack-Server/Handler setzen (Standard ist thin)
-x # Mutex-Lock einschalten (Standard ist off)
</code></pre>

<a name='Systemanforderungen'></a>
<h2>Systemanforderungen</h2>

<p>Die folgenden Versionen werden offiziell unterstützt:</p>

<dl>
<dt>Ruby 1.8.7</dt>
  <dd>1.8.7 wird vollständig unterstützt, aber solange nichts dagegen spricht,
  wird ein Update auf 1.9.2 oder ein Umstieg auf JRuby/Rubinius empfohlen.
  Unterstützung für 1.8.7 wird es mindestens bis Sinatra 2.0 und Ruby 2.0
  geben, es sei denn, dass der unwahrscheinliche Fall eintritt und 1.8.8
  rauskommt. Doch selbst dann ist es eher wahrscheinlich, dass 1.8.7 weiterhin
  unterstützt wird. <b>Ruby 1.8.6 wird nicht mehr unterstützt.</b> Soll Sinatra
  unter 1.8.6 eingesetzt werden, muss Sinatra 1.2 verwendet werden, dass noch
  bis zum Release von Sinatra 1.4.0 fortgeführt wird.</dd>

  <dt>Ruby 1.9.2</dt>
  <dd>1.9.2 wird voll unterstützt und empfohlen. Version 1.9.2p0 sollte nicht
  verwendet werden, da unter Sinatra immer wieder Segfaults auftreten.
  Unterstützung wird es mindestens bis zum Release von Ruby 1.9.4/2.0 geben und
  das letzte Sinatra Release für 1.9 wird so lange unterstützt, wie das Ruby
  Core-Team 1.9 pflegt.</dd>

  <dt>Ruby 1.9.3</dt>
  <dd>1.9.3 wird vollständig unterstützt und empfohlen. Achtung, bei einem
  Wechsel zu 1.9.3 werden alle Sessions ungültig.</dd>

  <dt>Rubinius</dt>
  <dd>Rubinius (rbx &gt;= 1.2.4) wird offiziell unter Einbezug aller Templates
  unterstützt. Die kommende 2.0 Version wird ebenfalls unterstützt, samt 1.9
  Modus.</dd>

  <dt>JRuby</dt>
  <dd>JRuby wird offiziell unterstützt (JRuby &gt;= 1.6.7). Probleme mit
  Template- Bibliotheken Dritter sind nicht bekannt. Falls JRuby zum Einsatz
  kommt, sollte aber darauf geachtet werden, dass ein JRuby-Rack-Handler zum
  Einsatz kommt – die Thin und Mongrel Web-Server werden bisher nicht
  unterstütz. JRubys Unterstützung für C-Erweiterungen sind zur Zeit ebenfalls
  experimenteller Natur, betrifft im Moment aber nur die RDiscount, Redcarpet,
  RedCloth und [[Yajl]] Templates.</dd>
</dl>
<p>Weiterhin werden wir die kommende Ruby-Versionen im Auge behalten.</p>

<p>Die nachfolgend aufgeführten Ruby-Implementierungen werden offiziell nicht von
Sinatra unterstützt, funktionieren aber normalerweise:</p>

<ul>
<li>Ruby Enterprise Edition</li>
  <li>Ältere Versionen von JRuby und Rubinius</li>
  <li>MacRuby, Maglev, IronRuby</li>
  <li>Ruby 1.9.0 und 1.9.1 (wird jedoch nicht empfohlen, s.o.)</li>
</ul>
<p>Nicht offiziell unterstützt bedeutet, dass wenn Sachen nicht funktionieren,
wir davon ausgehen, dass es nicht an Sinatra sondern an der jeweiligen
Implentierung liegt.</p>

<p>Im Rahmen unserer CI (Kontinuierlichen Integration) wird bereits ruby-head
(das kommende Ruby 2.0.0) und 1.9.4 mit eingebunden. Da noch alles im Fluss
ist, kann zur Zeit für nichts garantiert werden. Es kann aber erwartet werden,
dass Ruby 2.0.0p0 und 1.9.4p0 von Sinatra unterstützt werden wird.</p>

<p>Sinatra sollte auf jedem Betriebssystem laufen, dass den gewählten Ruby-
Interpreter unterstützt.</p>

<p>Sinatra wird aktuell nicht unter Cardinal, SmallRuby, BleuRuby oder
irgendeiner  Version von Ruby vor 1.8.7 laufen.</p>

<a name='Der%20neuste%20Stand%20(The%20Bleeding%20Edge)'></a>
<h2>Der neuste Stand (The Bleeding Edge)</h2>

<p>Um auf dem neusten Stand zu bleiben, kann der Master-Branch verwendet werden.
Er sollte recht stabil sein. Ebenso gibt es von Zeit zu Zeit prerelease Gems,
die so installiert werden:</p>

<pre><code>gem install sinatra --pre
</code></pre>

<a name='Mit%20Bundler'></a>
<h3>Mit Bundler</h3>

<p>Wenn die Applikation mit der neuesten Version von Sinatra und
<a href="http://gembundler.com/">Bundler</a> genutzt werden soll, empfehlen wir den
nachfolgenden Weg.</p>

<p>Soweit Bundler noch nicht installiert ist:</p>

<pre><code>gem install bundler
</code></pre>

<p>Anschließend wird eine <code>Gemfile</code>-Datei im Projektverzeichnis mit folgendem
Inhalt erstellt:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>source <span style="color:#A60">:rubygems</span>
gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>, <span style="color:#A60">:git</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">git://github.com/sinatra/sinatra.git</span><span style="color:#710">"</span></span>

<span style="color:#777"># evtl. andere Abhängigkeiten</span>
gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">haml</span><span style="color:#710">'</span></span>                    <span style="color:#777"># z.B. wenn du Haml verwendest...</span>
gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">activerecord</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">~&gt; 3.0</span><span style="color:#710">'</span></span>  <span style="color:#777"># ...oder ActiveRecord 3.x</span>
</pre></div>
</div>
</div>

<p>Beachte: Hier sollten alle Abhängigkeiten eingetragen werden. Sinatras eigene,
direkte Abhängigkeiten (Tilt und Rack) werden von Bundler automatisch aus dem
Gemfile von Sinatra hinzugefügt.</p>

<p>Jetzt kannst du deine Applikation starten:</p>

<pre><code>bundle exec ruby myapp.rb
</code></pre>

<a name='Eigenes%20Repository'></a>
<h3>Eigenes Repository</h3>
<p>Um auf dem neuesten Stand von Sinatras Code zu sein, kann eine lokale Kopie
angelegt werden. Gestartet wird in der Anwendung mit dem <code>sinatra/lib</code>- Ordner
im <code>LOAD_PATH</code>:</p>

<pre><code>cd myapp
git clone git://github.com/sinatra/sinatra.git
ruby -Isinatra/lib myapp.rb
</code></pre>

<p>Alternativ kann der <code>sinatra/lib</code>-Ordner zum <code>LOAD_PATH</code> in der Anwendung
hinzugefügt werden:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#d70">$LOAD_PATH</span>.unshift <span style="color:#036;font-weight:bold">File</span>.dirname(<span style="color:#069">__FILE__</span>) + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/sinatra/lib</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rubygems</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/ueber</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Ich laufe auf Version </span><span style="color:#710">"</span></span> + <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">VERSION</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Um Sinatra-Code von Zeit zu Zeit zu aktualisieren:</p>

<pre><code>cd myproject/sinatra
git pull
</code></pre>

<a name='Gem%20erstellen'></a>
<h3>Gem erstellen</h3>

<p>Aus der eigenen lokalen Kopie kann nun auch ein globales Gem gebaut werden:</p>

<pre><code>git clone git://github.com/sinatra/sinatra.git
cd sinatra
rake sinatra.gemspec
rake install
</code></pre>

<p>Falls Gems als Root installiert werden sollen, sollte die letzte Zeile
folgendermaßen lauten:</p>

<pre><code>sudo rake install
</code></pre>

<a name='Versions-Verfahren'></a>
<h2>Versions-Verfahren</h2>

<p>Sinatra folgt dem sogenannten <a href="http://semver.org/">Semantic Versioning</a>, d.h.
SemVer und SemVerTag.</p>

<a name='Mehr'></a>
<h2>Mehr</h2>

<ul>
<li>
<a href="http://sinatra.github.com/">Projekt-Website</a> - Ergänzende Dokumentation,
News und Links zu anderen Ressourcen.</li>
  <li>
<a href="http://sinatra.github.com/contributing.html">Mitmachen</a> - Einen Fehler
gefunden? Brauchst du Hilfe? Hast du einen Patch?</li>
  <li><a href="http://github.com/sinatra/sinatra/issues">Issue-Tracker</a></li>
  <li><a href="http://twitter.com/sinatra">Twitter</a></li>
  <li><a href="http://groups.google.com/group/sinatrarb">Mailing-Liste</a></li>
  <li>
<a href="irc://chat.freenode.net/#sinatra"> #sinatra</a> auf http://freenode.net</li>
  <li>
<a href="http://sinatra-book.gittr.com">Sinatra Book</a> Kochbuch Tutorial</li>
  <li>
<a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> Sinatra-Rezepte aus der
Community</li>
  <li>API Dokumentation für die <a href="http://rubydoc.info/gems/sinatra">aktuelle
Version</a> oder für
<a href="http://rubydoc.info/github/sinatra/sinatra">HEAD</a> auf http://rubydoc.info</li>
  <li><a href="http://travis-ci.org/sinatra/sinatra">CI Server</a></li>
</ul>
</body></html>
