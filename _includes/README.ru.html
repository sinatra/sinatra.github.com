<div class='toc'>
	<ol class='level-1'>
		<li><a href='#%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D1%8B'>Маршруты</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%A3%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F'>Условия</a></li>
			<li><a href='#%D0%92%D0%BE%D0%B7%D0%B2%D1%80%D0%B0%D1%89%D0%B0%D0%B5%D0%BC%D1%8B%D0%B5%20%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D1%8F'>Возвращаемые значения</a></li>
			<li><a href='#%D0%A1%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B4%D0%B5%D1%82%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D1%8B%20%D1%81%D0%BE%D0%B2%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B9%20%D0%B4%D0%BB%D1%8F%20%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%BE%D0%B2'>Собственные детекторы совпадений для маршрутов</a></li>
		</ol>
		<li><a href='#%D0%A1%D1%82%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5%20%D1%84%D0%B0%D0%B9%D0%BB%D1%8B'>Статические файлы</a></li>
		<li><a href='#%D0%9F%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20/%20%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Представления / Шаблоны</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%91%D1%83%D0%BA%D0%B2%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Буквальные шаблоны</a></li>
			<li><a href='#%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%82%D0%BE%D1%80%D1%8B'>Доступные шаблонизаторы</a></li>
			<ol class='level-3'>
				<li><a href='#Haml%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Haml шаблоны</a></li>
				<li><a href='#Erb%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Erb шаблоны</a></li>
				<li><a href='#Builder%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Builder шаблоны</a></li>
				<li><a href='#Nokogiri%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Nokogiri шаблоны</a></li>
				<li><a href='#Sass%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Sass шаблоны</a></li>
				<li><a href='#SCSS%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>SCSS шаблоны</a></li>
				<li><a href='#Less%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Less шаблоны</a></li>
				<li><a href='#Liquid%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Liquid шаблоны</a></li>
				<li><a href='#Markdown%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Markdown шаблоны</a></li>
				<li><a href='#Textile%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Textile шаблоны</a></li>
				<li><a href='#RDoc%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>RDoc шаблоны</a></li>
				<li><a href='#AsciiDoc%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>AsciiDoc шаблоны</a></li>
				<li><a href='#Radius%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Radius шаблоны</a></li>
				<li><a href='#Markaby%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Markaby шаблоны</a></li>
				<li><a href='#RABL%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>RABL шаблоны</a></li>
				<li><a href='#Slim%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Slim шаблоны</a></li>
				<li><a href='#Creole%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Creole шаблоны</a></li>
				<li><a href='#MediaWiki%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>MediaWiki шаблоны</a></li>
				<li><a href='#CoffeeScript%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>CoffeeScript шаблоны</a></li>
				<li><a href='#Yajl%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Yajl шаблоны</a></li>
				<li><a href='#WLang%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>WLang шаблоны</a></li>
			</ol>
			<li><a href='#%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%20%D0%BA%20%D0%BF%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%20%D0%B2%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%D1%85'>Доступ к переменным в шаблонах</a></li>
			<li><a href='#%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B%20%D1%81%20%3Ccode%3Eyield%3C/code%3E%20%D0%B8%20%D0%B2%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%80%D0%B0%D1%81%D0%BA%D0%BB%D0%B0%D0%B4%D0%BA%D0%B8%20(layout)'>Шаблоны с <code>yield</code> и вложенные раскладки (layout)</a></li>
			<li><a href='#%D0%92%D0%BA%D0%BB%D1%8E%D1%87%D1%91%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Включённые шаблоны</a></li>
			<li><a href='#%D0%98%D0%BC%D0%B5%D0%BD%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'>Именованные шаблоны</a></li>
			<li><a href='#%D0%9F%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0%20%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D1%85%20%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%B8%D0%B9'>Привязка файловых расширений</a></li>
			<li><a href='#%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0%20%D1%80%D0%B5%D0%BD%D0%B4%D0%B5%D1%80%D0%B8%D0%BD%D0%B3%D0%B0'>Добавление собственного движка рендеринга</a></li>
		</ol>
		<li><a href='#%D0%A4%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B'>Фильтры</a></li>
		<li><a href='#%D0%9C%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D0%BD%D0%B8%D0%BA%D0%B8'>Методы-помощники</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B5%D1%81%D1%81%D0%B8%D0%B9'>Использование сессий</a></li>
			<li><a href='#%D0%9F%D1%80%D0%B5%D1%80%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5'>Прерывание</a></li>
			<li><a href='#%D0%9F%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B0'>Передача</a></li>
			<li><a href='#%D0%92%D1%8B%D0%B7%D0%BE%D0%B2%20%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B3%D0%BE%20%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B0'>Вызов другого маршрута</a></li>
			<li><a href='#%D0%97%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%82%D0%B5%D0%BB%D0%B0,%20%D0%BA%D0%BE%D0%B4%D0%B0%20%D0%B8%20%D0%B7%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BA%D0%BE%D0%B2%20%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%B0'>Задание тела, кода и заголовков ответа</a></li>
			<li><a href='#%D0%A1%D1%82%D1%80%D0%B8%D0%BC%D0%B8%D0%BD%D0%B3%20%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%BE%D0%B2'>Стриминг ответов</a></li>
			<li><a href='#%D0%9B%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5'>Логирование</a></li>
			<li><a href='#Mime-%D1%82%D0%B8%D0%BF%D1%8B'>Mime-типы</a></li>
			<li><a href='#%D0%93%D0%B5%D0%BD%D0%B5%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20URL'>Генерирование URL</a></li>
			<li><a href='#%D0%9F%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20(%D1%80%D0%B5%D0%B4%D0%B8%D1%80%D0%B5%D0%BA%D1%82)'>Перенаправление (редирект)</a></li>
			<li><a href='#%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BA%D1%8D%D1%88%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC'>Управление кэшированием</a></li>
			<li><a href='#%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0%20%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2'>Отправка файлов</a></li>
			<li><a href='#%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%20%D0%BA%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D1%83%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0'>Доступ к объекту запроса</a></li>
			<li><a href='#%D0%92%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F'>Вложения</a></li>
			<li><a href='#%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%20%D1%81%D0%BE%20%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B5%D0%BC%20%D0%B8%20%D0%B4%D0%B0%D1%82%D0%B0%D0%BC%D0%B8'>Работа со временем и датами</a></li>
			<li><a href='#%D0%9F%D0%BE%D0%B8%D1%81%D0%BA%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%BE%D0%B2'>Поиск шаблонов</a></li>
		</ol>
		<li><a href='#%D0%9A%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F'>Конфигурация</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D1%8B%20%D0%BE%D1%82%20%D0%B0%D1%82%D0%B0%D0%BA'>Настройка защиты от атак</a></li>
			<li><a href='#%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D1%8B%D0%B5%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8'>Доступные настройки</a></li>
		</ol>
		<li><a href='#%D0%A0%D0%B5%D0%B6%D0%B8%D0%BC,%20%D0%BE%D0%BA%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5'>Режим, окружение</a></li>
		<li><a href='#%D0%9E%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0%20%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA'>Обработка ошибок</a></li>
		<ol class='level-2'>
			<li><a href='#Not%20Found'>Not Found</a></li>
			<li><a href='#%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B8'>Ошибки</a></li>
		</ol>
		<li><a href='#Rack%20%E2%80%9C%D0%BF%D1%80%D0%BE%D1%81%D0%BB%D0%BE%D0%B9%D0%BA%D0%B8%E2%80%9D'>Rack “прослойки”</a></li>
		<li><a href='#%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5'>Тестирование</a></li>
		<li><a href='#Sinatra::Base%20%E2%80%94%20%E2%80%9C%D0%BF%D1%80%D0%BE%D1%81%D0%BB%D0%BE%D0%B9%D0%BA%D0%B8%E2%80%9D,%20%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8%20%D0%B8%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F'>Sinatra::Base — “прослойки”, библиотеки и модульные приложения</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%BF%D1%80%D0%BE%D1%82%D0%B8%D0%B2%20%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85'>Модульные приложения против классических</a></li>
			<li><a href='#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9'>Запуск модульных приложений</a></li>
			<li><a href='#%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA%20%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9%20%D1%81%20config.ru'>Запуск классических приложений с config.ru</a></li>
			<li><a href='#%D0%9A%D0%BE%D0%B3%D0%B4%D0%B0%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C%20config.ru?'>Когда использовать config.ru?</a></li>
			<li><a href='#%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20Sinatra%20%D0%B2%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5%20%E2%80%9C%D0%BF%D1%80%D0%BE%D1%81%D0%BB%D0%BE%D0%B9%D0%BA%D0%B8%E2%80%9D'>Использование Sinatra в качестве “прослойки”</a></li>
			<li><a href='#%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9%20%E2%80%9C%D0%BD%D0%B0%20%D0%BB%D0%B5%D1%82%D1%83%E2%80%9D'>Создание приложений “на лету”</a></li>
		</ol>
		<li><a href='#%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D0%B8%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%B8%20%D0%BF%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0'>Области видимости и привязка</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20/%20%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B0'>Область видимости приложения / класса</a></li>
			<li><a href='#%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0/%D1%8D%D0%BA%D0%B7%D0%B5%D0%BC%D0%BF%D0%BB%D1%8F%D1%80%D0%B0'>Область видимости запроса/экземпляра</a></li>
			<li><a href='#%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%B4%D0%B5%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F'>Область видимости делегирования</a></li>
		</ol>
		<li><a href='#%D0%9A%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D0%BD%D0%B0%D1%8F%20%D1%81%D1%82%D1%80%D0%BE%D0%BA%D0%B0'>Командная строка</a></li>
		<li><a href='#%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F'>Системные требования</a></li>
		<li><a href='#%D0%9D%D0%B0%20%D0%BE%D1%81%D1%82%D1%80%D0%B8%D0%B5'>На острие</a></li>
		<ol class='level-2'>
			<li><a href='#%D0%A1%20%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E%20Bundler'>С помощью Bundler</a></li>
			<li><a href='#%D0%92%D1%80%D1%83%D1%87%D0%BD%D1%83%D1%8E'>Вручную</a></li>
			<li><a href='#%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%B3%D0%BB%D0%BE%D0%B1%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE'>Установка глобально</a></li>
		</ol>
		<li><a href='#%D0%92%D0%B5%D1%80%D1%81%D0%B8%D0%B8'>Версии</a></li>
		<li><a href='#%D0%94%D0%B0%D0%BB%D1%8C%D0%BD%D0%B5%D0%B9%D1%88%D0%B5%D0%B5%20%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D0%B5'>Дальнейшее чтение</a></li>
	</ol>
</div>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>

<p><em>Внимание: Этот документ является переводом английской версии и может быть
устаревшим</em></p>

<p>Sinatra — это предметно-ориентированный каркас
(<a href="http://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B5%D0%B4%D0%BC%D0%B5%D1%82%D0%BD%D0%BE-%D0%BE%D1%80%D0%B8%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9_%D1%8F%D0%B7%D1%8B%D0%BA_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F">DSL</a>)
для быстрого создания функциональных веб-приложений на Ruby с минимумом усилий:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># myapp.rb</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello world!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Установите gem:</p>

<pre><code>gem install sinatra
</code></pre>

<p>и запустите приложение с помощью:</p>

<pre><code>ruby myapp.rb
</code></pre>

<p>Оцените результат: http://localhost:4567</p>

<p>Рекомендуется также установить Thin, сделать это можно командой: <code>gem install
thin</code>. Thin — это более производительный и функциональный сервер для
разработки приложений на Sinatra.</p>

<a name='%D0%9C%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D1%8B'></a>
<h2>Маршруты</h2>

<p>В Sinatra маршрут — это пара: &lt;HTTP метод&gt; и &lt;шаблон URL&gt;. Каждый маршрут
связан с блоком кода:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># .. что-то показать ..</span>
<span style="color:#080;font-weight:bold">end</span>

post <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># .. что-то создать ..</span>
<span style="color:#080;font-weight:bold">end</span>

put <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># .. что-то заменить ..</span>
<span style="color:#080;font-weight:bold">end</span>

patch <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># .. что-то изменить ..</span>
<span style="color:#080;font-weight:bold">end</span>

delete <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># .. что-то удалить ..</span>
<span style="color:#080;font-weight:bold">end</span>

options <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># .. что-то ответить ..</span>
<span style="color:#080;font-weight:bold">end</span>

link <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. что-то подключить ..
<span style="color:#080;font-weight:bold">end</span>

unlink <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  .. что-то отключить ..
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Маршруты сверяются с запросом в порядке очередности их записи в файле
приложения. Первый же совпавший с запросом маршрут и будет вызван.</p>

<p>Шаблоны маршрутов могут включать в себя именованные параметры, доступные в xэше
<code>params</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/hello/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># соответствует "GET /hello/foo" и "GET /hello/bar",</span>
  <span style="color:#777"># где params[:name] 'foo' или 'bar'</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hello </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:name</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Также можно использовать именованные параметры в качестве переменных блока:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/hello/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span> |n|
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hello </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>n<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Шаблоны маршрутов также могут включать в себя splat (или ‘*’ маску,
обозначающую любой символ) параметры, доступные в массиве <code>params[:splat]</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/say/*/to/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># соответствует /say/hello/to/world</span>
  params[<span style="color:#A60">:splat</span>] <span style="color:#777"># =&gt; ["hello", "world"]</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/download/*.*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># соответствует /download/path/to/file.xml</span>
  params[<span style="color:#A60">:splat</span>] <span style="color:#777"># =&gt; ["path/to/file", "xml"]</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Или с параметрами блока:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/download/*.*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span> |path, ext|
  [path, ext] <span style="color:#777"># =&gt; ["path/to/file", "xml"]</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Регулярные выражения в качестве шаблонов маршрутов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">%r{</span><span style="color:#808">/hello/([</span><span style="color:#D20">\w</span><span style="color:#808">]+)</span><span style="color:#404">}</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hello, </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:captures</span>].first<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Или с параметром блока:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">%r{</span><span style="color:#808">/hello/([</span><span style="color:#D20">\w</span><span style="color:#808">]+)</span><span style="color:#404">}</span></span> <span style="color:#080;font-weight:bold">do</span> |c|
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hello, </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>c<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Шаблоны маршрутов могут иметь необязательные параметры:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/posts.?:format?</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># соответствует "GET /posts", "GET /posts.json", "GET /posts.xml" и т.д.</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Кстати, если вы не отключите защиту от обратного пути в директориях (path
traversal, см. ниже), путь запроса может быть изменен до начала поиска
подходящего маршрута.</p>

<a name='%D0%A3%D1%81%D0%BB%D0%BE%D0%B2%D0%B8%D1%8F'></a>
<h3>Условия</h3>

<p>Маршруты могут включать различные условия совпадений, например, клиентское
приложение (user agent):</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span>, <span style="color:#A60">:agent</span> =&gt; <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">Songbird (</span><span style="color:#D20">\d</span><span style="color:#D20">\.</span><span style="color:#D20">\d</span><span style="color:#808">)[</span><span style="color:#D20">\d</span><span style="color:#D20">\/</span><span style="color:#808">]*?</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">You're using Songbird version </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:agent</span>][<span style="color:#00D">0</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># соответствует не-songbird браузерам</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Другими доступными условиями являются <code>host_name</code> и <code>provides</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, <span style="color:#A60">:host_name</span> =&gt; <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">^admin</span><span style="color:#D20">\.</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Admin Area, Access denied!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, <span style="color:#A60">:provides</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">html</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, <span style="color:#A60">:provides</span> =&gt; [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rss</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">atom</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">xml</span><span style="color:#710">'</span></span>] <span style="color:#080;font-weight:bold">do</span>
  builder <span style="color:#A60">:feed</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Вы можете задать собственные условия:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set(<span style="color:#A60">:probability</span>) { |value| condition { rand &lt;= value } }

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/win_a_car</span><span style="color:#710">'</span></span>, <span style="color:#A60">:probability</span> =&gt; <span style="color:#60E">0.1</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">You won!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/win_a_car</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Sorry, you lost.</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Для условия, которое принимает несколько параметров, используйте звездочку:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set(<span style="color:#A60">:auth</span>) <span style="color:#080;font-weight:bold">do</span> |*roles|   <span style="color:#777"># &lt;- обратите внимание на звездочку</span>
  condition <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">unless</span> logged_in? &amp;&amp; roles.any? {|role| current_user.in_role? role }
      redirect <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/login/</span><span style="color:#710">"</span></span>, <span style="color:#00D">303</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/my/account/</span><span style="color:#710">"</span></span>, <span style="color:#A60">:auth</span> =&gt; [<span style="color:#A60">:user</span>, <span style="color:#A60">:admin</span>] <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Your Account Details</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/only/admin/</span><span style="color:#710">"</span></span>, <span style="color:#A60">:auth</span> =&gt; <span style="color:#A60">:admin</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Only admins are allowed here!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%92%D0%BE%D0%B7%D0%B2%D1%80%D0%B0%D1%89%D0%B0%D0%B5%D0%BC%D1%8B%D0%B5%20%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D1%8F'></a>
<h3>Возвращаемые значения</h3>

<p>Возвращаемое значение блока маршрута ограничивается телом ответа, которое
будет передано HTTP клиенту, или следующей “прослойкой” (middleware) в Rack
стеке. Чаще всего это строка, как в примерах выше. Но также приемлемы и
другие значения.</p>

<p>Вы можете вернуть любой объект, который будет либо корректным Rack ответом,
объектом Rack body, либо кодом состояния HTTP:</p>

<p>Таким образом, легко можно реализовать, например, поточный пример:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">Stream</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">each</span>
    <span style="color:#00D">100</span>.times { |i| <span style="color:#080;font-weight:bold">yield</span> <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>i<span style="font-weight:bold;color:#666">}</span></span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span> }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="color:#036;font-weight:bold">Stream</span>.new }
</pre></div>
</div>
</div>

<p>Вы также можете использовать метод <code>stream</code> (описываемый ниже), чтобы
уменьшить количество дублируемого кода и держать логику стриминга прямо в
маршруте.</p>

<a name='%D0%A1%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5%20%D0%B4%D0%B5%D1%82%D0%B5%D0%BA%D1%82%D0%BE%D1%80%D1%8B%20%D1%81%D0%BE%D0%B2%D0%BF%D0%B0%D0%B4%D0%B5%D0%BD%D0%B8%D0%B9%20%D0%B4%D0%BB%D1%8F%20%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%BE%D0%B2'></a>
<h3>Собственные детекторы совпадений для маршрутов</h3>

<p>Как показано выше, Sinatra поставляется со встроенной поддержкой строк и
регулярных выражений в качестве шаблонов URL. Но и это еще не все. Вы можете
легко определить свои собственные детекторы совпадений (matchers) для
маршрутов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">AllButPattern</span>
  <span style="color:#036;font-weight:bold">Match</span> = <span style="color:#036;font-weight:bold">Struct</span>.new(<span style="color:#A60">:captures</span>)

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">initialize</span>(except)
    <span style="color:#33B">@except</span>   = except
    <span style="color:#33B">@captures</span> = <span style="color:#036;font-weight:bold">Match</span>.new([])
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">match</span>(str)
    <span style="color:#33B">@captures</span> <span style="color:#080;font-weight:bold">unless</span> <span style="color:#33B">@except</span> === str
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">all_but</span>(pattern)
  <span style="color:#036;font-weight:bold">AllButPattern</span>.new(pattern)
<span style="color:#080;font-weight:bold">end</span>

get all_but(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/index</span><span style="color:#710">"</span></span>) <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Заметьте, что предыдущий пример, возможно, чересчур усложнен, потому что он
может быть реализован так:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  pass <span style="color:#080;font-weight:bold">if</span> request.path_info == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/index</span><span style="color:#710">"</span></span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Или с использованием негативного просмотра вперед:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">%r{</span><span style="color:#808">^(?!/index$)</span><span style="color:#404">}</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%A1%D1%82%D0%B0%D1%82%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5%20%D1%84%D0%B0%D0%B9%D0%BB%D1%8B'></a>
<h2>Статические файлы</h2>

<p>Статические файлы отдаются из <code>./public</code> директории. Вы можете указать другое
место, используя опцию <code>:public_folder</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:public_folder</span>, <span style="color:#036;font-weight:bold">File</span>.dirname(<span style="color:#069">__FILE__</span>) + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/static</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Учтите, что имя директории со статическими файлами не включено в URL.
Например, файл <code>./public/css/style.css</code> будет доступен как
<code>http://example.com/css/style.css</code>.</p>

<p>Используйте опцию <code>:static_cache_control</code> (см. ниже), чтобы добавить заголовок
<code>Cache-Control</code>.</p>

<a name='%D0%9F%D1%80%D0%B5%D0%B4%D1%81%D1%82%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F%20/%20%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h2>Представления / Шаблоны</h2>

<p>Каждый шаблонизатор представлен своим собственным методом. Эти методы попросту
возвращают строку:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Отобразит <code>views/index.erb</code>.</p>

<p>Вместо имени шаблона вы так же можете передавать непосредственно само
содержимое шаблона:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  code = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">&lt;%= Time.now %&gt;</span><span style="color:#710">"</span></span>
  erb code
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Эти методы принимают второй аргумент, хеш с опциями:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  erb <span style="color:#A60">:index</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#A60">:post</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Отобразит <code>views/index.erb</code>, вложенным в <code>views/post.erb</code> (по умолчанию:
<code>views/layout.erb</code>, если существует).</p>

<p>Любые опции, не понимаемые Sinatra, будут переданы в шаблонизатор:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>, <span style="color:#A60">:format</span> =&gt; <span style="color:#A60">:html5</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Вы также можете задавать опции для шаблонизаторов в общем:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:haml</span>, <span style="color:#A60">:format</span> =&gt; <span style="color:#A60">:html5</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Опции, переданные в метод, переопределяют опции, заданные с помощью <code>set</code>.</p>

<p>Доступные опции:</p>

<dl>
<dt>locals</dt>
  <dd>
    Список локальных переменных, передаваемых в документ.
    Например: <tt>erb "&lt;%= foo %&gt;", :locals =&gt; {:foo =&gt; "bar"}</tt>
  </dd>

  <dt>default_encoding</dt>
  <dd>
    Кодировка, которую следует использовать, если не удалось определить
    оригинальную. По умолчанию: <tt>settings.default_encoding</tt>.
  </dd>

  <dt>views</dt>
  <dd>
    Директория с шаблонами. По умолчанию: <tt>settings.views</tt>.
  </dd>

  <dt>layout</dt>
  <dd>
    Использовать или нет лэйаут (<tt>true</tt> или <tt>false</tt>). Если же значение Symbol,
    то указывает, какой шаблон использовать в качестве лэйаута. Например:
    <tt>erb :index, :layout =&gt; !request.xhr?</tt>
  </dd>

  <dt>content_type</dt>
  <dd>
    Content-Type отображенного шаблона. По умолчанию: задается шаблонизатором.
  </dd>

  <dt>scope</dt>
  <dd>
    Область видимости, в которой рендерятся шаблоны. По умолчанию: экземпляр
    приложения. Если вы измените эту опцию, то переменные экземпляра и
    методы-помощники станут недоступными в ваших шаблонах.
  </dd>

  <dt>layout_engine</dt>
  <dd>
    Шаблонизатор, который следует использовать для отображения лэйаута.
    Полезная опция для шаблонизаторов, в которых нет никакой поддержки
    лэйаутов. По умолчанию: тот же шаблонизатор, что используется и для самого
    шаблона. Пример: <tt>set :rdoc, :layout_engine =&gt; :erb</tt>
  </dd>
</dl>
<p>По умолчанию считается, что шаблоны находятся в директории <code>./views</code>. Чтобы
использовать другую директорию с шаблонами:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:views</span>, settings.root + <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/templates</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Важное замечание: вы всегда должны ссылаться на шаблоны с помощью символов
(Symbol), даже когда они в поддиректории (в этом случае используйте
<code>:'subdir/template'</code>). Вы должны использовать символы, потому что иначе
шаблонизаторы попросту отображают любые строки, переданные им.</p>

<a name='%D0%91%D1%83%D0%BA%D0%B2%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h3>Буквальные шаблоны</h3>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%div.title Hello World</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Отобразит шаблон, переданный строкой.</p>

<a name='%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B8%D0%B7%D0%B0%D1%82%D0%BE%D1%80%D1%8B'></a>
<h3>Доступные шаблонизаторы</h3>

<p>Некоторые языки шаблонов имеют несколько реализаций. Чтобы указать, какую
реализацию использовать, вам следует просто подключить нужную библиотеку:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rdiscount</span><span style="color:#710">'</span></span> <span style="color:#777"># или require 'bluecloth'</span>
get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { markdown <span style="color:#A60">:index</span> }
</pre></div>
</div>
</div>

<a name='Haml%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Haml шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://haml.info/" title="haml">haml</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.haml</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>haml :index, :format =&gt; :html5</tt></td>
  </tr>
</table>
<a name='Erb%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Erb шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td>
      <a href="http://www.kuwata-lab.com/erubis/" title="erubis">erubis</a>
      или erb (включен в Ruby)
    </td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td>
<tt>.erb</tt>, <tt>.rhtml</tt> or <tt>.erubis</tt> (только Erubis)</td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>
<a name='Builder%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Builder шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td>
      <a href="http://builder.rubyforge.org/" title="builder">builder</a>
    </td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.builder</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>builder { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>
<p>Блок также используется и для встроенных шаблонов (см. пример).</p>

<a name='Nokogiri%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Nokogiri шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://nokogiri.org/" title="nokogiri">nokogiri</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>nokogiri { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>
<p>Блок также используется и для встроенных шаблонов (см. пример).</p>

<a name='Sass%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Sass шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.sass</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>sass :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>
<a name='SCSS%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>SCSS шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.scss</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>scss :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>
<a name='Less%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Less шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://www.lesscss.org/" title="less">less</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.less</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>less :stylesheet</tt></td>
  </tr>
</table>
<a name='Liquid%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Liquid шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://www.liquidmarkup.org/" title="liquid">liquid</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.liquid</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>liquid :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>
<p>Так как в Liquid шаблонах невозможно вызывать методы из Ruby (кроме <code>yield</code>), то
вы почти всегда будете передавать в шаблон локальные переменные.</p>

<a name='Markdown%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Markdown шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td>
      Любая из библиотек:
        <a href="https://github.com/rtomayko/rdiscount" title="RDiscount">RDiscount</a>,
        <a href="https://github.com/vmg/redcarpet" title="RedCarpet">RedCarpet</a>,
        <a href="http://deveiate.org/projects/BlueCloth" title="BlueCloth">BlueCloth</a>,
        <a href="http://kramdown.rubyforge.org/" title="kramdown">kramdown</a>,
        <a href="http://maruku.rubyforge.org/" title="maruku">maruku</a>
    </td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td>
<tt>.markdown</tt>, <tt>.mkd</tt> and <tt>.md</tt>
</td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>markdown :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>В Markdown невозможно вызывать методы или передавать локальные переменные.
Следовательно, вам, скорее всего, придется использовать этот шаблон совместно
с другим шаблонизатором:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; markdown(<span style="color:#A60">:introduction</span>) }
</pre></div>
</div>
</div>

<p>Заметьте, что вы можете вызывать метод <code>markdown</code> из других шаблонов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Hello</span> <span style="color:#036;font-weight:bold">From</span> Haml!
%p= markdown(<span style="color:#A60">:greetings</span>)
</pre></div>
</div>
</div>

<p>Вы не можете вызывать Ruby из Markdown, соответственно, вы не можете
использовать лэйауты на Markdown. Тем не менее, есть возможность использовать
один шаблонизатор для отображения шаблона, а другой для лэйаута с помощью
опции <code>:layout_engine</code>.</p>

<a name='Textile%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Textile шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://redcloth.org/" title="RedCloth">RedCloth</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.textile</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>textile :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>В Textile невозможно вызывать методы или передавать локальные переменные.
Следовательно, вам, скорее всего, придется использовать этот шаблон совместно
с другим шаблонизатором:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; textile(<span style="color:#A60">:introduction</span>) }
</pre></div>
</div>
</div>

<p>Заметьте, что вы можете вызывать метод <code>textile</code> из других шаблонов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Hello</span> <span style="color:#036;font-weight:bold">From</span> Haml!
%p= textile(<span style="color:#A60">:greetings</span>)
</pre></div>
</div>
</div>

<p>Вы не можете вызывать Ruby из Textile, соответственно, вы не можете
использовать лэйауты на Textile. Тем не менее, есть возможность использовать
один шаблонизатор для отображения шаблона, а другой для лэйаута с помощью
опции <code>:layout_engine</code>.</p>

<a name='RDoc%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>RDoc шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://rdoc.rubyforge.org/" title="RDoc">RDoc</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.rdoc</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>rdoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>В RDoc невозможно вызывать методы или передавать локальные переменные.
Следовательно, вам, скорее всего, придется использовать этот шаблон совместно
с другим шаблонизатором:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; rdoc(<span style="color:#A60">:introduction</span>) }
</pre></div>
</div>
</div>

<p>Заметьте, что вы можете вызывать метод <code>rdoc</code> из других шаблонов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Hello</span> <span style="color:#036;font-weight:bold">From</span> Haml!
%p= rdoc(<span style="color:#A60">:greetings</span>)
</pre></div>
</div>
</div>

<p>Вы не можете вызывать Ruby из RDoc, соответственно, вы не можете использовать
лэйауты на RDoc. Тем не менее, есть возможность использовать один шаблонизатор
для отображения шаблона, а другой для лэйаута с помощью опции
<code>:layout_engine</code>.</p>

<a name='AsciiDoc%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>AsciiDoc шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://asciidoctor.org/" title="Asciidoctor">Asciidoctor</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td>
<tt>.asciidoc</tt>, <tt>.adoc</tt> и <tt>.ad</tt>
</td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>asciidoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>Так как в AsciiDoc шаблонах невозможно вызывать методы из Ruby напрямую, то вы
почти всегда будете передавать в шаблон локальные переменные.</p>

<a name='Radius%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Radius шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://radius.rubyforge.org/" title="Radius">Radius</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.radius</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>radius :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>
<p>Так как в Radius шаблонах невозможно вызывать методы из Ruby напрямую, то вы
почти всегда будете передавать в шаблон локальные переменные.</p>

<a name='Markaby%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Markaby шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://markaby.github.com/" title="Markaby">Markaby</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.mab</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>markaby { h1 "Welcome!" }</tt></td>
  </tr>
</table>
<p>Блок также используется и для встроенных шаблонов (см. пример).</p>

<a name='RABL%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>RABL шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="https://github.com/nesquena/rabl" title="Rabl">Rabl</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.rabl</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>
<a name='Slim%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Slim шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="http://slim-lang.com/" title="Slim Lang">Slim Lang</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.slim</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>
<a name='Creole%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Creole шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="https://github.com/minad/creole" title="Creole">Creole</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.creole</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>creole :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>В Creole невозможно вызывать методы или передавать локальные переменные.
Следовательно, вам, скорее всего, придется использовать этот шаблон совместно
с другим шаблонизатором:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; creole(<span style="color:#A60">:introduction</span>) }
</pre></div>
</div>
</div>

<p>Заметьте, что вы можете вызывать метод <code>creole</code> из других шаблонов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Hello</span> <span style="color:#036;font-weight:bold">From</span> Haml!
%p= creole(<span style="color:#A60">:greetings</span>)
</pre></div>
</div>
</div>

<p>Вы не можете вызывать Ruby из Creole, соответственно, вы не можете
использовать лэйауты на Creole. Тем не менее, есть возможность использовать
один шаблонизатор для отображения шаблона, а другой для лэйаута с помощью
опции <code>:layout_engine</code>.</p>

<a name='MediaWiki%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>MediaWiki шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="https://github.com/nricciar/wikicloth" title="WikiCloth">WikiCloth</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td>
<tt>.mediawiki</tt> и <tt>.mw</tt>
</td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>mediawiki :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>
<p>В разметке MediaWiki невозможно вызывать методы или передавать локальные переменные.
Следовательно, вам, скорее всего, придется использовать этот шаблон совместно
с другим шаблонизатором:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>erb <span style="color:#A60">:overview</span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:text</span> =&gt; mediawiki(<span style="color:#A60">:introduction</span>) }
</pre></div>
</div>
</div>

<p>Заметьте, что вы можете вызывать метод <code>mediawiki</code> из других шаблонов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%h1 <span style="color:#036;font-weight:bold">Hello</span> <span style="color:#036;font-weight:bold">From</span> Haml!
%p= mediawiki(<span style="color:#A60">:greetings</span>)
</pre></div>
</div>
</div>

<p>Вы не можете вызывать Ruby из MediaWiki, соответственно, вы не можете
использовать лэйауты на MediaWiki. Тем не менее, есть возможность использовать
один шаблонизатор для отображения шаблона, а другой для лэйаута с помощью
опции <code>:layout_engine</code>.</p>

<a name='CoffeeScript%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>CoffeeScript шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td>
      <a href="https://github.com/josh/ruby-coffee-script" title="Ruby CoffeeScript">
        CoffeeScript
      </a> и способ
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        запускать JavaScript
      </a>
    </td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.coffee</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>
<a name='Yajl%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>Yajl шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">yajl-ruby</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.yajl</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td>
      <tt>
        yajl :index,
             :locals =&gt; { :key =&gt; 'qux' },
             :callback =&gt; 'present',
             :variable =&gt; 'resource'
      </tt>
    </td>
  </tr>
</table>
<p>Содержимое шаблона интерпретируется как код на Ruby, а результирующая
переменная json затем конвертируется с помощью <code>#to_json</code>.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>json = { <span style="color:#A60">:foo</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bar</span><span style="color:#710">'</span></span> }
json[<span style="color:#A60">:baz</span>] = key
</pre></div>
</div>
</div>

<p>Опции <code>:callback</code> и <code>:variable</code> используются для “декорирования” итогового
объекта.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>var resource = {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">foo</span><span style="color:#710">"</span></span><span style="color:#A60"><span style="color:#A60">:</span><span style="color:#740">"</span><span style="color:#A60">bar</span><span style="color:#740">"</span></span>,<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">baz</span><span style="color:#710">"</span></span><span style="color:#A60"><span style="color:#A60">:</span><span style="color:#740">"</span><span style="color:#A60">qux</span><span style="color:#740">"</span></span>}; present(resource);
</pre></div>
</div>
</div>

<a name='WLang%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h4>WLang шаблоны</h4>

<table>
<tr>
<td>Зависимости</td>
    <td><a href="https://github.com/blambeau/wlang/" title="wlang">wlang</a></td>
  </tr>
<tr>
<td>Расширения файлов</td>
    <td><tt>.wlang</tt></td>
  </tr>
<tr>
<td>Пример</td>
    <td><tt>wlang :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>
<p>Так как в WLang шаблонах невозможно вызывать методы из Ruby напрямую (за
исключением <code>yield</code>), то вы почти всегда будете передавать в шаблон локальные
переменные.</p>

<a name='%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%20%D0%BA%20%D0%BF%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D1%8B%D0%BC%20%D0%B2%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%B0%D1%85'></a>
<h3>Доступ к переменным в шаблонах</h3>

<p>Шаблоны интерпретируются в том же контексте, что и обработчики маршрутов.
Переменные экземпляра, установленные в процессе обработки маршрутов, будут
доступны напрямую в шаблонах:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:id</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@foo</span> = <span style="color:#036;font-weight:bold">Foo</span>.find(params[<span style="color:#A60">:id</span>])
  haml <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%h1= @foo.name</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Либо установите их через хеш локальных переменных:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:id</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  foo = <span style="color:#036;font-weight:bold">Foo</span>.find(params[<span style="color:#A60">:id</span>])
  haml <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%h1= bar.name</span><span style="color:#710">'</span></span>, <span style="color:#A60">:locals</span> =&gt; { <span style="color:#A60">:bar</span> =&gt; foo }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Это обычный подход, когда шаблоны рендерятся как части других шаблонов.</p>

<a name='%D0%A8%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B%20%D1%81%20%3Ccode%3Eyield%3C/code%3E%20%D0%B8%20%D0%B2%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%80%D0%B0%D1%81%D0%BA%D0%BB%D0%B0%D0%B4%D0%BA%D0%B8%20(layout)'></a>
<h3>Шаблоны с <code>yield</code> и вложенные раскладки (layout)</h3>

<p>Раскладка (layout) обычно представляет собой шаблон, который исполняет
<code>yield</code>.
Такой шаблон может быть либо использован с помощью опции <code>:template</code>,
как описано выше, либо он может быть дополнен блоком:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>    erb <span style="color:#A60">:post</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#069">false</span> <span style="color:#080;font-weight:bold">do</span>
      erb <span style="color:#A60">:index</span>
    <span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Эти инструкции в основном эквивалентны <code>erb :index, :layout =&gt; :post</code>.</p>

<p>Передача блоков интерпретирующим шаблоны методам наиболее полезна для
создания вложенных раскладок:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>    erb <span style="color:#A60">:main_layout</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#069">false</span> <span style="color:#080;font-weight:bold">do</span>
      erb <span style="color:#A60">:admin_layout</span> <span style="color:#080;font-weight:bold">do</span>
        erb <span style="color:#A60">:user</span>
      <span style="color:#080;font-weight:bold">end</span>
    <span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Это же самое может быть сделано короче:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>    erb <span style="color:#A60">:admin_layout</span>, <span style="color:#A60">:layout</span> =&gt; <span style="color:#A60">:main_layout</span> <span style="color:#080;font-weight:bold">do</span>
      erb <span style="color:#A60">:user</span>
    <span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>В настоящее время, следующие интерпретирующие шаблоны методы
принимают блок:
<code>erb</code>, <code>haml</code>, <code>liquid</code>, <code>slim </code>, <code>wlang</code>.
Общий метод заполнения шаблонов <code>render</code> также принимает блок.</p>

<a name='%D0%92%D0%BA%D0%BB%D1%8E%D1%87%D1%91%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h3>Включённые шаблоны</h3>

<p>Шаблоны также могут быть определены в конце исходного файла:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#777">__END__

@@ layout
%html
  = yield

@@ index
%div.title Hello world.</span>
</pre></div>
</div>
</div>

<p>Заметьте: включённые шаблоны, определенные в исходном файле, который подключил
Sinatra, будут загружены автоматически. Вызовите <code>enable :inline_templates</code>
напрямую, если используете включённые шаблоны в других файлах.</p>

<a name='%D0%98%D0%BC%D0%B5%D0%BD%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B'></a>
<h3>Именованные шаблоны</h3>

<p>Шаблоны также могут быть определены при помощи <code>template</code> метода:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>template <span style="color:#A60">:layout</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">%html</span><span style="color:#b0b">\n</span><span style="color:#D20">  =yield</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

template <span style="color:#A60">:index</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">%div.title Hello World!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Если шаблон с именем “layout” существует, то он будет использоваться каждый
раз при рендеринге. Вы можете отключать лэйаут в каждом конкретном случае с
помощью <code>:layout =&gt; false</code> или отключить его для всего приложения: <code>set :haml,
:layout =&gt; false</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  haml <span style="color:#A60">:index</span>, <span style="color:#A60">:layout</span> =&gt; !request.xhr?
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%9F%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0%20%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2%D1%8B%D1%85%20%D1%80%D0%B0%D1%81%D1%88%D0%B8%D1%80%D0%B5%D0%BD%D0%B8%D0%B9'></a>
<h3>Привязка файловых расширений</h3>

<p>Чтобы связать расширение файла с движком рендеринга, используйте
<code>Tilt.register</code>. Например, если вы хотите использовать расширение <code>tt</code> для
шаблонов Textile:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">Tilt</span>.register <span style="color:#A60">:tt</span>, <span style="color:#036;font-weight:bold">Tilt</span>[<span style="color:#A60">:textile</span>]
</pre></div>
</div>
</div>

<a name='%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D1%81%D0%BE%D0%B1%D1%81%D1%82%D0%B2%D0%B5%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%B4%D0%B2%D0%B8%D0%B6%D0%BA%D0%B0%20%D1%80%D0%B5%D0%BD%D0%B4%D0%B5%D1%80%D0%B8%D0%BD%D0%B3%D0%B0'></a>
<h3>Добавление собственного движка рендеринга</h3>

<p>Сначала зарегистрируйте свой движок в Tilt, а затем создайте метод, отвечающий
за рендеринг:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#036;font-weight:bold">Tilt</span>.register <span style="color:#A60">:myat</span>, <span style="color:#036;font-weight:bold">MyAwesomeTemplateEngine</span>

helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">myat</span>(*args) render(<span style="color:#A60">:myat</span>, *args) <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  myat <span style="color:#A60">:index</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Отобразит <code>./views/index.myat</code>. Чтобы узнать больше о Tilt, смотрите
https://github.com/rtomayko/tilt</p>

<a name='%D0%A4%D0%B8%D0%BB%D1%8C%D1%82%D1%80%D1%8B'></a>
<h2>Фильтры</h2>

<p><code>before</code>-фильтры выполняются перед каждым запросом в том же контексте, что и
маршруты, и могут изменять как запрос, так и ответ на него. Переменные
экземпляра, установленные в фильтрах, доступны в маршрутах и шаблонах:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@note</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hi!</span><span style="color:#710">'</span></span>
  request.path_info = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo/bar/baz</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@note</span> <span style="color:#777">#=&gt; 'Hi!'</span>
  params[<span style="color:#A60">:splat</span>] <span style="color:#777">#=&gt; 'bar/baz'</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p><code>after</code>-фильтры выполняются после каждого запроса в том же контексте
и могут изменять как запрос, так и ответ на него. Переменные
экземпляра, установленные в <code>before</code>-фильтрах и маршрутах, будут доступны в
<code>after</code>-фильтрах:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>after <span style="color:#080;font-weight:bold">do</span>
  puts response.status
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Заметьте: если вы используете метод <code>body</code>, а не просто возвращаете строку из
маршрута, то тело ответа не будет доступно в <code>after</code>-фильтрах, так как оно
будет сгенерировано позднее.</p>

<p>Фильтры могут использовать шаблоны URL и будут интерпретированы, только если
путь запроса совпадет с этим шаблоном:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/protected/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  authenticate!
<span style="color:#080;font-weight:bold">end</span>

after <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/create/:slug</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span> |slug|
  session[<span style="color:#A60">:last_slug</span>] = slug
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Как и маршруты, фильтры могут использовать условия:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#A60">:agent</span> =&gt; <span style="background-color:hsla(300,100%,50%,0.06)"><span style="color:#404">/</span><span style="color:#808">Songbird</span><span style="color:#404">/</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>

after <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/blog/*</span><span style="color:#710">'</span></span>, <span style="color:#A60">:host_name</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">example.com</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%9C%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D0%BD%D0%B8%D0%BA%D0%B8'></a>
<h2>Методы-помощники</h2>

<p>Используйте метод <code>helpers</code>, чтобы определить методы-помощники, которые в
дальнейшем можно будет использовать в обработчиках маршрутов и шаблонах:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">bar</span>(name)
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">bar</span><span style="color:#710">"</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  bar(params[<span style="color:#A60">:name</span>])
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Также методы-помощники могут быть заданы в отдельных модулях:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">FooUtils</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">foo</span>(name) <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">foo</span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">module</span> <span style="color:#B06;font-weight:bold">BarUtils</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">bar</span>(name) <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>name<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">bar</span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

helpers <span style="color:#036;font-weight:bold">FooUtils</span>, <span style="color:#036;font-weight:bold">BarUtils</span>
</pre></div>
</div>
</div>

<p>Эффект равносилен включению модулей в класс приложения.</p>

<a name='%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%81%D0%B5%D1%81%D1%81%D0%B8%D0%B9'></a>
<h3>Использование сессий</h3>

<p>Сессия используется, чтобы сохранять состояние между запросами. Если эта опция
включена, то у вас будет один хеш сессии на одну пользовательскую сессию:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>enable <span style="color:#A60">:sessions</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">value = </span><span style="color:#710">"</span></span> &lt;&lt; session[<span style="color:#A60">:value</span>].inspect
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:value</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:value</span>] = params[<span style="color:#A60">:value</span>]
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Заметьте, что при использовании <code>enable :sessions</code> все данные сохраняются в
куках (cookies). Это может быть не совсем то, что вы хотите (например,
сохранение больших объемов данных увеличит ваш трафик). В таком случае вы
можете использовать альтернативную Rack “прослойку” (middleware), реализующую
механизм сессий. Для этого <em>не надо</em> вызывать <code>enable :sessions</code>, вместо этого
следует подключить ее так же, как и любую другую “прослойку”:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Session</span>::<span style="color:#036;font-weight:bold">Pool</span>, <span style="color:#A60">:expire_after</span> =&gt; <span style="color:#00D">2592000</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">value = </span><span style="color:#710">"</span></span> &lt;&lt; session[<span style="color:#A60">:value</span>].inspect
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/:value</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:value</span>] = params[<span style="color:#A60">:value</span>]
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Для повышения безопасности данные сессии в куках подписываются секретным
ключом. Секретный ключ генерируется Sinatra. Тем не менее, так как этот ключ
будет меняться с каждым запуском приложения, вы, возможно, захотите установить
ключ вручную, чтобы у всех экземпляров вашего приложения был один и тот же
ключ:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:session_secret</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">super secret</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Если вы хотите больше настроек для сессий, вы можете задать их, передав хеш
опций в параметр <code>sessions</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:sessions</span>, <span style="color:#A60">:domain</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo.com</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Чтобы сделать сессию доступной другим приложениям, размещенным на поддоменах
foo.com, добавьте <em>.</em> перед доменом:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:sessions</span>, <span style="color:#A60">:domain</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">.foo.com</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<a name='%D0%9F%D1%80%D0%B5%D1%80%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5'></a>
<h3>Прерывание</h3>

<p>Чтобы незамедлительно прервать обработку запроса внутри фильтра или маршрута,
используйте:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt
</pre></div>
</div>
</div>

<p>Можно также указать статус при прерывании:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="color:#00D">410</span>
</pre></div>
</div>
</div>

<p>Тело:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">this will be the body</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>И то, и другое:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="color:#00D">401</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">go away!</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Можно указать заголовки:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt <span style="color:#00D">402</span>, {<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Content-Type</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">text/plain</span><span style="color:#710">'</span></span>}, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">revenge</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>И, конечно, можно использовать шаблоны с <code>halt</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>halt erb(<span style="color:#A60">:error</span>)
</pre></div>
</div>
</div>

<a name='%D0%9F%D0%B5%D1%80%D0%B5%D0%B4%D0%B0%D1%87%D0%B0'></a>
<h3>Передача</h3>

<p>Маршрут может передать обработку запроса следующему совпадающему маршруту,
используя <code>pass</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/guess/:who</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  pass <span style="color:#080;font-weight:bold">unless</span> params[<span style="color:#A60">:who</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Frank</span><span style="color:#710">'</span></span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">You got me!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/guess/*</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">You missed!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Блок маршрута сразу же прерывается, и контроль переходит к следующему
совпадающему маршруту. Если соответствующий маршрут не найден, то ответом на
запрос будет 404.</p>

<a name='%D0%92%D1%8B%D0%B7%D0%BE%D0%B2%20%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B3%D0%BE%20%D0%BC%D0%B0%D1%80%D1%88%D1%80%D1%83%D1%82%D0%B0'></a>
<h3>Вызов другого маршрута</h3>

<p>Иногда <code>pass</code> не подходит, например, если вы хотите получить результат вызова
другого обработчика маршрута. В таком случае просто используйте <code>call</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  status, headers, body = call env.merge(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">PATH_INFO</span><span style="color:#710">"</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>)
  [status, headers, body.map(&amp;<span style="color:#A60">:upcase</span>)]
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">bar</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Заметьте, что в предыдущем примере можно облегчить тестирование и повысить
производительность, перенеся <code>"bar"</code> в метод-помощник, используемый и в
<code>/foo</code>, и в <code>/bar</code>.</p>

<p>Если вы хотите, чтобы запрос был отправлен в тот же экземпляр приложения, а не
в его копию, используйте <code>call!</code> вместо <code>call</code>.</p>

<p>Если хотите узнать больше о <code>call</code>, смотрите спецификацию Rack.</p>

<a name='%D0%97%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20%D1%82%D0%B5%D0%BB%D0%B0,%20%D0%BA%D0%BE%D0%B4%D0%B0%20%D0%B8%20%D0%B7%D0%B0%D0%B3%D0%BE%D0%BB%D0%BE%D0%B2%D0%BA%D0%BE%D0%B2%20%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%B0'></a>
<h3>Задание тела, кода и заголовков ответа</h3>

<p>Хорошим тоном является установка кода состояния HTTP и тела ответа в
возвращаемом значении обработчика маршрута. Тем не менее, в некоторых
ситуациях вам, возможно, понадобится задать тело ответа в произвольной точке
потока исполнения. Вы можете сделать это с помощью метода-помощника <code>body</code>.
Если вы задействуете метод <code>body</code>, то вы можете использовать его и в
дальнейшем, чтобы получить доступ к телу ответа.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  body <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">bar</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

after <span style="color:#080;font-weight:bold">do</span>
  puts body
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Также можно передать блок в метод <code>body</code>, который затем будет вызван
обработчиком Rack (такой подход может быть использован для реализации
поточного ответа, см. “Возвращаемые значения”).</p>

<p>Аналогично вы можете установить код ответа и его заголовки:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  status <span style="color:#00D">418</span>
  headers \
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Allow</span><span style="color:#710">"</span></span>   =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">BREW, POST, GET, PROPFIND, WHEN</span><span style="color:#710">"</span></span>,
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Refresh</span><span style="color:#710">"</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt</span><span style="color:#710">"</span></span>
  body <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">I'm a tea pot!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Как и <code>body</code>, методы <code>headers</code> и <code>status</code>, вызванные без аргументов,
возвращают свои текущие значения.</p>

<a name='%D0%A1%D1%82%D1%80%D0%B8%D0%BC%D0%B8%D0%BD%D0%B3%20%D0%BE%D1%82%D0%B2%D0%B5%D1%82%D0%BE%D0%B2'></a>
<h3>Стриминг ответов</h3>

<p>Иногда требуется начать отправлять данные клиенту прямо в процессе
генерирования частей этих данных. В особых случаях требуется постоянно
отправлять данные до тех пор, пока клиент не закроет соединение. Вы можете
использовать метод <code>stream</code> вместо написания собственных “оберток”.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  stream <span style="color:#080;font-weight:bold">do</span> |out|
    out &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">It's gonna be legen -</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
    sleep <span style="color:#60E">0.5</span>
    out &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20"> (wait for it) </span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
    sleep <span style="color:#00D">1</span>
    out &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">- dary!</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Что позволяет вам реализовать стриминговые API,
<a href="http://dev.w3.org/html5/eventsource/">Server Sent Events</a>,
и может служить основой для <a href="http://en.wikipedia.org/wiki/WebSocket">WebSockets</a>.
Также такой подход можно использовать для увеличения производительности в случае,
когда какая-то часть контента зависит от медленного ресурса.</p>

<p>Заметьте, что возможности стриминга, особенно количество одновременно
обслуживаемых запросов, очень сильно зависят от используемого веб-сервера.
Некоторые серверы, например, WEBRick, могут и вовсе не поддерживать стриминг.
Если сервер не поддерживает стриминг, то все данные будут отправлены за один
раз сразу после того, как блок, переданный в <code>stream</code>, завершится. Стриминг
вообще не работает при использовании Shotgun.</p>

<p>Если метод используется с параметром <code>keep_open</code>, то он не будет вызывать
<code>close</code> у объекта потока, что позволит вам закрыть его позже в любом другом
месте. Это работает только с событийными серверами, например, с Thin и
Rainbows. Другие же серверы все равно будут закрывать поток:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># long polling</span>

set <span style="color:#A60">:server</span>, <span style="color:#A60">:thin</span>
connections = []

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/subscribe</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># регистрация клиента</span>
  stream(<span style="color:#A60">:keep_open</span>) { |out| connections &lt;&lt; out }

  <span style="color:#777"># удаление "мертвых клиентов"</span>
  connections.reject!(&amp;<span style="color:#A60">:closed?</span>)

  <span style="color:#777"># допуск</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">subscribed</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

post <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/message</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  connections.each <span style="color:#080;font-weight:bold">do</span> |out|
    <span style="color:#777"># уведомить клиента о новом сообщении</span>
    out &lt;&lt; params[<span style="color:#A60">:message</span>] &lt;&lt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#b0b">\n</span><span style="color:#710">"</span></span>

    <span style="color:#777"># указать клиенту на необходимость снова соединиться</span>
    out.close
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#777"># допуск</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">message received</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%9B%D0%BE%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5'></a>
<h3>Логирование</h3>

<p>В области видимости запроса метод <code>logger</code> предоставляет доступ к экземпляру
<code>Logger</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  logger.info <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">loading data</span><span style="color:#710">"</span></span>
  <span style="color:#777"># ...</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Этот логер автоматически учитывает ваши настройки логирования в Rack. Если
логирование выключено, то этот метод вернет пустой (dummy) объект, поэтому вы
можете смело использовать его в маршрутах и фильтрах.</p>

<p>Заметьте, что логирование включено по умолчанию только для
<code>Sinatra::Application</code>, а если ваше приложение — подкласс <code>Sinatra::Base</code>, то
вы, наверное, захотите включить его вручную:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  configure <span style="color:#A60">:production</span>, <span style="color:#A60">:development</span> <span style="color:#080;font-weight:bold">do</span>
    enable <span style="color:#A60">:logging</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Чтобы избежать использования любой логирующей “прослойки”, задайте опции
<code>logging</code> значение <code>nil</code>. Тем не менее, не забывайте, что в такой ситуации
<code>logger</code> вернет <code>nil</code>. Чаще всего так делают, когда задают свой собственный
логер. Sinatra будет использовать то, что находится в <code>env['rack.logger']</code>.</p>

<a name='Mime-%D1%82%D0%B8%D0%BF%D1%8B'></a>
<h3>Mime-типы</h3>

<p>Когда вы используете <code>send_file</code> или статические файлы, у вас могут быть
mime-типы, которые Sinatra не понимает по умолчанию. Используйте <code>mime_type</code>
для их регистрации по расширению файла:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#080;font-weight:bold">do</span>
  mime_type <span style="color:#A60">:foo</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">text/foo</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Вы также можете использовать это в <code>content_type</code> методе-помощнике:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  content_type <span style="color:#A60">:foo</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">foo foo foo</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%93%D0%B5%D0%BD%D0%B5%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20URL'></a>
<h3>Генерирование URL</h3>

<p>Чтобы сформировать URL, вам следует использовать метод <code>url</code>, например, в Haml:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>%a{<span style="color:#A60">:href</span> =&gt; url(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span>)} foo
</pre></div>
</div>
</div>

<p>Этот метод учитывает обратные прокси и маршрутизаторы Rack, если они
присутствуют.</p>

<p>Наряду с <code>url</code> вы можете использовать <code>to</code> (смотрите пример ниже).</p>

<a name='%D0%9F%D0%B5%D1%80%D0%B5%D0%BD%D0%B0%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20(%D1%80%D0%B5%D0%B4%D0%B8%D1%80%D0%B5%D0%BA%D1%82)'></a>
<h3>Перенаправление (редирект)</h3>

<p>Вы можете перенаправить браузер пользователя с помощью метода <code>redirect</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>)
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Любые дополнительные параметры используются по аналогии с аргументами метода
<code>halt</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>), <span style="color:#00D">303</span>
redirect <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">http://google.com</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">wrong place, buddy</span><span style="color:#710">'</span></span>
</pre></div>
</div>
</div>

<p>Вы также можете перенаправить пользователя обратно, на страницу, с которой он
пришел, с помощью <code>redirect back</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">&lt;a href='/bar'&gt;do something&lt;/a&gt;</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  do_something
  redirect back
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Чтобы передать какие-либо параметры вместе с перенаправлением, либо добавьте
их в строку запроса:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar?sum=42</span><span style="color:#710">'</span></span>)
</pre></div>
</div>
</div>

<p>либо используйте сессию:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>enable <span style="color:#A60">:sessions</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:secret</span>] = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo</span><span style="color:#710">'</span></span>
  redirect to(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span>)
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/bar</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  session[<span style="color:#A60">:secret</span>]
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%A3%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%BA%D1%8D%D1%88%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%D0%BC'></a>
<h3>Управление кэшированием</h3>

<p>Установка корректных заголовков — основа правильного HTTP кэширования.</p>

<p>Вы можете легко выставить заголовок Cache-Control таким образом:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  cache_control <span style="color:#A60">:public</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">cache it!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Совет: задавайте кэширование в <code>before</code>-фильтре:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#080;font-weight:bold">do</span>
  cache_control <span style="color:#A60">:public</span>, <span style="color:#A60">:must_revalidate</span>, <span style="color:#A60">:max_age</span> =&gt; <span style="color:#00D">60</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Если вы используете метод <code>expires</code> для задания соответствующего заголовка, то
<code>Cache-Control</code> будет выставлен автоматически:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before <span style="color:#080;font-weight:bold">do</span>
  expires <span style="color:#00D">500</span>, <span style="color:#A60">:public</span>, <span style="color:#A60">:must_revalidate</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Чтобы как следует использовать кэширование, вам следует подумать об
использовании <code>etag</code> или <code>last_modified</code>. Рекомендуется использовать эти
методы-помощники <em>до</em> выполнения ресурсоемких вычислений, так как они
немедленно отправят ответ клиенту, если текущая версия уже есть в их кэше:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/article/:id</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#33B">@article</span> = <span style="color:#036;font-weight:bold">Article</span>.find params[<span style="color:#A60">:id</span>]
  last_modified <span style="color:#33B">@article</span>.updated_at
  etag <span style="color:#33B">@article</span>.sha1
  erb <span style="color:#A60">:article</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Также вы можете использовать
<a href="http://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation">weak ETag</a>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>etag <span style="color:#33B">@article</span>.sha1, <span style="color:#A60">:weak</span>
</pre></div>
</div>
</div>

<p>Эти методы-помощники не станут ничего кэшировать для вас, но они дадут
необходимую информацию для вашего кэша. Если вы ищете легкое решение для
кэширования, попробуйте <a href="https://github.com/rtomayko/rack-cache">rack-cache</a>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rack/cache</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Cache</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  cache_control <span style="color:#A60">:public</span>, <span style="color:#A60">:max_age</span> =&gt; <span style="color:#00D">36000</span>
  sleep <span style="color:#00D">5</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hello</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Используйте опцию <code>:static_cache_control</code> (см. ниже), чтобы добавить заголовок
<code>Cache-Control</code> к статическим файлам.</p>

<p>В соответствии с RFC 2616 ваше приложение должно вести себя по-разному, когда
заголовки If-Match или If-None-Match имеют значение <code>*</code>, в зависимости от
того, существует или нет запрашиваемый ресурс. Sinatra предполагает, что
ресурсы, к которым обращаются с помощью безопасных (GET) и идемпотентных (PUT)
методов, уже существуют, а остальные ресурсы (к которым обращаются, например,
с помощью POST) считает новыми. Вы можете изменить данное поведение с помощью
опции <code>:new_resource</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/create</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  etag <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#710">'</span></span>, <span style="color:#A60">:new_resource</span> =&gt; <span style="color:#069">true</span>
  <span style="color:#036;font-weight:bold">Article</span>.create
  erb <span style="color:#A60">:new_article</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Если вы хотите использовать weak ETag, задайте опцию <code>:kind</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>etag <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#710">'</span></span>, <span style="color:#A60">:new_resource</span> =&gt; <span style="color:#069">true</span>, <span style="color:#A60">:kind</span> =&gt; <span style="color:#A60">:weak</span>
</pre></div>
</div>
</div>

<a name='%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0%20%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2'></a>
<h3>Отправка файлов</h3>

<p>Для отправки файлов пользователю вы можете использовать метод <code>send_file</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  send_file <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo.png</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Этот метод имеет несколько опций:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>send_file <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo.png</span><span style="color:#710">'</span></span>, <span style="color:#A60">:type</span> =&gt; <span style="color:#A60">:jpg</span>
</pre></div>
</div>
</div>

<p>Возможные опции:</p>

<dl>
<dt>filename</dt>
  <dd>имя файла, по умолчанию: реальное имя файла.</dd>

  <dt>last_modified</dt>
  <dd>значение для заголовка Last-Modified, по умолчанию: mtime (время
      изменения) файла.</dd>

  <dt>type</dt>
  <dd>тип файла, по умолчанию: определяется по расширению файла.</dd>

  <dt>disposition</dt>
  <dd>используется для заголовка Content-Disposition, возможные значения: <tt>nil</tt>
      (по умолчанию), <tt>:attachment</tt> и <tt>:inline</tt>.</dd>

  <dt>length</dt>
  <dd>значения для заголовка Content-Length, по умолчанию: размер файла.</dd>

  <dt>status</dt>
  <dd>Код ответа. Полезно, когда отдается статический файл в качестве страницы с
      сообщением об ошибке.</dd>
</dl>
<p>Этот метод будет использовать возможности Rack сервера для отправки файлов,
если они доступны, в противном случае будет напрямую отдавать файл из Ruby
процесса. Метод <code>send_file</code> также обеспечивает автоматическую обработку
частичных (range) запросов с помощью Sinatra.</p>

<a name='%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%20%D0%BA%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D1%83%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0'></a>
<h3>Доступ к объекту запроса</h3>

<p>Объект входящего запроса доступен на уровне обработки запроса (в фильтрах,
маршрутах, обработчиках ошибок) с помощью <code>request</code> метода:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># приложение запущено на http://example.com/example</span>
get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  t = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">%w[</span><span style="color:#D20">text/css text/html application/javascript</span><span style="color:#710">]</span></span>
  request.accept              <span style="color:#777"># ['text/html', '*/*']</span>
  request.accept? <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">text/xml</span><span style="color:#710">'</span></span>  <span style="color:#777"># true</span>
  request.preferred_type(t)   <span style="color:#777"># 'text/html'</span>
  request.body                <span style="color:#777"># тело запроса, посланное клиентом (см. ниже)</span>
  request.scheme              <span style="color:#777"># "http"</span>
  request.script_name         <span style="color:#777"># "/example"</span>
  request.path_info           <span style="color:#777"># "/foo"</span>
  request.port                <span style="color:#777"># 80</span>
  request.request_method      <span style="color:#777"># "GET"</span>
  request.query_string        <span style="color:#777"># ""</span>
  request.content_length      <span style="color:#777"># длина тела запроса</span>
  request.media_type          <span style="color:#777"># медиатип тела запроса</span>
  request.host                <span style="color:#777"># "example.com"</span>
  request.get?                <span style="color:#777"># true (есть аналоги для других методов HTTP)</span>
  request.form_data?          <span style="color:#777"># false</span>
  request[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">some_param</span><span style="color:#710">"</span></span>]       <span style="color:#777"># значение параметра some_param. Шорткат для хеша params</span>
  request.referrer            <span style="color:#777"># источник запроса клиента либо '/'</span>
  request.user_agent          <span style="color:#777"># user agent (используется для :agent условия)</span>
  request.cookies             <span style="color:#777"># хеш, содержащий cookies браузера</span>
  request.xhr?                <span style="color:#777"># является ли запрос ajax запросом?</span>
  request.url                 <span style="color:#777"># "http://example.com/example/foo"</span>
  request.path                <span style="color:#777"># "/example/foo"</span>
  request.ip                  <span style="color:#777"># IP-адрес клиента</span>
  request.secure?             <span style="color:#777"># false (true, если запрос сделан через SSL)</span>
  request.forwarded?          <span style="color:#777"># true (если сервер работает за обратным прокси)</span>
  request.env                 <span style="color:#777"># "сырой" env хеш, полученный Rack</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Некоторые опции, такие как <code>script_name</code> или <code>path_info</code>, доступны для
изменения:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>before { request.path_info = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="color:#710">"</span></span> }

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">all requests end up here</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p><code>request.body</code> является IO или StringIO объектом:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>post <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/api</span><span style="color:#710">"</span></span> <span style="color:#080;font-weight:bold">do</span>
  request.body.rewind  <span style="color:#777"># в случае, если кто-то уже прочитал тело запроса</span>
  data = <span style="color:#036;font-weight:bold">JSON</span>.parse request.body.read
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hello </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>data[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">name</span><span style="color:#710">'</span></span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%92%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F'></a>
<h3>Вложения</h3>

<p>Вы можете использовать метод <code>attachment</code>, чтобы сказать браузеру, что ответ
сервера должен быть сохранен на диск, а не отображен:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  attachment
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">store it!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Вы также можете указать имя файла:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  attachment <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">info.txt</span><span style="color:#710">"</span></span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">store it!</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%A0%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%20%D1%81%D0%BE%20%D0%B2%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%B5%D0%BC%20%D0%B8%20%D0%B4%D0%B0%D1%82%D0%B0%D0%BC%D0%B8'></a>
<h3>Работа со временем и датами</h3>

<p>Sinatra предлагает метод-помощник <code>time_for</code>, который из заданного значения
создает объект Time. Он также может конвертировать <code>DateTime</code>, <code>Date</code> и
подобные классы:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  pass <span style="color:#080;font-weight:bold">if</span> <span style="color:#036;font-weight:bold">Time</span>.now &gt; time_for(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Dec 23, 2012</span><span style="color:#710">'</span></span>)
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">still time</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Этот метод используется внутри Sinatra методами <code>expires</code>, <code>last_modified</code> и
им подобными. Поэтому вы легко можете расширить функционал этих методов,
переопределив <code>time_for</code> в своем приложении:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">time_for</span>(value)
    <span style="color:#080;font-weight:bold">case</span> value
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#A60">:yesterday</span> <span style="color:#080;font-weight:bold">then</span> <span style="color:#036;font-weight:bold">Time</span>.now - <span style="color:#00D">24</span>*<span style="color:#00D">60</span>*<span style="color:#00D">60</span>
    <span style="color:#080;font-weight:bold">when</span> <span style="color:#A60">:tomorrow</span>  <span style="color:#080;font-weight:bold">then</span> <span style="color:#036;font-weight:bold">Time</span>.now + <span style="color:#00D">24</span>*<span style="color:#00D">60</span>*<span style="color:#00D">60</span>
    <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">super</span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  last_modified <span style="color:#A60">:yesterday</span>
  expires <span style="color:#A60">:tomorrow</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hello</span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%9F%D0%BE%D0%B8%D1%81%D0%BA%20%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D0%BE%D0%B2'></a>
<h3>Поиск шаблонов</h3>

<p>Для поиска шаблонов и их последующего рендеринга используется метод
<code>find_template</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>find_template settings.views, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">foo</span><span style="color:#710">'</span></span>, <span style="color:#036;font-weight:bold">Tilt</span>[<span style="color:#A60">:haml</span>] <span style="color:#080;font-weight:bold">do</span> |file|
  puts <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">could be </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>file<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Это не слишком полезный пример. Зато полезен тот факт, что вы можете
переопределить этот метод, чтобы использовать свой собственный механизм
поиска. Например, если вы хотите, чтобы можно было использовать несколько
директорий с шаблонами:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:views</span>, [<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">views</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">templates</span><span style="color:#710">'</span></span>]

helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">find_template</span>(views, name, engine, &amp;block)
    Array(views).each { |v| <span style="color:#080;font-weight:bold">super</span>(v, name, engine, &amp;block) }
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Другой пример, в котором используются разные директории для движков
рендеринга:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:views</span>, <span style="color:#A60">:sass</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">views/sass</span><span style="color:#710">'</span></span>, <span style="color:#A60">:haml</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">templates</span><span style="color:#710">'</span></span>, <span style="color:#A60">:default</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">views</span><span style="color:#710">'</span></span>

helpers <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">find_template</span>(views, name, engine, &amp;block)
    _, folder = views.detect { |k,v| engine == <span style="color:#036;font-weight:bold">Tilt</span>[k] }
    folder ||= views[<span style="color:#A60">:default</span>]
    <span style="color:#080;font-weight:bold">super</span>(folder, name, engine, &amp;block)
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Вы можете легко вынести этот код в расширение и поделиться им с остальными!</p>

<p>Заметьте, что <code>find_template</code> не проверяет, существует ли файл на самом деле,
а вызывает заданный блок для всех возможных путей. Дело тут не в
производительности, дело в том, что <code>render</code> вызовет <code>break</code>, как только файл
не будет найден. Содержимое и местонахождение шаблонов будет закэшировано,
если приложение запущено не в режиме разработки (<code>set :environment,
:development</code>). Вы должны помнить об этих нюансах,  если пишите по-настоящему
“сумасшедший” метод.</p>

<a name='%D0%9A%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D1%8F'></a>
<h2>Конфигурация</h2>

<p>Этот блок исполняется один раз при старте в любом окружении, режиме
(environment):</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#777"># задание одной опции</span>
  set <span style="color:#A60">:option</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">value</span><span style="color:#710">'</span></span>

  <span style="color:#777"># устанавливаем несколько опций</span>
  set <span style="color:#A60">:a</span> =&gt; <span style="color:#00D">1</span>, <span style="color:#A60">:b</span> =&gt; <span style="color:#00D">2</span>

  <span style="color:#777"># то же самое, что и `set :option, true`</span>
  enable <span style="color:#A60">:option</span>

  <span style="color:#777"># то же самое, что и `set :option, false`</span>
  disable <span style="color:#A60">:option</span>

  <span style="color:#777"># у вас могут быть "динамические" опции с блоками</span>
  set(<span style="color:#A60">:css_dir</span>) { <span style="color:#036;font-weight:bold">File</span>.join(views, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">css</span><span style="color:#710">'</span></span>) }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Будет запущено, когда окружение (RACK_ENV переменная) <code>:production</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#A60">:production</span> <span style="color:#080;font-weight:bold">do</span>
  ...
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Будет запущено, когда окружение <code>:production</code> или <code>:test</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#A60">:production</span>, <span style="color:#A60">:test</span> <span style="color:#080;font-weight:bold">do</span>
  ...
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Вы можете получить доступ к этим опциям с помощью <code>settings</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>configure <span style="color:#080;font-weight:bold">do</span>
  set <span style="color:#A60">:foo</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bar</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  settings.foo? <span style="color:#777"># =&gt; true</span>
  settings.foo  <span style="color:#777"># =&gt; 'bar'</span>
  ...
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D0%B7%D0%B0%D1%89%D0%B8%D1%82%D1%8B%20%D0%BE%D1%82%20%D0%B0%D1%82%D0%B0%D0%BA'></a>
<h3>Настройка защиты от атак</h3>

<p>Sinatra использует
<a href="https://github.com/rkh/rack-protection#readme">Rack::Protection</a> для защиты
приложения от простых атак. Вы можете легко выключить эту защиту (что сделает
ваше приложение чрезвычайно уязвимым):</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>disable <span style="color:#A60">:protection</span>
</pre></div>
</div>
</div>

<p>Чтобы пропустить какой-либо уровень защиты, передайте хеш опций в параметр
<code>protection</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:protection</span>, <span style="color:#A60">:except</span> =&gt; <span style="color:#A60">:path_traversal</span>
</pre></div>
</div>
</div>

<p>Вы также можете отключить сразу несколько уровней защиты:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>set <span style="color:#A60">:protection</span>, <span style="color:#A60">:except</span> =&gt; [<span style="color:#A60">:path_traversal</span>, <span style="color:#A60">:session_hijacking</span>]
</pre></div>
</div>
</div>

<a name='%D0%94%D0%BE%D1%81%D1%82%D1%83%D0%BF%D0%BD%D1%8B%D0%B5%20%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8'></a>
<h3>Доступные настройки</h3>

<dl>
<dt>absolute_redirects</dt>
  <dd>
    если отключено, то Sinatra будет позволять использование относительных
    перенаправлений, но при этом перестанет соответствовать RFC 2616 (HTTP
    1.1), который разрешает только абсолютные перенаправления.
  </dd>
  <dd>
    Включайте эту опцию, если ваше приложение работает за обратным прокси,
    который настроен не совсем корректно. Обратите внимание, метод <tt>url</tt> все
    равно будет генерировать абсолютные URL, если вы не передадите <tt>false</tt>
    вторым аргументом.
  </dd>
  <dd>Отключено по умолчанию.</dd>

  <dt>add_charsets</dt>
  <dd>
    mime-типы, к которым метод <tt>content_type</tt> будет автоматически добавлять
    информацию о кодировке. Вам следует добавлять значения к этой опции
    вместо ее переопределения: <tt>settings.add_charsets &lt;&lt; "application/foobar"</tt>
  </dd>

  <dt>app_file</dt>
  <dd>
    путь к главному файлу приложения, используется для нахождения корневой
    директории проекта, директорий с шаблонами и статическими файлами,
    вложенных шаблонов.
  </dd>

  <dt>bind</dt>
  <dd>
    используемый IP-адрес (по умолчанию: 0.0.0.0). Используется только
    встроенным сервером.
  </dd>

  <dt>default_encoding</dt>
  <dd>кодировка, если неизвестна (по умолчанию: <tt>"utf-8"</tt>).</dd>

  <dt>dump_errors</dt>
  <dd>отображать ошибки в логе.</dd>

  <dt>environment</dt>
  <dd>
    текущее окружение, по умолчанию, значение <tt>ENV['RACK_ENV']</tt> или
    <tt>"development"</tt>, если <tt>ENV['RACK_ENV']</tt> недоступна.
  </dd>

  <dt>logging</dt>
  <dd>использовать логер.</dd>

  <dt>lock</dt>
  <dd>
    создает блокировку для каждого запроса, которая гарантирует обработку
    только одного запроса в текущий момент времени в Ruby процессе.
  </dd>
  <dd>
    Включайте, если ваше приложение не потоко-безопасно (thread-safe).
    Отключено по умолчанию.</dd>

  <dt>method_override</dt>
  <dd>
    использовать "магический" параметр <tt>_method</tt>, для поддержки
    PUT/DELETE форм в браузерах, которые не поддерживают эти методы.
  </dd>

  <dt>port</dt>
  <dd>
    порт, на котором будет работать сервер.
    Используется только встроенным сервером.
  </dd>

  <dt>prefixed_redirects</dt>
  <dd>
    добавлять или нет параметр <tt>request.script_name</tt> к редиректам, если не
    задан абсолютный путь. Таким образом, <tt>redirect '/foo'</tt> будет вести себя
    как <tt>redirect to('/foo')</tt>. Отключено по умолчанию.
  </dd>

  <dt>protection</dt>
  <dd>включена или нет защита от атак. Смотрите секцию выше.</dd>

  <dt>public_dir</dt>
  <dd>Алиас для <tt>public_folder</tt>.</dd>

  <dt>public_folder</dt>
  <dd>
    путь к директории, откуда будут раздаваться статические файлы.
    Используется, только если включена раздача статических файлов
    (см. опцию <tt>static</tt> ниже).
  </dd>

  <dt>reload_templates</dt>
  <dd>
    перезагружать или нет шаблоны на каждый запрос. Включено в режиме
    разработки.
  </dd>

  <dt>root</dt>
  <dd>путь к корневой директории проекта.</dd>

  <dt>raise_errors</dt>
  <dd>
    выбрасывать исключения (будет останавливать приложение).
    По умолчанию включено только в окружении <tt>test</tt>.
  </dd>

  <dt>run</dt>
  <dd>
    если включено, Sinatra будет самостоятельно запускать веб-сервер. Не
    включайте, если используете rackup или аналогичные средства.
  </dd>

  <dt>running</dt>
  <dd>работает ли сейчас встроенный сервер? Не меняйте эту опцию!</dd>

  <dt>server</dt>
  <dd>
    сервер или список серверов, которые следует использовать в качестве
    встроенного сервера. По умолчанию: <tt>['thin', 'mongrel', 'webrick']</tt>, порядок
    задает приоритет.</dd>

  <dt>sessions</dt>
  <dd>
    включить сессии на основе кук (cookie) на базе <tt>Rack::Session::Cookie</tt>.
    Смотрите секцию "Использование сессий" выше.
  </dd>

  <dt>show_exceptions</dt>
  <dd>
    показывать исключения/стек вызовов (stack trace) в браузере. По умолчанию
    включено только в окружении <tt>development</tt>.
  </dd>
  <dd>
    Может быть установлено в
    <tt>:after_handler</tt> для запуска специфичной для приложения обработки ошибок,
    перед показом трассировки стека в браузере.
  </dd>

  <dt>static</dt>
  <dd>должна ли Sinatra осуществлять раздачу статических файлов.</dd>
  <dd>Отключите, когда используете какой-либо веб-сервер для этой цели.</dd>
  <dd>Отключение значительно улучшит производительность приложения.</dd>
  <dd>По умолчанию включено в классических и отключено в модульных приложениях.</dd>

  <dt>static_cache_control</dt>
  <dd>
    когда Sinatra отдает статические файлы, используйте эту опцию, чтобы
    добавить им заголовок <tt>Cache-Control</tt>. Для этого используется
    метод-помощник <tt>cache_control</tt>. По умолчанию отключено.
  </dd>
  <dd>
    Используйте массив, когда надо задать несколько значений:
    <tt>set :static_cache_control, [:public, :max_age =&gt; 300]</tt>
  </dd>

  <dt>threaded</dt>
  <dd>
    если включено, то Thin будет использовать <tt>EventMachine.defer</tt> для
    обработки запросов.
  </dd>

  <dt>traps</dt>
  <dd>должна ли Синатра обрабатывать системные сигналы или нет.</dd>

  <dt>views</dt>
  <dd>путь к директории с шаблонами.</dd>
</dl>
<a name='%D0%A0%D0%B5%D0%B6%D0%B8%D0%BC,%20%D0%BE%D0%BA%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5'></a>
<h2>Режим, окружение</h2>

<p>Есть 3 предопределенных режима, окружения: <code>"development"</code>, <code>"production"</code> и
<code>"test"</code>. Режим может быть задан через переменную окружения <code>RACK_ENV</code>.
Значение по умолчанию — <code>"development"</code>. В этом режиме работы все шаблоны
перезагружаются между запросами. А также задаются специальные обработчики
<code>not_found</code> и <code>error</code>, чтобы вы могли увидеть стек вызовов. В окружениях
<code>"production"</code> и <code>"test"</code> шаблоны по умолчанию кэшируются.</p>

<p>Для запуска приложения в определенном окружении используйте ключ <code>-e</code></p>

<pre><code>ruby my_app.rb -e [ENVIRONMENT]
</code></pre>

<p>Вы можете использовать предопределенные методы <code>development?</code>, <code>test?</code> и
+production?, чтобы определить текущее окружение.</p>

<a name='%D0%9E%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0%20%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA'></a>
<h2>Обработка ошибок</h2>

<p>Обработчики ошибок исполняются в том же контексте, что и маршруты, и
<code>before</code>-фильтры, а это означает, что всякие прелести вроде <code>haml</code>, <code>erb</code>,
<code>halt</code> и т.д. доступны и им.</p>

<a name='Not%20Found'></a>
<h3>Not Found</h3>

<p>Когда выброшено исключение <code>Sinatra::NotFound</code>, или кодом ответа является 404,
то будет вызван <code>not_found</code> обработчик:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>not_found <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">This is nowhere to be found.</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%9E%D1%88%D0%B8%D0%B1%D0%BA%D0%B8'></a>
<h3>Ошибки</h3>

<p>Обработчик ошибок <code>error</code> будет вызван, когда исключение выброшено из блока
маршрута, либо из фильтра. Объект-исключение доступен как переменная
<code>sinatra.error</code> в Rack:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Sorry there was a nasty error - </span><span style="color:#710">'</span></span> + env[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra.error</span><span style="color:#710">'</span></span>].name
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Конкретные ошибки:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#036;font-weight:bold">MyCustomError</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">So what happened was...</span><span style="color:#710">'</span></span> + env[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra.error</span><span style="color:#710">'</span></span>].message
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Тогда, если это произошло:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  raise <span style="color:#036;font-weight:bold">MyCustomError</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">something bad</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>То вы получите:</p>

<pre><code>So what happened was... something bad
</code></pre>

<p>Также вы можете установить обработчик ошибок для кода состояния HTTP:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#00D">403</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Access forbidden</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/secret</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="color:#00D">403</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Либо набора кодов:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>error <span style="color:#00D">400</span>..<span style="color:#00D">510</span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Boom</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Sinatra устанавливает специальные <code>not_found</code> и <code>error</code> обработчики, когда
приложение запущено в режиме разработки (окружение <code>:development</code>).</p>

<a name='Rack%20%E2%80%9C%D0%BF%D1%80%D0%BE%D1%81%D0%BB%D0%BE%D0%B9%D0%BA%D0%B8%E2%80%9D'></a>
<h2>Rack “прослойки”</h2>

<p>Sinatra использует <a href="http://rack.rubyforge.org/">Rack</a>, минимальный стандартный
интерфейс для веб-фреймворков на Ruby. Одной из самых интересных для
разработчиков возможностей Rack является поддержка “прослоек” (“middleware”) —
компонентов, находящихся “между” сервером и вашим приложением, которые
отслеживают и/или манипулируют HTTP запросами/ответами для предоставления
различной функциональности.</p>

<p>В Sinatra очень просто использовать такие “прослойки” с помощью метода <code>use</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">my_custom_middleware</span><span style="color:#710">'</span></span>

use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Lint</span>
use <span style="color:#036;font-weight:bold">MyCustomMiddleware</span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/hello</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello World</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Семантика <code>use</code> идентична той, что определена для
<a href="http://rack.rubyforge.org/doc/classes/Rack/Builder.html">Rack::Builder</a> DSL
(чаще всего используется в rackup файлах). Например, метод <code>use</code> принимает как
множественные переменные, так и блоки:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>use <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Auth</span>::<span style="color:#036;font-weight:bold">Basic</span> <span style="color:#080;font-weight:bold">do</span> |username, password|
  username == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">admin</span><span style="color:#710">'</span></span> &amp;&amp; password == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">secret</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Rack распространяется с различными стандартными “прослойками” для логирования,
отладки, маршрутизации URL, аутентификации, обработки сессий. Sinatra
использует многие из этих компонентов автоматически, основываясь на
конфигурации, чтобы вам не приходилось подключать (<code>use</code>) их вручную.</p>

<p>Вы можете найти полезные прослойки в
<a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>,
<a href="https://github.com/rack/rack-contrib#readme">rack-contrib</a>,
или в
<a href="https://github.com/rack/rack/wiki/List-of-Middleware">Rack wiki</a>.</p>

<a name='%D0%A2%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5'></a>
<h2>Тестирование</h2>

<p>Тесты для Sinatra приложений могут быть написаны с помощью библиотек,
фреймворков, поддерживающих тестирование Rack.
<a href="http://rdoc.info/github/brynary/rack-test/master/frames">Rack::Test</a>
рекомендован:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">my_sinatra_app</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">test/unit</span><span style="color:#710">'</span></span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">rack/test</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyAppTest</span> &lt; <span style="color:#036;font-weight:bold">Test</span>::<span style="color:#036;font-weight:bold">Unit</span>::<span style="color:#036;font-weight:bold">TestCase</span>
  include <span style="color:#036;font-weight:bold">Rack</span>::<span style="color:#036;font-weight:bold">Test</span>::<span style="color:#036;font-weight:bold">Methods</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">app</span>
    <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Application</span>
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_my_default</span>
    get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>
    assert_equal <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello World!</span><span style="color:#710">'</span></span>, last_response.body
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_with_params</span>
    get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/meet</span><span style="color:#710">'</span></span>, <span style="color:#A60">:name</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Frank</span><span style="color:#710">'</span></span>
    assert_equal <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello Frank!</span><span style="color:#710">'</span></span>, last_response.body
  <span style="color:#080;font-weight:bold">end</span>

  <span style="color:#080;font-weight:bold">def</span> <span style="color:#06B;font-weight:bold">test_with_rack_env</span>
    get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>, {}, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">HTTP_USER_AGENT</span><span style="color:#710">'</span></span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Songbird</span><span style="color:#710">'</span></span>
    assert_equal <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">You're using Songbird!</span><span style="color:#710">"</span></span>, last_response.body
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='Sinatra::Base%20%E2%80%94%20%E2%80%9C%D0%BF%D1%80%D0%BE%D1%81%D0%BB%D0%BE%D0%B9%D0%BA%D0%B8%E2%80%9D,%20%D0%B1%D0%B8%D0%B1%D0%BB%D0%B8%D0%BE%D1%82%D0%B5%D0%BA%D0%B8%20%D0%B8%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F'></a>
<h2>Sinatra::Base — “прослойки”, библиотеки и модульные приложения</h2>

<p>Описание своего приложения самым простейшим способом (с помощью DSL верхнего
уровня, классический стиль) отлично работает для крохотных приложений. В таких
случаях используется конфигурация, рассчитанная на  микро-приложения
(единственный файл приложения, <code>./public</code> и <code>./views</code> директории, логирование,
страница информации об исключении и т.д.). Тем не менее, такой метод имеет
множество недостатков при создании компонентов, таких как Rack middleware
(“прослоек”), Rails metal, простых библиотек с серверными компонентами,
расширений Sinatra. И тут на помощь приходит <code>Sinatra::Base</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  set <span style="color:#A60">:sessions</span>, <span style="color:#069">true</span>
  set <span style="color:#A60">:foo</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">bar</span><span style="color:#710">'</span></span>

  get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello world!</span><span style="color:#710">'</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Методы, доступные <code>Sinatra::Base</code> подклассам идентичны тем, что доступны
приложениям в DSL верхнего уровня. Большинство таких приложений могут быть
конвертированы в <code>Sinatra::Base</code> компоненты с помощью двух модификаций:</p>

<ul>
<li>Вы должны подключать <code>sinatra/base</code> вместо <code>sinatra</code>, иначе все методы,
предоставляемые Sinatra, будут импортированы в глобальное пространство
имен.</li>
  <li>Поместите все маршруты, обработчики ошибок, фильтры и опции в подкласс
<code>Sinatra::Base</code>.</li>
</ul>
<p><code>Sinatra::Base</code> — это чистый лист. Большинство опций, включая встроенный
сервер, по умолчанию отключены. Смотрите
<a href="http://www.sinatrarb.com/configuration.html">Опции и конфигурация</a>
для детальной информации об опциях и их поведении.</p>

<a name='%D0%9C%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20%D0%BF%D1%80%D0%BE%D1%82%D0%B8%D0%B2%20%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85'></a>
<h3>Модульные приложения против классических</h3>

<p>Вопреки всеобщему убеждению, в классическом стиле (самом простом) нет ничего
плохого. Если этот стиль подходит вашему приложению, вы не обязаны
переписывать его в модульное приложение.</p>

<p>Основным недостатком классического стиля является тот факт, что у вас может
быть только одно приложение Sinatra на один процесс Ruby. Если вы планируете
использовать больше, переключайтесь на модульный стиль. Вы можете смело
смешивать модульный и классический стили.</p>

<p>Переходя с одного стиля на другой, примите во внимание следующие изменения в
настройках:</p>

<pre><code>Опция               Классический            Модульный

app_file            файл с приложением      файл с подклассом Sinatra::Base
run                 $0 == app_file          false
logging             true                    false
method_override     true                    false
inline_templates    true                    false
static              true                    false
</code></pre>

<a name='%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA%20%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8C%D0%BD%D1%8B%D1%85%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9'></a>
<h3>Запуск модульных приложений</h3>

<p>Есть два общепринятых способа запускать модульные приложения: запуск напрямую
с помощью <code>run!</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># my_app.rb</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># ... здесь код приложения ...</span>

  <span style="color:#777"># запускаем сервер, если исполняется текущий файл</span>
  run! <span style="color:#080;font-weight:bold">if</span> app_file == <span style="color:#d70">$0</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Затем:</p>

<pre><code>ruby my_app.rb
</code></pre>

<p>Или с помощью конфигурационного файла <code>config.ru</code>, который позволяет
использовать любой Rack-совместимый сервер приложений.</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># config.ru</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">./my_app</span><span style="color:#710">'</span></span>
run <span style="color:#036;font-weight:bold">MyApp</span>
</pre></div>
</div>
</div>

<p>Запускаем:</p>

<pre><code>rackup -p 4567
</code></pre>

<a name='%D0%97%D0%B0%D0%BF%D1%83%D1%81%D0%BA%20%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D1%85%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9%20%D1%81%20config.ru'></a>
<h3>Запуск классических приложений с config.ru</h3>

<p>Файл приложения:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># app.rb</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>

get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
  <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">Hello world!</span><span style="color:#710">'</span></span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>И соответствующий <code>config.ru</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">./app</span><span style="color:#710">'</span></span>
run <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Application</span>
</pre></div>
</div>
</div>

<a name='%D0%9A%D0%BE%D0%B3%D0%B4%D0%B0%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D1%8C%20config.ru?'></a>
<h3>Когда использовать config.ru?</h3>

<p>Вот несколько причин, по которым вы, возможно, захотите использовать
<code>config.ru</code>:</p>

<ul>
<li>вы хотите разворачивать свое приложение на различных Rack-совместимых
серверах (Passenger, Unicorn, Heroku, …);</li>
  <li>вы хотите использовать более одного подкласса <code>Sinatra::Base</code>;</li>
  <li>вы хотите использовать Sinatra только в качестве “прослойки” Rack.</li>
</ul>
<p><strong>Совсем необязательно переходить на использование <code>config.ru</code> лишь потому,
что вы стали использовать модульный стиль приложения. И необязательно
использовать модульный стиль, чтобы запускать приложение с помощью
<code>config.ru</code>.</strong></p>

<a name='%D0%98%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20Sinatra%20%D0%B2%20%D0%BA%D0%B0%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%B5%20%E2%80%9C%D0%BF%D1%80%D0%BE%D1%81%D0%BB%D0%BE%D0%B9%D0%BA%D0%B8%E2%80%9D'></a>
<h3>Использование Sinatra в качестве “прослойки”</h3>

<p>Не только сама Sinatra может использовать “прослойки” Rack, но и любое Sinatra
приложение само может быть добавлено к любому Rack endpoint в качестве
“прослойки”. Этим endpoint (конечной точкой) может быть другое Sinatra
приложение, или приложение, основанное на Rack (Rails/Ramaze/Camping/…):</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">LoginScreen</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  enable <span style="color:#A60">:sessions</span>

  get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/login</span><span style="color:#710">'</span></span>) { haml <span style="color:#A60">:login</span> }

  post(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/login</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">if</span> params[<span style="color:#A60">:name</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">admin</span><span style="color:#710">'</span></span> &amp;&amp; params[<span style="color:#A60">:password</span>] == <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">admin</span><span style="color:#710">'</span></span>
      session[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user_name</span><span style="color:#710">'</span></span>] = params[<span style="color:#A60">:name</span>]
    <span style="color:#080;font-weight:bold">else</span>
      redirect <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/login</span><span style="color:#710">'</span></span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># "прослойка" будет запущена перед фильтрами</span>
  use <span style="color:#036;font-weight:bold">LoginScreen</span>

  before <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#080;font-weight:bold">unless</span> session[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user_name</span><span style="color:#710">'</span></span>]
      halt <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Access denied, please &lt;a href='/login'&gt;login&lt;/a&gt;.</span><span style="color:#710">"</span></span>
    <span style="color:#080;font-weight:bold">end</span>
  <span style="color:#080;font-weight:bold">end</span>

  get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Hello </span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>session[<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">user_name</span><span style="color:#710">'</span></span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#D20">.</span><span style="color:#710">"</span></span> }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<a name='%D0%A1%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B9%20%E2%80%9C%D0%BD%D0%B0%20%D0%BB%D0%B5%D1%82%D1%83%E2%80%9D'></a>
<h3>Создание приложений “на лету”</h3>

<p>Иногда требуется создавать Sinatra приложения “на лету” (например, из другого
приложения). Это возможно с помощью <code>Sinatra.new</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>
my_app = <span style="color:#036;font-weight:bold">Sinatra</span>.new { get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">hi</span><span style="color:#710">"</span></span> } }
my_app.run!
</pre></div>
</div>
</div>

<p>Этот метод может принимать аргументом приложение, от которого следует
наследоваться:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#777"># config.ru</span>
require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

controller = <span style="color:#036;font-weight:bold">Sinatra</span>.new <span style="color:#080;font-weight:bold">do</span>
  enable <span style="color:#A60">:logging</span>
  helpers <span style="color:#036;font-weight:bold">MyHelpers</span>
<span style="color:#080;font-weight:bold">end</span>

map(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/a</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
  run <span style="color:#036;font-weight:bold">Sinatra</span>.new(controller) { get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">a</span><span style="color:#710">'</span></span> } }
<span style="color:#080;font-weight:bold">end</span>

map(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/b</span><span style="color:#710">'</span></span>) <span style="color:#080;font-weight:bold">do</span>
  run <span style="color:#036;font-weight:bold">Sinatra</span>.new(controller) { get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">b</span><span style="color:#710">'</span></span> } }
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>Это особенно полезно для тестирования расширений Sinatra и при использовании
Sinatra внутри вашей библиотеки.</p>

<p>Благодаря этому, использовать Sinatra как “прослойку” очень просто:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>require <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra/base</span><span style="color:#710">'</span></span>

use <span style="color:#036;font-weight:bold">Sinatra</span> <span style="color:#080;font-weight:bold">do</span>
  get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/</span><span style="color:#710">'</span></span>) { ... }
<span style="color:#080;font-weight:bold">end</span>

run <span style="color:#036;font-weight:bold">RailsProject</span>::<span style="color:#036;font-weight:bold">Application</span>
</pre></div>
</div>
</div>

<a name='%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D0%B8%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%B8%20%D0%BF%D1%80%D0%B8%D0%B2%D1%8F%D0%B7%D0%BA%D0%B0'></a>
<h2>Области видимости и привязка</h2>

<p>Текущая область видимости определяет методы и переменные, доступные в данный
момент.</p>

<a name='%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F%20/%20%D0%BA%D0%BB%D0%B0%D1%81%D1%81%D0%B0'></a>
<h3>Область видимости приложения / класса</h3>

<p>Любое Sinatra приложение соответствует подклассу <code>Sinatra::Base</code>. Если вы
используете DSL верхнего уровня (<code>require 'sinatra'</code>), то этим классом будет
<code>Sinatra::Application</code>, иначе это будет подкласс, который вы создали вручную.
На уровне класса вам будут доступны такие методы, как <code>get</code> или <code>before</code>, но
вы не сможете получить доступ к объектам <code>request</code> или <code>session</code>, так как
существует только один класс приложения для всех запросов.</p>

<p>Опции, созданные с помощью <code>set</code>, являются методами уровня класса:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># Я в области видимости приложения!</span>
  set <span style="color:#A60">:foo</span>, <span style="color:#00D">42</span>
  foo <span style="color:#777"># =&gt; 42</span>

  get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/foo</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#777"># Я больше не в области видимости приложения!</span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>У вас будет область видимости приложения внутри:</p>

<ul>
<li>тела вашего класса приложения;</li>
  <li>методов, определенных расширениями;</li>
  <li>блока, переданного в <code>helpers</code>;</li>
  <li>блоков, использованных как значения для <code>set</code>;</li>
  <li>блока, переданного в <code>Sinatra.new</code>.</li>
</ul>
<p>Вы можете получить доступ к объекту области видимости (классу приложения)
следующими способами:</p>

<ul>
<li>через объект, переданный блокам конфигурации (<code>configure { |c| ... }</code>);</li>
  <li>
<code>settings</code> внутри области видимости запроса.</li>
</ul>
<a name='%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D0%B0/%D1%8D%D0%BA%D0%B7%D0%B5%D0%BC%D0%BF%D0%BB%D1%8F%D1%80%D0%B0'></a>
<h3>Область видимости запроса/экземпляра</h3>

<p>Для каждого входящего запроса будет создан новый экземпляр вашего приложения,
и все блоки обработчика будут запущены в этом контексте. В этой области
видимости вам доступны <code>request</code> и <code>session</code> объекты, вызовы методов
рендеринга, такие как <code>erb</code> или <code>haml</code>. Вы можете получить доступ к области
видимости приложения из контекста запроса, используя метод-помощник
<code>settings</code>:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre><span style="color:#080;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MyApp</span> &lt; <span style="color:#036;font-weight:bold">Sinatra</span>::<span style="color:#036;font-weight:bold">Base</span>
  <span style="color:#777"># Я в области видимости приложения!</span>
  get <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">/define_route/:name</span><span style="color:#710">'</span></span> <span style="color:#080;font-weight:bold">do</span>
    <span style="color:#777"># Область видимости запроса '/define_route/:name'</span>
    <span style="color:#33B">@value</span> = <span style="color:#00D">42</span>

    settings.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">/</span><span style="background-color:hsla(0,0%,0%,0.07);color:black"><span style="font-weight:bold;color:#666">#{</span>params[<span style="color:#A60">:name</span>]<span style="font-weight:bold;color:#666">}</span></span><span style="color:#710">"</span></span>) <span style="color:#080;font-weight:bold">do</span>
      <span style="color:#777"># Область видимости запроса "/#{params[:name]}"</span>
      <span style="color:#33B">@value</span> <span style="color:#777"># =&gt; nil (другой запрос)</span>
    <span style="color:#080;font-weight:bold">end</span>

    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">Route defined!</span><span style="color:#710">"</span></span>
  <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>
</pre></div>
</div>
</div>

<p>У вас будет область видимости запроса в:</p>

<ul>
<li>get/head/post/put/delete/options блоках;</li>
  <li>before/after фильтрах;</li>
  <li>методах-помощниках;</li>
  <li>шаблонах/отображениях.</li>
</ul>
<a name='%D0%9E%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%8C%20%D0%B2%D0%B8%D0%B4%D0%B8%D0%BC%D0%BE%D1%81%D1%82%D0%B8%20%D0%B4%D0%B5%D0%BB%D0%B5%D0%B3%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F'></a>
<h3>Область видимости делегирования</h3>

<p>Область видимости делегирования просто перенаправляет методы в область
видимости класса. Однако, она не полностью ведет себя как область видимости
класса, так как у вас нет привязки к классу. Только методы, явно помеченные
для делегирования, будут доступны, а переменных/состояний области видимости
класса не будет (иначе говоря, у вас будет другой <code>self</code> объект). Вы можете
непосредственно добавить методы делегирования, используя
<code>Sinatra::Delegator.delegate :method_name</code>.</p>

<p>У вас будет контекст делегирования внутри:</p>

<ul>
<li>привязки верхнего уровня, если вы сделали <code>require 'sinatra'</code>;</li>
  <li>объекта, расширенного с помощью <code>Sinatra::Delegator</code>.</li>
</ul>
<p>Посмотрите сами в код: вот
<a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/base.rb#L1609-1633">примесь Sinatra::Delegator</a>
<a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/main.rb#L28-30">расширяет главный объект</a>.</p>

<a name='%D0%9A%D0%BE%D0%BC%D0%B0%D0%BD%D0%B4%D0%BD%D0%B0%D1%8F%20%D1%81%D1%82%D1%80%D0%BE%D0%BA%D0%B0'></a>
<h2>Командная строка</h2>

<p>Sinatra приложения могут быть запущены напрямую:</p>

<pre><code>ruby myapp.rb [-h] [-x] [-e ENVIRONMENT] [-p PORT] [-o HOST] [-s HANDLER]
</code></pre>

<p>Опции включают:</p>

<pre><code>-h # раздел помощи
-p # указание порта (по умолчанию 4567)
-o # указание хоста (по умолчанию 0.0.0.0)
-e # указание окружения, режима (по умолчанию development)
-s # указание rack сервера/обработчика (по умолчанию thin)
-x # включить мьютекс-блокировку (по умолчанию выключена)
</code></pre>

<a name='%D0%A1%D0%B8%D1%81%D1%82%D0%B5%D0%BC%D0%BD%D1%8B%D0%B5%20%D1%82%D1%80%D0%B5%D0%B1%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F'></a>
<h2>Системные требования</h2>

<p>Следующие версии Ruby официально поддерживаются:</p>

<dl>
<dt>Ruby 1.8.7</dt>
  <dd>1.8.7 полностью поддерживается, тем не менее, если вас ничто не держит на
    этой версии, рекомендуем обновиться до 1.9.2 или перейти на JRuby или
    Rubinius. Поддержка 1.8.7 не будет прекращена до выхода Sinatra 2.0 и Ruby
    2.0, разве что в случае релиза 1.8.8 (что маловероятно). Но даже тогда,
    возможно, поддержка не будет прекращена. <b>Ruby 1.8.6 больше не
    поддерживается.</b> Если вы хотите использовать 1.8.6, откатитесь до Sinatra
    1.2, которая будет получать все исправления ошибок до тех пор, пока не
    будет выпущена Sinatra 1.4.0.</dd>

  <dt>Ruby 1.9.2</dt>
  <dd>1.9.2 полностью поддерживается и рекомендована к использованию.
    Не используйте 1.9.2p0,
    известно, что эта версия очень нестабильна при использовании Sinatra. Эта
    версия будет поддерживаться по крайней мере до выхода Ruby 1.9.4/2.0, а
    поддержка последней версии 1.9 будет осуществляться до тех пор, пока она
    поддерживается командой разработчиков Ruby.</dd>

  <dt>Ruby 1.9.3</dt>
  <dd>1.9.3 полностью поддерживается. Заметьте, что переход на 1.9.3 с
    ранних версий сделает недействительными все сессии.</dd>

  <dt>Rubinius</dt>
  <dd>Rubinius официально поддерживается (Rubinius &gt;= 1.2.4), всё, включая все
  языки шаблонов, работает. Предстоящий релиз 2.0 также поддерживается.</dd>

  <dt>JRuby</dt>
  <dd>JRuby официально поддерживается (JRuby &gt;= 1.6.5). Нет никаких проблем с
  использованием альтернативных шаблонов. Тем не менее, если вы выбираете
  JRuby, то, пожалуйста, посмотрите на JRuby Rack-серверы, так как Thin не
  поддерживается полностью на JRuby. Поддержка расширений на C в JRuby все
  еще экспериментальная, что на данный момент затрагивает только RDiscount,
  Redcarpet и RedCloth.</dd>
</dl>
<p>Мы также следим за предстоящими к выходу версиями Ruby.</p>

<p>Следующие реализации Ruby не поддерживаются официально, но известно, что на
них запускается Sinatra:</p>

<ul>
<li>старые версии JRuby и Rubinius;</li>
  <li>Ruby Enterprise Edition;</li>
  <li>MacRuby, Maglev, IronRuby;</li>
  <li>Ruby 1.9.0 и 1.9.1 (настоятельно не рекомендуются к использованию).</li>
</ul>
<p>То, что версия официально не поддерживается, означает, что, если что-то не
работает на этой версии, а на поддерживаемой работает — это не наша проблема,
а их.</p>

<p>Мы также запускаем наши CI-тесты на версии Ruby, находящейся в разработке
(предстоящей 2.0.0), и на 1.9.4, но мы не можем ничего гарантировать, так как
они находятся в разработке. Предполагается, что 1.9.4p0 и 2.0.0p0 будут
поддерживаться.</p>

<p>Sinatra должна работать на любой операционной системе, в которой есть одна из
указанных выше версий Ruby.</p>

<p>Пока невозможно запустить Sinatra на Cardinal, SmallRuby, BlueRuby и на любой
версии Ruby до 1.8.7.</p>

<a name='%D0%9D%D0%B0%20%D0%BE%D1%81%D1%82%D1%80%D0%B8%D0%B5'></a>
<h2>На острие</h2>

<p>Если вы хотите использовать самый последний код Sinatra, не бойтесь запускать
свое приложение вместе с кодом из master ветки Sinatra, она весьма стабильна.</p>

<p>Мы также время от времени выпускаем предварительные версии, так что вы можете
делать так:</p>

<pre><code>gem install sinatra --pre
</code></pre>

<p>Чтобы воспользоваться некоторыми самыми последними возможностями.</p>

<a name='%D0%A1%20%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E%20Bundler'></a>
<h3>С помощью Bundler</h3>

<p>Если вы хотите запускать свое приложение с последней версией Sinatra, то
рекомендуем использовать <a href="http://gembundler.com/">Bundler</a>.</p>

<p>Сначала установите Bundler, если у вас его еще нет:</p>

<pre><code>gem install bundler
</code></pre>

<p>Затем создайте файл <code>Gemfile</code> в директории вашего проекта:</p>

<div>
<div class="CodeRay">
  <div class="code"><pre>source <span style="color:#A60">:rubygems</span>
gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">sinatra</span><span style="color:#710">'</span></span>, <span style="color:#A60">:git</span> =&gt; <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">"</span><span style="color:#D20">git://github.com/sinatra/sinatra.git</span><span style="color:#710">"</span></span>

<span style="color:#777"># другие зависимости</span>
gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">haml</span><span style="color:#710">'</span></span>                    <span style="color:#777"># например, если используете haml</span>
gem <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">activerecord</span><span style="color:#710">'</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">~&gt; 3.0</span><span style="color:#710">'</span></span>  <span style="color:#777"># может быть, вам нужен и ActiveRecord 3.x</span>
</pre></div>
</div>
</div>

<p>Обратите внимание, вам нужно будет указывать все зависимости вашего приложения
в этом файле. Однако, непосредственные зависимости Sinatra (Rack и Tilt)
Bundler автоматически скачает и добавит.</p>

<p>Теперь вы можете запускать свое приложение так:</p>

<pre><code>bundle exec ruby myapp.rb
</code></pre>

<a name='%D0%92%D1%80%D1%83%D1%87%D0%BD%D1%83%D1%8E'></a>
<h3>Вручную</h3>

<p>Создайте локальный клон репозитория и запускайте свое приложение с
<code>sinatra/lib</code> директорией в <code>$LOAD_PATH</code>:</p>

<pre><code>cd myapp
git clone git://github.com/sinatra/sinatra.git
ruby -Isinatra/lib myapp.rb
</code></pre>

<p>Чтобы обновить исходники Sinatra:</p>

<pre><code>cd myapp/sinatra
git pull
</code></pre>

<a name='%D0%A3%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0%20%D0%B3%D0%BB%D0%BE%D0%B1%D0%B0%D0%BB%D1%8C%D0%BD%D0%BE'></a>
<h3>Установка глобально</h3>

<p>Вы можете самостоятельно собрать gem:</p>

<pre><code>git clone git://github.com/sinatra/sinatra.git
cd sinatra
rake sinatra.gemspec
rake install
</code></pre>

<p>Если вы устанавливаете пакеты (gem) от пользователя root, то вашим последним
шагом должна быть команда</p>

<pre><code>sudo rake install
</code></pre>

<a name='%D0%92%D0%B5%D1%80%D1%81%D0%B8%D0%B8'></a>
<h2>Версии</h2>

<p>Sinatra использует <a href="http://semver.org/">Semantic Versioning</a>, SemVer и
SemVerTag.</p>

<a name='%D0%94%D0%B0%D0%BB%D1%8C%D0%BD%D0%B5%D0%B9%D1%88%D0%B5%D0%B5%20%D1%87%D1%82%D0%B5%D0%BD%D0%B8%D0%B5'></a>
<h2>Дальнейшее чтение</h2>

<ul>
<li>
<a href="http://www.sinatrarb.com/">Веб-сайт проекта</a> — Дополнительная
документация, новости и ссылки на другие ресурсы.</li>
  <li>
<a href="http://www.sinatrarb.com/contributing">Участие в проекте</a> — Обнаружили
баг? Нужна помощь? Написали патч?</li>
  <li><a href="http://github.com/sinatra/sinatra/issues">Слежение за проблемами/ошибками</a></li>
  <li><a href="http://twitter.com/sinatra">Twitter</a></li>
  <li><a href="http://groups.google.com/group/sinatrarb/topics">Группы рассылки</a></li>
  <li>
<a href="irc://chat.freenode.net/#sinatra">#sinatra</a> на http://freenode.net</li>
  <li>
<a href="http://sinatra-book.gittr.com">Sinatra Book</a> учебник и сборник рецептов</li>
  <li>
<a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> сборник рецептов</li>
  <li>API документация к <a href="http://rubydoc.info/gems/sinatra">последнему релизу</a>
или <a href="http://rubydoc.info/github/sinatra/sinatra">текущему HEAD</a> на
http://rubydoc.info</li>
  <li><a href="http://travis-ci.org/sinatra/sinatra">Сервер непрерывной интеграции</a></li>
</ul>
</body></html>
